/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var nt=Object.defineProperty;var pn=Object.getOwnPropertyDescriptor;var hn=Object.getOwnPropertyNames;var mn=Object.prototype.hasOwnProperty;var fn=(o,e)=>{for(var t in e)nt(o,t,{get:e[t],enumerable:!0})},gn=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of hn(e))!mn.call(o,i)&&i!==t&&nt(o,i,{get:()=>e[i],enumerable:!(n=pn(e,i))||n.enumerable});return o};var yn=o=>gn(nt({},"__esModule",{value:!0}),o);var Zn={};fn(Zn,{default:()=>et});module.exports=yn(Zn);var L=require("obsidian");var bt={enableLogging:!1,enableInLivePreview:!0,enableInPreview:!0,enableInSidePanels:!0,enableStrictMode:!1,enableLineItems:!1,suppressMobileKeyboard:!0,properties:[{id:"status",label:"Status",key:"status",type:"selector",options:["open","working","blocked","wont-do","complete"],icon:"check-circle",showInCollapsed:!0},{id:"priority",label:"Priority",key:"priority",type:"selector",options:["high","medium","normal","low"],icon:"flag",showInCollapsed:!0},{id:"tags",label:"Tags",key:"tags",type:"list",icon:"tag",showInCollapsed:!0},{id:"recurrence",label:"Recurrence",key:"recurrence",type:"recurrence",icon:"repeat",showInCollapsed:!0},{id:"scheduled",label:"Scheduled",key:"scheduled",type:"datetime",icon:"calendar",showInCollapsed:!0},{id:"type",label:"Type",key:"type",type:"folder",icon:"folder",showInCollapsed:!1}],enableRecurrence:!0,promptOnRecurrenceEdit:!0,recurrencePromptTimeout:5,recurrenceCompletionStatuses:["complete","wont-do"],recurrenceDefaultStatus:"open",enableAutoRename:!0,autoSaveFolderPath:!0,folderExclusions:"",checkOpenChecklistItems:!0,enableViewModeSwitching:!0,viewModeFrontmatterKey:"viewmode",viewModeIgnoredFolders:"",viewModeRules:[],systemCommands:["open-in-new-tab","duplicate","get-relative-path"],snoozeOptions:[],enableShiftClickCancel:!1},vt=[{id:"open-in-new-tab",label:"Open in New Tab",icon:"plus-square"},{id:"open-in-same-tab",label:"Open in Same Tab",icon:"file"},{id:"duplicate",label:"Duplicate File",icon:"copy"},{id:"get-relative-path",label:"Copy Relative Path",icon:"link"}],rt=["open","working","blocked","wont-do","complete"],it=["high","medium","normal","low"],wt=[{label:"Daily",value:"RRULE:FREQ=DAILY"},{label:"Weekdays",value:"RRULE:FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR"},{label:"Weekly",value:"RRULE:FREQ=WEEKLY"},{label:"Monthly",value:"RRULE:FREQ=MONTHLY"}],xt=`
      .tps-global-context-menu {
        position: fixed;
        min-width: 220px;
        background-color: var(--background-secondary);
        color: var(--text-normal);
        border: 1px solid var(--background-modifier-border);
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        z-index: 9999;
        padding: 6px 0;
        font-size: 14px;
        backdrop-filter: blur(6px);
        animation: tps-context-fade 120ms ease-out;
      }
      @keyframes tps-context-fade {
        from { opacity: 0; transform: translateY(4px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }
      .tps-global-context-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        width: 100%;
        border: none;
        background: transparent;
        padding: 6px 14px;
        text-align: left;
        cursor: pointer;
        color: inherit;
      }
      .tps-global-context-item:hover,
      .tps-global-context-item:focus {
        background-color: var(--background-modifier-hover);
        outline: none;
      }
      .tps-global-context-item-label {
        font-weight: 500;
      }
      .tps-global-context-item-desc {
        font-size: 12px;
        color: var(--text-muted);
      }
      .tps-global-context-header {
        padding: 4px 14px 8px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-faint);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .tps-gcm-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }
      .tps-gcm-file-title {
        font-weight: 600;
        color: var(--text-normal);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 11px; /* Match header size but bold/color makes it pop */
      }
      .tps-gcm-header-right {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
      }
      .tps-gcm-panel {
        padding: 8px 14px 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .tps-gcm-multi-banner {
        font-size: 12px;
        color: var(--text-muted);
        background: var(--background-modifier-hover);
        padding: 4px 8px;
        border-radius: 6px;
      }
      .tps-gcm-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .tps-gcm-row label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .tps-gcm-input-wrapper {
        position: relative;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      .tps-gcm-viewmode-rule {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .tps-gcm-viewmode-rule .setting-item {
        margin: 0;
        flex: 1 1 160px;
        min-width: 140px;
      }
      .tps-gcm-viewmode-rule span {
        white-space: nowrap;
      }
      .tps-gcm-row select,
      .tps-gcm-row input[type="text"],
      .tps-gcm-row input[type="datetime-local"],
      .tps-gcm-row input[type="date"] {
        width: 100%;
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-primary);
        color: var(--text-normal);
        padding: 4px 8px;
      }
      .tps-global-context-menu--persistent {
        margin-bottom: 12px;
      }
      /* Reading view: full-size panel at the top of the note body.
         It scrolls away with the content (no sticky behavior). 
         Removed card styling to fit readable line length. */
      .tps-global-context-menu--reading {
        position: static;
        top: auto;
        z-index: auto;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin-bottom: 1em;
      }
      
      /* Indent the panel content in reading mode to differentiate it slightly */
      .tps-global-context-menu--reading .tps-gcm-panel {
        padding: 8px 0 !important;
        margin-left: 4px;
        border-left: 2px solid var(--background-modifier-border);
        padding-left: 12px !important;
      }
      /* Live preview: compact toolbar fixed at the bottom of the viewport.
         Uses fixed positioning to avoid affecting readable line length. */
      .tps-global-context-menu--live {
        position: fixed;
        bottom: 20px;
        left: 0;
        right: 0;
        margin-left: auto;
        margin-right: auto;
        z-index: 100;
        padding: 8px 12px;
        width: min(100%, var(--file-line-width, 700px));
        max-width: var(--file-line-width, 700px);
        max-height: calc(100vh - 32px);
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        pointer-events: auto;
        --tps-gcm-scale: 1;
        transform: none;
        transform-origin: center bottom;
        box-sizing: border-box;
      }

      .tps-global-context-menu--live .tps-gcm-panel {
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        scrollbar-width: thin;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-auto-flow: row dense;
        column-gap: 10px;
        row-gap: 10px;
      }

      .tps-global-context-menu--live .tps-gcm-title-row,
      .tps-global-context-menu--live .tps-gcm-tags-row,
      .tps-global-context-menu--live .tps-gcm-actions-row,
      .tps-global-context-menu--live .tps-gcm-file-ops-row,
      .tps-global-context-menu--live .tps-gcm-multi-banner {
        grid-column: 1 / -1;
      }
      .tps-gcm-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .tps-gcm-toolbar .tps-gcm-row {
        margin: 0;
        padding: 0;
      }
      .tps-gcm-toolbar .tps-gcm-row > label {
        display: none;
      }
      .tps-gcm-toolbar select,
      .tps-gcm-toolbar input,
      .tps-gcm-toolbar .tps-gcm-actions-row button {
        font-size: 11px;
        padding: 2px 6px;
      }
      .tps-gcm-toolbar .tps-gcm-actions-row {
        gap: 4px;
      }
      .tps-global-context-menu--persistent.tps-global-context-menu--reading {
        position: static !important;
        top: auto !important;
        bottom: auto !important;
        left: auto !important;
        right: auto !important;
        transform: none !important;
      }
      .tps-context-hidden-for-keyboard .tps-global-context-menu {
        opacity: 0;
        pointer-events: none;
      }

      /* Hide persistent inline menus when keyboard is visible on mobile */
      /* Use visibility instead of display:none to prevent layout thrashing and flicker */
      .tps-context-hidden-for-keyboard .tps-global-context-menu--persistent {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease, visibility 0.15s ease;
      }
      
      /* Add transition for smoother show/hide */
      .tps-global-context-menu--persistent {
        transition: opacity 0.15s ease, visibility 0.15s ease;
      }
      .tps-gcm-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      /* Inline tags container */
      .tps-gcm-tags-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
      }
      
      .tps-gcm-tag {
        background: var(--background-modifier-hover);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        line-height: 1.2;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--text-muted);
      }
      
      .tps-gcm-tag-removable {
        padding-right: 3px;
      }
      
      .tps-gcm-tag-text {
        display: inline;
      }
      
      .tps-gcm-tag-remove {
        border: none;
        background: transparent;
        color: inherit;
        opacity: 0.6;
        cursor: pointer;
        font-size: 14px;
        padding: 0 2px;
        line-height: 1;
        font-weight: normal;
        transition: opacity 0.15s ease;
      }
      
      .tps-gcm-tag-remove:hover {
        opacity: 1;
      }
      
      .tps-gcm-tag-add {
        border: 1px dashed var(--text-muted);
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        transition: all 0.15s ease;
      }
      
      .tps-gcm-tag-add:hover {
        border-color: var(--interactive-accent);
        color: var(--interactive-accent);
      }
      
      .tps-gcm-tag button {
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 11px;
        padding: 0;
      }
      
      /* File operations row */
      .tps-gcm-file-ops-row {
        padding-top: 8px;
        border-top: 1px solid var(--background-modifier-border);
        margin-top: 4px;
      }
      
      .tps-gcm-file-ops {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .tps-gcm-file-op-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border: 1px solid var(--background-modifier-border);
        border-radius: 4px;
        background: var(--background-primary);
        color: var(--text-muted);
        cursor: pointer;
        font-size: 11px;
        transition: all 0.15s ease;
      }
      
      .tps-gcm-file-op-btn:hover {
        background: var(--background-modifier-hover);
        color: var(--text-normal);
        border-color: var(--interactive-accent);
      }
      
      .tps-gcm-file-op-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .tps-gcm-file-op-icon svg {
        width: 12px;
        height: 12px;
      }
      
      .tps-gcm-file-op-label {
        white-space: nowrap;
      }
      
      .tps-gcm-panel--hidden {
        display: none;
      }
      .tps-gcm-panel-toggle {
        display: flex;
        justify-content: flex-end;
        padding: 6px 14px 10px;
      }
      .tps-gcm-panel-toggle button {
        font-size: 12px;
        border: none;
        cursor: pointer;
        color: var(--interactive-accent);
        background: transparent;
      }
      .tps-gcm-add-row {
        display: flex;
        gap: 6px;
      }
      .tps-gcm-add-row .tps-gcm-input-wrapper {
        flex: 1;
      }
      .tps-gcm-add-row button {
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-modifier-hover);
        padding: 4px 8px;
        cursor: pointer;
        white-space: nowrap;
      }
      .tps-gcm-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        border: 1px solid var(--background-modifier-border);
        border-radius: 6px;
        background: var(--background-primary);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        max-height: 200px;
        overflow-y: auto;
        z-index: 10000;
      }
      .tps-gcm-dropdown-item {
        padding: 6px 10px;
        cursor: pointer;
      }
      .tps-gcm-dropdown-item:hover {
        background: var(--background-modifier-hover);
      }
      .tps-gcm-input-button {
        width: 100%;
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-primary);
        color: var(--text-normal);
        padding: 6px 8px;
        text-align: left;
        cursor: pointer;
      }
      .tps-gcm-recurrence-modal {
        position: fixed;
        top: 0;
        left: 0;
        transform: none;
        width: min(320px, calc(100vw - 32px));
        background: var(--background-secondary);
        border: 1px solid var(--background-modifier-border);
        border-radius: 10px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 10001;
        max-height: calc(100vh - 32px);
        overflow-y: auto;
      }
      .tps-gcm-recurrence-options {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .tps-gcm-recurrence-options button {
        flex: 1 1 40%;
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-primary);
        color: var(--text-normal);
        padding: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .tps-gcm-recurrence-header {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.1em;
      }
      .tps-gcm-recurrence-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
      }
      .tps-gcm-recurrence-actions button {
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-modifier-hover);
        color: var(--text-normal);
        padding: 6px 12px;
        cursor: pointer;
      }
      .tps-gcm-actions-row {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        margin-top: 4px;
      }
      .tps-gcm-actions-row button {
        flex: 1;
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-modifier-hover);
        color: var(--text-normal);
        padding: 6px 8px;
        cursor: pointer;
      }
      .tps-gcm-actions-row button.tps-gcm-actions-delete {
        color: var(--text-accent);
      }
      .tps-gcm-native-menu-section {
        border-top: 1px solid var(--background-modifier-border);
        padding: 8px 0;
        margin-top: 4px;
      }
      .tps-gcm-section-header {
        padding: 4px 14px 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }
      .tps-gcm-native-items {
        display: flex;
        flex-direction: column;
      }
      .tps-gcm-native-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        border: none;
        background: transparent;
        padding: 6px 14px;
        text-align: left;
        cursor: pointer;
        color: var(--text-normal);
        font-size: 13px;
      }
      .tps-gcm-native-item:hover:not(:disabled),
      .tps-gcm-native-item:focus:not(:disabled) {
        background-color: var(--background-modifier-hover);
        outline: none;
      }
      .tps-gcm-native-item:disabled,
      .tps-gcm-native-item.is-disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .tps-gcm-item-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
      .tps-gcm-item-icon svg {
        width: 16px;
        height: 16px;
      }
      .tps-gcm-separator {
        height: 1px;
        background: var(--background-modifier-border);
        margin: 4px 8px;
      }
      
      /* Collapsed state styles */
      .tps-global-context-menu--collapsed .tps-gcm-panel {
        display: none;
      }
      
      .tps-global-context-menu--persistent .tps-global-context-header {
        cursor: pointer;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        user-select: none;
        gap: 8px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      .tps-global-context-menu--persistent .tps-global-context-header:hover {
        color: var(--text-normal);
      }

      .tps-gcm-header-left {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
      }

      .tps-gcm-header-right {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        flex-wrap: nowrap;
        flex: 1;
        overflow: hidden;
        min-width: 0;
        padding-left: 2px;
      }
      
      .tps-gcm-header-right::-webkit-scrollbar {
        display: none;
      }

      .tps-gcm-header-title {
        font-weight: 600;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
      }

      .tps-gcm-collapse-button {
        min-width: 28px;
        min-height: 28px;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-primary);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        padding: 0;
        flex-shrink: 0;
        position: relative;
        z-index: 10;
        transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        image-rendering: -webkit-optimize-contrast;
        -webkit-font-smoothing: antialiased;
      }

      .tps-gcm-collapse-button:hover {
        background: var(--background-modifier-hover);
        color: var(--text-normal);
        border-color: var(--interactive-accent);
      }

      .tps-gcm-collapse-button:active {
        background: var(--background-modifier-active-hover);
      }

      .tps-gcm-collapse-button::before {
        content: '';
        width: 10px;
        height: 10px;
        border-left: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(-45deg);
        transition: transform 0.2s ease;
        image-rendering: crisp-edges;
      }

      .tps-gcm-collapse-button[aria-expanded='true']::before {
        transform: rotate(135deg);
      }

      .tps-gcm-collapse-button:focus-visible {
        outline: 2px solid var(--interactive-accent);
        outline-offset: 2px;
      }

      .tps-global-context-menu--collapsed.tps-global-context-menu--live {
        width: fit-content;
        display: block;
        min-width: 0;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        padding: 4px 8px !important;
      }

      .tps-global-context-menu--collapsed.tps-global-context-menu--live .tps-global-context-header {
        justify-content: flex-start;
        padding: 0;
        gap: 8px;
      }
      
      .tps-gcm-nav-group {
        display: flex;
        align-items: center;
        gap: 2px;
      }

      .tps-gcm-nav-button {
        min-width: 24px;
        min-height: 24px;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        padding: 0;
        flex-shrink: 0;
        transition: color 0.15s ease, background-color 0.15s ease;
      }

      .tps-gcm-nav-button:hover {
        color: var(--text-normal);
        background: var(--background-modifier-hover);
      }
      
      .tps-gcm-nav-button svg {
        width: 14px;
        height: 14px;
      }

      /* Hide navigation buttons on very small screens or when constrained */
      @media (max-width: 400px) {
        .tps-gcm-nav-group {
          display: none;
        }
      }

      .tps-global-context-menu--collapsed.tps-global-context-menu--live .tps-gcm-header-right {
        margin-right: 0;
        flex: 0 0 auto;
      }
      
      /* Hide title text when collapsed, but keep the collapse button */
      .tps-global-context-menu--collapsed .tps-gcm-file-title {
        display: none;
      }

      /* Fix overlap: Ensure left section (button only) takes natural width in collapsed mode */
      .tps-global-context-menu--collapsed .tps-gcm-header-left {
        flex: 0 0 auto !important;
      }

      .tps-global-context-menu--collapsed .tps-gcm-collapse-button {
        min-width: 40px;
        min-height: 40px;
        width: 40px;
        height: 40px;
      }

      .tps-global-context-menu--collapsed .tps-gcm-nav-button {
        min-width: 32px;
        min-height: 32px;
        width: 32px;
        height: 32px;
      }
      
      /* Recurrence preview section */
      .tps-gcm-recurrence-preview {
        margin-top: 12px;
        padding: 8px;
        background: var(--background-primary);
        border-radius: 6px;
        border: 1px solid var(--background-modifier-border);
      }
      
      .tps-gcm-recurrence-preview-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 6px;
      }
      
      .tps-gcm-recurrence-preview-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .tps-gcm-recurrence-preview-item {
        font-size: 12px;
        color: var(--text-normal);
        padding: 2px 0;
      }
      

      .tps-gcm-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--background-modifier-hover);
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        line-height: 1.3;
        white-space: nowrap;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        letter-spacing: 0.02em;
      }
      
      .tps-gcm-badge:hover {
        background: var(--interactive-accent);
        color: var(--text-on-accent);
      }

      .tps-gcm-badge-add-tag {
        background: var(--interactive-accent) !important;
        color: var(--text-on-accent) !important;
        border: none !important;
        font-size: 11px;
        font-weight: 700;
        min-width: 18px;
        text-align: center;
      }

      .tps-gcm-badge-add-tag:hover {
        background: var(--interactive-accent-hover) !important;
        transform: scale(1.05);
      }

      .tps-gcm-badge-add-tag:active {
        transform: scale(0.95);
      }

      /* Seamless integration for Reading Mode Collapsed State */
      .tps-global-context-menu--reading.tps-global-context-menu--collapsed {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        padding: 0 !important;
        margin-bottom: 12px !important;
        min-width: 0 !important;
        width: 100% !important;
      }

      .tps-global-context-menu--reading.tps-global-context-menu--collapsed .tps-global-context-header {
        padding: 0 !important;
        color: var(--text-muted) !important;
        font-size: 0.9em !important;
        justify-content: flex-start !important; /* Align badges to left */
        gap: 8px;
      }

      /* Reset the right container to flow naturally */
      .tps-global-context-menu--reading.tps-global-context-menu--collapsed .tps-gcm-header-right {
        margin-right: 0 !important;
      }

      /* Prevent spreading in Reading Mode */
      .tps-global-context-menu--reading.tps-global-context-menu--collapsed .tps-gcm-header-left {
        flex: 0 0 auto !important;
      }

      /* ===== MOBILE-SPECIFIC COMPACT STYLING ===== */
      /* Keyboard hiding - use display: none for reliable hiding */
      .tps-context-hidden-for-keyboard .tps-global-context-menu--persistent {
        display: none !important;
      }

    `;var S=require("obsidian");var be=require("obsidian"),Pe=class extends be.Modal{constructor(t,n,i){super(t);this.tag="";this.allTags=n,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Add tag"}),new be.Setting(t).setName("Tag").addText(n=>{n.setPlaceholder("Tag name..."),n.inputEl.addEventListener("keydown",i=>{i.stopPropagation(),i.key==="Enter"&&(this.close(),this.onSubmit(this.tag))}),n.onChange(i=>{this.tag=i}),setTimeout(()=>n.inputEl.focus(),50)}),new be.Setting(t).addButton(n=>{n.setButtonText("Add").setCta().onClick(()=>{this.close(),this.onSubmit(this.tag)})})}onClose(){let{contentEl:t}=this;t.empty()}};var Le=require("obsidian");var ve=["MO","TU","WE","TH","FR","SA","SU"],R=(function(){function o(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return o.fromStr=function(e){return new o(ve.indexOf(e))},o.prototype.nth=function(e){return this.n===e?this:new o(this.weekday,e)},o.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},o.prototype.toString=function(){var e=ve[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},o.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},o})();var M=function(o){return o!=null},U=function(o){return typeof o=="number"},at=function(o){return typeof o=="string"&&ve.includes(o)},A=Array.isArray,z=function(o,e){e===void 0&&(e=o),arguments.length===1&&(e=o,o=0);for(var t=[],n=o;n<e;n++)t.push(n);return t};var x=function(o,e){var t=0,n=[];if(A(o))for(;t<e;t++)n[t]=[].concat(o);else for(;t<e;t++)n[t]=o;return n},Tt=function(o){return A(o)?o:[o]};function re(o,e,t){t===void 0&&(t=" ");var n=String(o);return e=e>>0,n.length>e?String(n):(e=e-n.length,e>t.length&&(t+=x(t,e/t.length)),t.slice(0,e)+String(n))}var kt=function(o,e,t){var n=o.split(e);return t?n.slice(0,t).concat([n.slice(t).join(e)]):n},N=function(o,e){var t=o%e;return t*e<0?t+e:t},Re=function(o,e){return{div:Math.floor(o/e),mod:N(o,e)}},$=function(o){return!M(o)||o.length===0},D=function(o){return!$(o)},T=function(o,e){return D(o)&&o.indexOf(e)!==-1};var B=function(o,e,t,n,i,r){return n===void 0&&(n=0),i===void 0&&(i=0),r===void 0&&(r=0),new Date(Date.UTC(o,e-1,t,n,i,r))},bn=[31,28,31,30,31,30,31,31,30,31,30,31],St=1e3*60*60*24,Fe=9999,Ct=B(1970,1,1),vn=[6,0,1,2,3,4,5];var pe=function(o){return o%4===0&&o%100!==0||o%400===0},ot=function(o){return o instanceof Date},ie=function(o){return ot(o)&&!isNaN(o.getTime())};var wn=function(o,e){var t=o.getTime(),n=e.getTime(),i=t-n;return Math.round(i/St)},we=function(o){return wn(o,Ct)},Ae=function(o){return new Date(Ct.getTime()+o*St)},xn=function(o){var e=o.getUTCMonth();return e===1&&pe(o.getUTCFullYear())?29:bn[e]},K=function(o){return vn[o.getUTCDay()]},st=function(o,e){var t=B(o,e+1,1);return[K(t),xn(t)]},Oe=function(o,e){return e=e||o,new Date(Date.UTC(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Ie=function(o){var e=new Date(o.getTime());return e},lt=function(o){for(var e=[],t=0;t<o.length;t++)e.push(Ie(o[t]));return e},q=function(o){o.sort(function(e,t){return e.getTime()-t.getTime()})},he=function(o,e){e===void 0&&(e=!0);var t=new Date(o);return[re(t.getUTCFullYear().toString(),4,"0"),re(t.getUTCMonth()+1,2,"0"),re(t.getUTCDate(),2,"0"),"T",re(t.getUTCHours(),2,"0"),re(t.getUTCMinutes(),2,"0"),re(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},xe=function(o){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(o);if(!t)throw new Error("Invalid UNTIL value: ".concat(o));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},Et=function(o,e){var t=o.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},Mt=function(o,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,n=new Date(Et(o,t)),i=new Date(Et(o,e!=null?e:"UTC")),r=i.getTime()-n.getTime();return new Date(o.getTime()-r)};var Tn=(function(){function o(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return o.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,n=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(n)return!1}else if(this.method==="before"){if(n)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},o.prototype.add=function(e){return this._result.push(e),!0},o.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;default:return e.length?e[e.length-1]:null}},o.prototype.clone=function(){return new o(this.method,this.args)},o})(),Z=Tn;var ct=function(o,e){return ct=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])},ct(o,e)};function me(o,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ct(o,e);function t(){this.constructor=o}o.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var O=function(){return O=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},O.apply(this,arguments)};function f(o,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,r;n<i;n++)(r||!(n in e))&&(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return o.concat(r||Array.prototype.slice.call(e))}var kn=(function(o){me(e,o);function e(t,n,i){var r=o.call(this,t,n)||this;return r.iterator=i,r}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e})(Z),ut=kn;var En={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},ae=En;var Lt=function(o,e){return o.indexOf(e)!==-1},Sn=function(o){return o.toString()},Cn=function(o,e,t){return"".concat(e," ").concat(t,", ").concat(o)},Mn=(function(){function o(e,t,n,i){if(t===void 0&&(t=Sn),n===void 0&&(n=ae),i===void 0&&(i=Cn),this.text=[],this.language=n||ae,this.gettext=t,this.dateFormatter=i,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var r=[].concat(this.options.bymonthday),a=[].concat(this.options.bynmonthday);r.sort(function(u,d){return u-d}),a.sort(function(u,d){return d-u}),this.bymonthday=r.concat(a),this.bymonthday.length||(this.bymonthday=null)}if(M(this.origOptions.byweekday)){var s=A(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],l=String(s);this.byweekday={allWeeks:s.filter(function(u){return!u.n}),someWeeks:s.filter(function(u){return!!u.n}),isWeekdays:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")===-1&&l.indexOf("SU")===-1,isEveryDay:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")!==-1&&l.indexOf("SU")!==-1};var p=function(u,d){return u.weekday-d.weekday};this.byweekday.allWeeks.sort(p),this.byweekday.someWeeks.sort(p),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return o.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in o.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var n in e.origOptions){if(Lt(["dtstart","tzid","wkst","freq"],n))return!0;if(!Lt(o.IMPLEMENTED[e.options.freq],n))return!1}return t},o.prototype.isFullyConvertible=function(){return o.isFullyConvertible(this.rrule)},o.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in o.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[b.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},o.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},o.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},o.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},o.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},o.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},o.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},o.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},o.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},o.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},o.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},o.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,n=this.gettext;if(e===-1)return n("last");var i=Math.abs(e);switch(i){case 1:case 21:case 31:t=i+n("st");break;case 2:case 22:t=i+n("nd");break;case 3:case 23:t=i+n("rd");break;default:t=i+n("th")}return e<0?t+" "+n("last"):t},o.prototype.monthtext=function(e){return this.language.monthNames[e-1]},o.prototype.weekdaytext=function(e){var t=U(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},o.prototype.plural=function(e){return e%100!==1},o.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},o.prototype.list=function(e,t,n,i){var r=this;i===void 0&&(i=","),A(e)||(e=[e]);var a=function(l,p,u){for(var d="",c=0;c<l.length;c++)c!==0&&(c===l.length-1?d+=" "+u+" ":d+=p+" "),d+=l[c];return d};t=t||function(l){return l.toString()};var s=function(l){return t&&t.call(r,l)};return n?a(e.map(s),i,n):e.map(s).join(i+" ")},o})(),V=Mn;var Ln=(function(){function o(e){this.done=!0,this.rules=e}return o.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},o.prototype.isDone=function(){return this.done&&this.symbol===null},o.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var n=void 0;e=null;for(var i in this.rules){n=this.rules[i];var r=n.exec(this.text);r&&(e===null||r[0].length>e[0].length)&&(e=r,t=i)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},o.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},o.prototype.acceptNumber=function(){return this.accept("number")},o.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},o})();function Te(o,e){e===void 0&&(e=ae);var t={},n=new Ln(e.tokens);if(!n.start(o))return null;return i(),t;function i(){n.expect("every");var c=n.acceptNumber();if(c&&(t.interval=parseInt(c[0],10)),n.isDone())throw new Error("Unexpected end");switch(n.symbol){case"day(s)":t.freq=b.DAILY,n.nextSymbol()&&(a(),d());break;case"weekday(s)":t.freq=b.WEEKLY,t.byweekday=[b.MO,b.TU,b.WE,b.TH,b.FR],n.nextSymbol(),a(),d();break;case"week(s)":t.freq=b.WEEKLY,n.nextSymbol()&&(r(),a(),d());break;case"hour(s)":t.freq=b.HOURLY,n.nextSymbol()&&(r(),d());break;case"minute(s)":t.freq=b.MINUTELY,n.nextSymbol()&&(r(),d());break;case"month(s)":t.freq=b.MONTHLY,n.nextSymbol()&&(r(),d());break;case"year(s)":t.freq=b.YEARLY,n.nextSymbol()&&(r(),d());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=b.WEEKLY;var h=n.symbol.substr(0,2).toUpperCase();if(t.byweekday=[b[h]],!n.nextSymbol())return;for(;n.accept("comma");){if(n.isDone())throw new Error("Unexpected end");var m=l();if(!m)throw new Error("Unexpected symbol "+n.symbol+", expected weekday");t.byweekday.push(b[m]),n.nextSymbol()}a(),u(),d();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=b.YEARLY,t.bymonth=[s()],!n.nextSymbol())return;for(;n.accept("comma");){if(n.isDone())throw new Error("Unexpected end");var g=s();if(!g)throw new Error("Unexpected symbol "+n.symbol+", expected month");t.bymonth.push(g),n.nextSymbol()}r(),d();break;default:throw new Error("Unknown symbol")}}function r(){var c=n.accept("on"),h=n.accept("the");if(c||h)do{var m=p(),g=l(),y=s();if(m)g?(n.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(b[g].nth(m))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(m),n.accept("day(s)"));else if(g)n.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(b[g]);else if(n.symbol==="weekday(s)")n.nextSymbol(),t.byweekday||(t.byweekday=[b.MO,b.TU,b.WE,b.TH,b.FR]);else if(n.symbol==="week(s)"){n.nextSymbol();var v=n.acceptNumber();if(!v)throw new Error("Unexpected symbol "+n.symbol+", expected week number");for(t.byweekno=[parseInt(v[0],10)];n.accept("comma");){if(v=n.acceptNumber(),!v)throw new Error("Unexpected symbol "+n.symbol+"; expected monthday");t.byweekno.push(parseInt(v[0],10))}}else if(y)n.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(y);else return}while(n.accept("comma")||n.accept("the")||n.accept("on"))}function a(){var c=n.accept("at");if(c)do{var h=n.acceptNumber();if(!h)throw new Error("Unexpected symbol "+n.symbol+", expected hour");for(t.byhour=[parseInt(h[0],10)];n.accept("comma");){if(h=n.acceptNumber(),!h)throw new Error("Unexpected symbol "+n.symbol+"; expected hour");t.byhour.push(parseInt(h[0],10))}}while(n.accept("comma")||n.accept("at"))}function s(){switch(n.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function l(){switch(n.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return n.symbol.substr(0,2).toUpperCase();default:return!1}}function p(){switch(n.symbol){case"last":return n.nextSymbol(),-1;case"first":return n.nextSymbol(),1;case"second":return n.nextSymbol(),n.accept("last")?-2:2;case"third":return n.nextSymbol(),n.accept("last")?-3:3;case"nth":var c=parseInt(n.value[1],10);if(c<-366||c>366)throw new Error("Nth out of range: "+c);return n.nextSymbol(),n.accept("last")?-c:c;default:return!1}}function u(){n.accept("on"),n.accept("the");var c=p();if(c)for(t.bymonthday=[c],n.nextSymbol();n.accept("comma");){if(c=p(),!c)throw new Error("Unexpected symbol "+n.symbol+"; expected monthday");t.bymonthday.push(c),n.nextSymbol()}}function d(){if(n.symbol==="until"){var c=Date.parse(n.text);if(!c)throw new Error("Cannot parse until date:"+n.text);t.until=new Date(c)}else n.accept("for")&&(t.count=parseInt(n.value[0],10),n.expect("number"))}}var w;(function(o){o[o.YEARLY=0]="YEARLY",o[o.MONTHLY=1]="MONTHLY",o[o.WEEKLY=2]="WEEKLY",o[o.DAILY=3]="DAILY",o[o.HOURLY=4]="HOURLY",o[o.MINUTELY=5]="MINUTELY",o[o.SECONDLY=6]="SECONDLY"})(w||(w={}));function ke(o){return o<w.HOURLY}var Dt=function(o,e){return e===void 0&&(e=ae),new b(Te(o,e)||void 0)},fe=["count","until","interval","byweekday","bymonthday","bymonth"];V.IMPLEMENTED=[];V.IMPLEMENTED[w.HOURLY]=fe;V.IMPLEMENTED[w.MINUTELY]=fe;V.IMPLEMENTED[w.DAILY]=["byhour"].concat(fe);V.IMPLEMENTED[w.WEEKLY]=fe;V.IMPLEMENTED[w.MONTHLY]=fe;V.IMPLEMENTED[w.YEARLY]=["byweekno","byyearday"].concat(fe);var Pt=function(o,e,t,n){return new V(o,e,t,n).toString()},Rt=V.isFullyConvertible;var ge=(function(){function o(e,t,n,i){this.hour=e,this.minute=t,this.second=n,this.millisecond=i||0}return o.prototype.getHours=function(){return this.hour},o.prototype.getMinutes=function(){return this.minute},o.prototype.getSeconds=function(){return this.second},o.prototype.getMilliseconds=function(){return this.millisecond},o.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},o})();var Ft=(function(o){me(e,o);function e(t,n,i,r,a,s,l){var p=o.call(this,r,a,s,l)||this;return p.year=t,p.month=n,p.day=i,p}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return K(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var n=Math.floor(this.month/12),i=N(this.month,12);this.month=i,this.year+=n,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,n){n>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-n))+t*7:this.day+=-(this.getWeekday()-n)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,n,i){for(n&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var r=Re(this.hour,24),a=r.div,s=r.mod;if(a&&(this.hour=s,this.addDaily(a)),$(i)||T(i,this.hour))break}},e.prototype.addMinutes=function(t,n,i,r){for(n&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var a=Re(this.minute,60),s=a.div,l=a.mod;if(s&&(this.minute=l,this.addHours(s,!1,i)),($(i)||T(i,this.hour))&&($(r)||T(r,this.minute)))break}},e.prototype.addSeconds=function(t,n,i,r,a){for(n&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var s=Re(this.second,60),l=s.div,p=s.mod;if(l&&(this.second=p,this.addMinutes(l,!1,i,r)),($(i)||T(i,this.hour))&&($(r)||T(r,this.minute))&&($(a)||T(a,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=st(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>Fe))return;t=st(this.year,this.month-1)[1]}}},e.prototype.add=function(t,n){var i=t.freq,r=t.interval,a=t.wkst,s=t.byhour,l=t.byminute,p=t.bysecond;switch(i){case w.YEARLY:return this.addYears(r);case w.MONTHLY:return this.addMonths(r);case w.WEEKLY:return this.addWeekly(r,a);case w.DAILY:return this.addDaily(r);case w.HOURLY:return this.addHours(r,n,s);case w.MINUTELY:return this.addMinutes(r,n,s,l);case w.SECONDLY:return this.addSeconds(r,n,s,l,p)}},e})(ge);function dt(o){for(var e=[],t=Object.keys(o),n=0,i=t;n<i.length;n++){var r=i[n];T(It,r)||e.push(r),ot(o[r])&&!ie(o[r])&&e.push(r)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return O({},o)}function At(o){var e=O(O({},Ee),dt(o));if(M(e.byeaster)&&(e.freq=b.YEARLY),!(M(e.freq)&&b.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(o.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),M(e.wkst)?U(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=b.MO.weekday,M(e.bysetpos)){U(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var n=e.bysetpos[t];if(n===0||!(n>=-366&&n<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||D(e.byweekno)||D(e.byyearday)||e.bymonthday||D(e.bymonthday)||M(e.byweekday)||M(e.byeaster)))switch(e.freq){case b.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case b.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case b.WEEKLY:e.byweekday=[K(e.dtstart)];break}if(M(e.bymonth)&&!A(e.bymonth)&&(e.bymonth=[e.bymonth]),M(e.byyearday)&&!A(e.byyearday)&&U(e.byyearday)&&(e.byyearday=[e.byyearday]),!M(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(A(e.bymonthday)){for(var i=[],r=[],t=0;t<e.bymonthday.length;t++){var n=e.bymonthday[t];n>0?i.push(n):n<0&&r.push(n)}e.bymonthday=i,e.bynmonthday=r}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(M(e.byweekno)&&!A(e.byweekno)&&(e.byweekno=[e.byweekno]),!M(e.byweekday))e.bynweekday=null;else if(U(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(at(e.byweekday))e.byweekday=[R.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof R)!e.byweekday.n||e.freq>b.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var a=[],s=[],t=0;t<e.byweekday.length;t++){var l=e.byweekday[t];if(U(l)){a.push(l);continue}else if(at(l)){a.push(R.fromStr(l).weekday);continue}!l.n||e.freq>b.MONTHLY?a.push(l.weekday):s.push([l.weekday,l.n])}e.byweekday=D(a)?a:null,e.bynweekday=D(s)?s:null}return M(e.byhour)?U(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<b.HOURLY?[e.dtstart.getUTCHours()]:null,M(e.byminute)?U(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<b.MINUTELY?[e.dtstart.getUTCMinutes()]:null,M(e.bysecond)?U(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<b.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function Ot(o){var e=o.dtstart.getTime()%1e3;if(!ke(o.freq))return[];var t=[];return o.byhour.forEach(function(n){o.byminute.forEach(function(i){o.bysecond.forEach(function(r){t.push(new ge(n,i,r,e))})})}),t}function Ce(o){var e=o.split(`
`).map(Dn).filter(function(t){return t!==null});return O(O({},e[0]),e[1])}function Se(o){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(o);if(!t)return e;var n=t[1],i=t[2];return n&&(e.tzid=n),e.dtstart=xe(i),e}function Dn(o){if(o=o.replace(/^\s+|\s+$/,""),!o.length)return null;var e=/^([A-Z]+?)[:;]/.exec(o.toUpperCase());if(!e)return Nt(o);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return Nt(o);case"DTSTART":return Se(o);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(o))}}function Nt(o){var e=o.replace(/^RRULE:/i,""),t=Se(e),n=o.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return n.forEach(function(i){var r=i.split("="),a=r[0],s=r[1];switch(a.toUpperCase()){case"FREQ":t.freq=w[s.toUpperCase()];break;case"WKST":t.wkst=W[s.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var l=Pn(s),p=a.toLowerCase();t[p]=l;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=Rn(s);break;case"DTSTART":case"TZID":var u=Se(o);t.tzid=u.tzid,t.dtstart=u.dtstart;break;case"UNTIL":t.until=xe(s);break;case"BYEASTER":t.byeaster=Number(s);break;default:throw new Error("Unknown RRULE property '"+a+"'")}}),t}function Pn(o){if(o.indexOf(",")!==-1){var e=o.split(",");return e.map(Yt)}return Yt(o)}function Yt(o){return/^[+-]?\d+$/.test(o)?Number(o):o}function Rn(o){var e=o.split(",");return e.map(function(t){if(t.length===2)return W[t];var n=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!n||n.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var i=Number(n[1]),r=n[2],a=W[r].weekday;return new R(a,i)})}var oe=(function(){function o(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(o.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),o.prototype.toString=function(){var e=he(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},o.prototype.getTime=function(){return this.date.getTime()},o.prototype.rezonedDate=function(){return this.isUTC?this.date:Mt(this.date,this.tzid)},o})();function Me(o){for(var e=[],t="",n=Object.keys(o),i=Object.keys(Ee),r=0;r<n.length;r++)if(n[r]!=="tzid"&&T(i,n[r])){var a=n[r].toUpperCase(),s=o[n[r]],l="";if(!(!M(s)||A(s)&&!s.length)){switch(a){case"FREQ":l=b.FREQUENCIES[o.freq];break;case"WKST":U(s)?l=new R(s).toString():l=s.toString();break;case"BYWEEKDAY":a="BYDAY",l=Tt(s).map(function(h){return h instanceof R?h:A(h)?new R(h[0],h[1]):new R(h)}).toString();break;case"DTSTART":t=Fn(s,o.tzid);break;case"UNTIL":l=he(s,!o.tzid);break;default:if(A(s)){for(var p=[],u=0;u<s.length;u++)p[u]=String(s[u]);l=p.toString()}else l=String(s)}l&&e.push([a,l])}}var d=e.map(function(h){var m=h[0],g=h[1];return"".concat(m,"=").concat(g.toString())}).join(";"),c="";return d!==""&&(c="RRULE:".concat(d)),[t,c].filter(function(h){return!!h}).join(`
`)}function Fn(o,e){return o?"DTSTART"+new oe(new Date(o),e).toString():""}function An(o,e){return Array.isArray(o)?!Array.isArray(e)||o.length!==e.length?!1:o.every(function(t,n){return t.getTime()===e[n].getTime()}):o instanceof Date?e instanceof Date&&o.getTime()===e.getTime():o===e}var _t=(function(){function o(){this.all=!1,this.before=[],this.after=[],this.between=[]}return o.prototype._cacheAdd=function(e,t,n){t&&(t=t instanceof Date?Ie(t):lt(t)),e==="all"?this.all=t:(n._value=t,this[e].push(n))},o.prototype._cacheGet=function(e,t){var n=!1,i=t?Object.keys(t):[],r=function(u){for(var d=0;d<i.length;d++){var c=i[d];if(!An(t[c],u[c]))return!0}return!1},a=this[e];if(e==="all")n=this.all;else if(A(a))for(var s=0;s<a.length;s++){var l=a[s];if(!(i.length&&r(l))){n=l._value;break}}if(!n&&this.all){for(var p=new Z(e,t),s=0;s<this.all.length&&p.accept(this.all[s]);s++);n=p.getValue(),this._cacheAdd(e,n,t)}return A(n)?lt(n):n instanceof Date?Ie(n):n},o})();var Ht=f(f(f(f(f(f(f(f(f(f(f(f(f([],x(1,31),!0),x(2,28),!0),x(3,31),!0),x(4,30),!0),x(5,31),!0),x(6,30),!0),x(7,31),!0),x(8,31),!0),x(9,30),!0),x(10,31),!0),x(11,30),!0),x(12,31),!0),x(1,7),!0),Ut=f(f(f(f(f(f(f(f(f(f(f(f(f([],x(1,31),!0),x(2,29),!0),x(3,31),!0),x(4,30),!0),x(5,31),!0),x(6,30),!0),x(7,31),!0),x(8,31),!0),x(9,30),!0),x(10,31),!0),x(11,30),!0),x(12,31),!0),x(1,7),!0),On=z(1,29),In=z(1,30),X=z(1,31),Y=z(1,32),$t=f(f(f(f(f(f(f(f(f(f(f(f(f([],Y,!0),In,!0),Y,!0),X,!0),Y,!0),X,!0),Y,!0),Y,!0),X,!0),Y,!0),X,!0),Y,!0),Y.slice(0,7),!0),zt=f(f(f(f(f(f(f(f(f(f(f(f(f([],Y,!0),On,!0),Y,!0),X,!0),Y,!0),X,!0),Y,!0),Y,!0),X,!0),Y,!0),X,!0),Y,!0),Y.slice(0,7),!0),Nn=z(-28,0),Yn=z(-29,0),J=z(-30,0),_=z(-31,0),Wt=f(f(f(f(f(f(f(f(f(f(f(f(f([],_,!0),Yn,!0),_,!0),J,!0),_,!0),J,!0),_,!0),_,!0),J,!0),_,!0),J,!0),_,!0),_.slice(0,7),!0),jt=f(f(f(f(f(f(f(f(f(f(f(f(f([],_,!0),Nn,!0),_,!0),J,!0),_,!0),J,!0),_,!0),_,!0),J,!0),_,!0),J,!0),_,!0),_.slice(0,7),!0),Bt=[0,31,60,91,121,152,182,213,244,274,305,335,366],Vt=[0,31,59,90,120,151,181,212,243,273,304,334,365],pt=(function(){for(var o=[],e=0;e<55;e++)o=o.concat(z(7));return o})();function Gt(o,e){var t=B(o,1,1),n=pe(o)?366:365,i=pe(o+1)?366:365,r=we(t),a=K(t),s=O(O({yearlen:n,nextyearlen:i,yearordinal:r,yearweekday:a},_n(o)),{wnomask:null});if($(e.byweekno))return s;s.wnomask=x(0,n+7);var l,p,u=l=N(7-a+e.wkst,7);u>=4?(u=0,p=s.yearlen+N(a-e.wkst,7)):p=n-u;for(var d=Math.floor(p/7),c=N(p,7),h=Math.floor(d+c/4),m=0;m<e.byweekno.length;m++){var g=e.byweekno[m];if(g<0&&(g+=h+1),g>0&&g<=h){var y=void 0;g>1?(y=u+(g-1)*7,u!==l&&(y-=7-l)):y=u;for(var v=0;v<7&&(s.wnomask[y]=1,y++,s.wdaymask[y]!==e.wkst);v++);}}if(T(e.byweekno,1)){var y=u+h*7;if(u!==l&&(y-=7-l),y<n)for(var m=0;m<7&&(s.wnomask[y]=1,y+=1,s.wdaymask[y]!==e.wkst);m++);}if(u){var E=void 0;if(T(e.byweekno,-1))E=-1;else{var H=K(B(o-1,1,1)),G=N(7-H.valueOf()+e.wkst,7),tt=pe(o-1)?366:365,ne=void 0;G>=4?(G=0,ne=tt+N(H-e.wkst,7)):ne=n-u,E=Math.floor(52+N(ne,7)/4)}if(T(e.byweekno,E))for(var y=0;y<u;y++)s.wnomask[y]=1}return s}function _n(o){var e=pe(o)?366:365,t=B(o,1,1),n=K(t);return e===365?{mmask:Ht,mdaymask:zt,nmdaymask:jt,wdaymask:pt.slice(n),mrange:Vt}:{mmask:Ut,mdaymask:$t,nmdaymask:Wt,wdaymask:pt.slice(n),mrange:Bt}}function Kt(o,e,t,n,i,r){var a={lastyear:o,lastmonth:e,nwdaymask:[]},s=[];if(r.freq===b.YEARLY)if($(r.bymonth))s=[[0,t]];else for(var l=0;l<r.bymonth.length;l++)e=r.bymonth[l],s.push(n.slice(e-1,e+1));else r.freq===b.MONTHLY&&(s=[n.slice(e-1,e+1)]);if($(s))return a;a.nwdaymask=x(0,t);for(var l=0;l<s.length;l++)for(var p=s[l],u=p[0],d=p[1]-1,c=0;c<r.bynweekday.length;c++){var h=void 0,m=r.bynweekday[c],g=m[0],y=m[1];y<0?(h=d+(y+1)*7,h-=N(i[h]-g,7)):(h=u+(y-1)*7,h+=N(7-i[h]+g,7)),u<=h&&h<=d&&(a.nwdaymask[h]=1)}return a}function qt(o,e){e===void 0&&(e=0);var t=o%19,n=Math.floor(o/100),i=o%100,r=Math.floor(n/4),a=n%4,s=Math.floor((n+8)/25),l=Math.floor((n-s+1)/3),p=Math.floor(19*t+n-r-l+15)%30,u=Math.floor(i/4),d=i%4,c=Math.floor(32+2*a+2*u-p-d)%7,h=Math.floor((t+11*p+22*c)/451),m=Math.floor((p+c-7*h+114)/31),g=(p+c-7*h+114)%31+1,y=Date.UTC(o,m-1,g+e),v=Date.UTC(o,0,1);return[Math.ceil((y-v)/(1e3*60*60*24))]}var Hn=(function(){function o(e){this.options=e}return o.prototype.rebuild=function(e,t){var n=this.options;if(e!==this.lastyear&&(this.yearinfo=Gt(e,n)),D(n.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var i=this.yearinfo,r=i.yearlen,a=i.mrange,s=i.wdaymask;this.monthinfo=Kt(e,t,r,a,s,n)}M(n.byeaster)&&(this.eastermask=qt(e,n.byeaster))},Object.defineProperty(o.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),o.prototype.ydayset=function(){return[z(this.yearlen),0,this.yearlen]},o.prototype.mdayset=function(e,t){for(var n=this.mrange[t-1],i=this.mrange[t],r=x(null,this.yearlen),a=n;a<i;a++)r[a]=a;return[r,n,i]},o.prototype.wdayset=function(e,t,n){for(var i=x(null,this.yearlen+7),r=we(B(e,t,n))-this.yearordinal,a=r,s=0;s<7&&(i[r]=r,++r,this.wdaymask[r]!==this.options.wkst);s++);return[i,a,r]},o.prototype.ddayset=function(e,t,n){var i=x(null,this.yearlen),r=we(B(e,t,n))-this.yearordinal;return i[r]=r,[i,r,r+1]},o.prototype.htimeset=function(e,t,n,i){var r=this,a=[];return this.options.byminute.forEach(function(s){a=a.concat(r.mtimeset(e,s,n,i))}),q(a),a},o.prototype.mtimeset=function(e,t,n,i){var r=this.options.bysecond.map(function(a){return new ge(e,t,a,i)});return q(r),r},o.prototype.stimeset=function(e,t,n,i){return[new ge(e,t,n,i)]},o.prototype.getdayset=function(e){switch(e){case w.YEARLY:return this.ydayset.bind(this);case w.MONTHLY:return this.mdayset.bind(this);case w.WEEKLY:return this.wdayset.bind(this);case w.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},o.prototype.gettimeset=function(e){switch(e){case w.HOURLY:return this.htimeset.bind(this);case w.MINUTELY:return this.mtimeset.bind(this);case w.SECONDLY:return this.stimeset.bind(this)}},o})(),Zt=Hn;function Qt(o,e,t,n,i,r){for(var a=[],s=0;s<o.length;s++){var l=void 0,p=void 0,u=o[s];u<0?(l=Math.floor(u/e.length),p=N(u,e.length)):(l=Math.floor((u-1)/e.length),p=N(u-1,e.length));for(var d=[],c=t;c<n;c++){var h=r[c];M(h)&&d.push(h)}var m=void 0;l<0?m=d.slice(l)[0]:m=d[l];var g=e[p],y=Ae(i.yearordinal+m),v=Oe(y,g);T(a,v)||a.push(v)}return q(a),a}function Ne(o,e){var t=e.dtstart,n=e.freq,i=e.interval,r=e.until,a=e.bysetpos,s=e.count;if(s===0||i===0)return Q(o);var l=Ft.fromDate(t),p=new Zt(e);p.rebuild(l.year,l.month);for(var u=zn(p,l,e);;){var d=p.getdayset(n)(l.year,l.month,l.day),c=d[0],h=d[1],m=d[2],g=$n(c,h,m,p,e);if(D(a))for(var y=Qt(a,u,h,m,p,c),v=0;v<y.length;v++){var E=y[v];if(r&&E>r)return Q(o);if(E>=t){var H=Xt(E,e);if(!o.accept(H)||s&&(--s,!s))return Q(o)}}else for(var v=h;v<m;v++){var G=c[v];if(M(G))for(var tt=Ae(p.yearordinal+G),ne=0;ne<u.length;ne++){var dn=u[ne],E=Oe(tt,dn);if(r&&E>r)return Q(o);if(E>=t){var H=Xt(E,e);if(!o.accept(H)||s&&(--s,!s))return Q(o)}}}if(e.interval===0||(l.add(e,g),l.year>Fe))return Q(o);ke(n)||(u=p.gettimeset(n)(l.hour,l.minute,l.second,0)),p.rebuild(l.year,l.month)}}function Un(o,e,t){var n=t.bymonth,i=t.byweekno,r=t.byweekday,a=t.byeaster,s=t.bymonthday,l=t.bynmonthday,p=t.byyearday;return D(n)&&!T(n,o.mmask[e])||D(i)&&!o.wnomask[e]||D(r)&&!T(r,o.wdaymask[e])||D(o.nwdaymask)&&!o.nwdaymask[e]||a!==null&&!T(o.eastermask,e)||(D(s)||D(l))&&!T(s,o.mdaymask[e])&&!T(l,o.nmdaymask[e])||D(p)&&(e<o.yearlen&&!T(p,e+1)&&!T(p,-o.yearlen+e)||e>=o.yearlen&&!T(p,e+1-o.yearlen)&&!T(p,-o.nextyearlen+e-o.yearlen))}function Xt(o,e){return new oe(o,e.tzid).rezonedDate()}function Q(o){return o.getValue()}function $n(o,e,t,n,i){for(var r=!1,a=e;a<t;a++){var s=o[a];r=Un(n,s,i),r&&(o[s]=null)}return r}function zn(o,e,t){var n=t.freq,i=t.byhour,r=t.byminute,a=t.bysecond;return ke(n)?Ot(t):n>=b.HOURLY&&D(i)&&!T(i,e.hour)||n>=b.MINUTELY&&D(r)&&!T(r,e.minute)||n>=b.SECONDLY&&D(a)&&!T(a,e.second)?[]:o.gettimeset(n)(e.hour,e.minute,e.second,e.millisecond)}var W={MO:new R(0),TU:new R(1),WE:new R(2),TH:new R(3),FR:new R(4),SA:new R(5),SU:new R(6)},Ee={freq:w.YEARLY,dtstart:null,interval:1,wkst:W.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},It=Object.keys(Ee),b=(function(){function o(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new _t,this.origOptions=dt(e);var n=At(e).parsedOptions;this.options=n}return o.parseText=function(e,t){return Te(e,t)},o.fromText=function(e,t){return Dt(e,t)},o.fromString=function(e){return new o(o.parseString(e)||void 0)},o.prototype._iter=function(e){return Ne(e,this.options)},o.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},o.prototype._cacheAdd=function(e,t,n){if(this._cache)return this._cache._cacheAdd(e,t,n)},o.prototype.all=function(e){if(e)return this._iter(new ut("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Z("all",{})),this._cacheAdd("all",t)),t},o.prototype.between=function(e,t,n,i){if(n===void 0&&(n=!1),!ie(e)||!ie(t))throw new Error("Invalid date passed in to RRule.between");var r={before:t,after:e,inc:n};if(i)return this._iter(new ut("between",r,i));var a=this._cacheGet("between",r);return a===!1&&(a=this._iter(new Z("between",r)),this._cacheAdd("between",a,r)),a},o.prototype.before=function(e,t){if(t===void 0&&(t=!1),!ie(e))throw new Error("Invalid date passed in to RRule.before");var n={dt:e,inc:t},i=this._cacheGet("before",n);return i===!1&&(i=this._iter(new Z("before",n)),this._cacheAdd("before",i,n)),i},o.prototype.after=function(e,t){if(t===void 0&&(t=!1),!ie(e))throw new Error("Invalid date passed in to RRule.after");var n={dt:e,inc:t},i=this._cacheGet("after",n);return i===!1&&(i=this._iter(new Z("after",n)),this._cacheAdd("after",i,n)),i},o.prototype.count=function(){return this.all().length},o.prototype.toString=function(){return Me(this.origOptions)},o.prototype.toText=function(e,t,n){return Pt(this,e,t,n)},o.prototype.isFullyConvertibleToText=function(){return Rt(this)},o.prototype.clone=function(){return new o(this.origOptions)},o.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],o.YEARLY=w.YEARLY,o.MONTHLY=w.MONTHLY,o.WEEKLY=w.WEEKLY,o.DAILY=w.DAILY,o.HOURLY=w.HOURLY,o.MINUTELY=w.MINUTELY,o.SECONDLY=w.SECONDLY,o.MO=W.MO,o.TU=W.TU,o.WE=W.WE,o.TH=W.TH,o.FR=W.FR,o.SA=W.SA,o.SU=W.SU,o.parseString=Ce,o.optionsToString=Me,o})();function Jt(o,e,t,n,i,r){var a={},s=o.accept;function l(c,h){t.forEach(function(m){m.between(c,h,!0).forEach(function(g){a[Number(g)]=!0})})}i.forEach(function(c){var h=new oe(c,r).rezonedDate();a[Number(h)]=!0}),o.accept=function(c){var h=Number(c);return isNaN(h)?s.call(this,c):!a[h]&&(l(new Date(h-1),new Date(h+1)),!a[h])?(a[h]=!0,s.call(this,c)):!0},o.method==="between"&&(l(o.args.after,o.args.before),o.accept=function(c){var h=Number(c);return a[h]?!0:(a[h]=!0,s.call(this,c))});for(var p=0;p<n.length;p++){var u=new oe(n[p],r).rezonedDate();if(!o.accept(new Date(u.getTime())))break}e.forEach(function(c){Ne(o,c.options)});var d=o._result;switch(q(d),o.method){case"all":case"between":return d;case"before":return d.length&&d[d.length-1]||null;default:return d.length&&d[0]||null}}var en={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function Wn(o,e){var t=[],n=[],i=[],r=[],a=Se(o),s=a.dtstart,l=a.tzid,p=Kn(o,e.unfold);return p.forEach(function(u){var d;if(u){var c=Gn(u),h=c.name,m=c.parms,g=c.value;switch(h.toUpperCase()){case"RRULE":if(m.length)throw new Error("unsupported RRULE parm: ".concat(m.join(",")));t.push(Ce(u));break;case"RDATE":var y=(d=/RDATE(?:;TZID=([^:=]+))?/i.exec(u))!==null&&d!==void 0?d:[],v=y[1];v&&!l&&(l=v),n=n.concat(tn(g,m));break;case"EXRULE":if(m.length)throw new Error("unsupported EXRULE parm: ".concat(m.join(",")));i.push(Ce(g));break;case"EXDATE":r=r.concat(tn(g,m));break;case"DTSTART":break;default:throw new Error("unsupported property: "+h)}}}),{dtstart:s,tzid:l,rrulevals:t,rdatevals:n,exrulevals:i,exdatevals:r}}function jn(o,e){var t=Wn(o,e),n=t.rrulevals,i=t.rdatevals,r=t.exrulevals,a=t.exdatevals,s=t.dtstart,l=t.tzid,p=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||n.length>1||i.length||r.length||a.length){var u=new mt(p);return u.dtstart(s),u.tzid(l||void 0),n.forEach(function(c){u.rrule(new b(ht(c,s,l),p))}),i.forEach(function(c){u.rdate(c)}),r.forEach(function(c){u.exrule(new b(ht(c,s,l),p))}),a.forEach(function(c){u.exdate(c)}),e.compatible&&e.dtstart&&u.rdate(s),u}var d=n[0]||{};return new b(ht(d,d.dtstart||e.dtstart||s,d.tzid||e.tzid||l),p)}function Ye(o,e){return e===void 0&&(e={}),jn(o,Bn(e))}function ht(o,e,t){return O(O({},o),{dtstart:e,tzid:t})}function Bn(o){var e=[],t=Object.keys(o),n=Object.keys(en);if(t.forEach(function(i){T(n,i)||e.push(i)}),e.length)throw new Error("Invalid options: "+e.join(", "));return O(O({},en),o)}function Vn(o){if(o.indexOf(":")===-1)return{name:"RRULE",value:o};var e=kt(o,":",1),t=e[0],n=e[1];return{name:t,value:n}}function Gn(o){var e=Vn(o),t=e.name,n=e.value,i=t.split(";");if(!i)throw new Error("empty property name");return{name:i[0].toUpperCase(),parms:i.slice(1),value:n}}function Kn(o,e){if(e===void 0&&(e=!1),o=o&&o.trim(),!o)throw new Error("Invalid empty string");if(!e)return o.split(/\s/);for(var t=o.split(`
`),n=0;n<t.length;){var i=t[n]=t[n].replace(/\s+$/g,"");i?n>0&&i[0]===" "?(t[n-1]+=i.slice(1),t.splice(n,1)):n+=1:t.splice(n,1)}return t}function qn(o){o.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function tn(o,e){return qn(e),o.split(",").map(function(t){return xe(t)})}function nn(o){var e=this;return function(t){if(t!==void 0&&(e["_".concat(o)]=t),e["_".concat(o)]!==void 0)return e["_".concat(o)];for(var n=0;n<e._rrule.length;n++){var i=e._rrule[n].origOptions[o];if(i)return i}}}var mt=(function(o){me(e,o);function e(t){t===void 0&&(t=!1);var n=o.call(this,{},t)||this;return n.dtstart=nn.apply(n,["dtstart"]),n.tzid=nn.apply(n,["tzid"]),n._rrule=[],n._rdate=[],n._exrule=[],n._exdate=[],n}return e.prototype._iter=function(t){return Jt(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){rn(t,this._rrule)},e.prototype.exrule=function(t){rn(t,this._exrule)},e.prototype.rdate=function(t){an(t,this._rdate)},e.prototype.exdate=function(t){an(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return Ye(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return Ye(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Me({dtstart:this._dtstart}))),this._rrule.forEach(function(n){t=t.concat(n.toString().split(`
`))}),this._exrule.forEach(function(n){t=t.concat(n.toString().split(`
`).map(function(i){return i.replace(/^RRULE:/,"EXRULE:")}).filter(function(i){return!/^DTSTART/.test(i)}))}),this._rdate.length&&t.push(on("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(on("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(n){return t.rrule(n.clone())}),this._exrule.forEach(function(n){return t.exrule(n.clone())}),this._rdate.forEach(function(n){return t.rdate(new Date(n.getTime()))}),this._exdate.forEach(function(n){return t.exdate(new Date(n.getTime()))}),t},e})(b);function rn(o,e){if(!(o instanceof b))throw new TypeError(String(o)+" is not RRule instance");T(e.map(String),String(o))||e.push(o)}function an(o,e){if(!(o instanceof Date))throw new TypeError(String(o)+" is not Date instance");T(e.map(Number),Number(o))||(e.push(o),q(e))}function on(o,e,t){var n=!t||t.toUpperCase()==="UTC",i=n?"".concat(o,":"):"".concat(o,";TZID=").concat(t,":"),r=e.map(function(a){return he(a.valueOf(),n)}).join(",");return"".concat(i).concat(r)}var _e=class extends Le.Modal{constructor(t,n,i,r){super(t);this.previewEl=null;this.currentRule=n,this.startDate=i,this.onSubmit=r}updatePreview(t){if(this.previewEl){if(this.previewEl.empty(),!t||!t.trim()){this.previewEl.style.display="none";return}try{let n=b.parseString(t);n.dtstart=this.startDate;let i=new b(n),r=this.startDate,a=i.between(r,new Date(r.getTime()+365*24*60*60*1e3),!0,(p,u)=>u<5);if(a.length===0){this.previewEl.style.display="none";return}this.previewEl.style.display="block";let s=this.previewEl.createDiv({cls:"tps-gcm-recurrence-preview-title"});s.textContent="Next Occurrences";let l=this.previewEl.createDiv({cls:"tps-gcm-recurrence-preview-list"});a.forEach(p=>{let u=l.createDiv({cls:"tps-gcm-recurrence-preview-item"});u.textContent=p.toLocaleDateString(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric"})})}catch(n){this.previewEl.style.display="none"}}}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Set Recurrence"});let n;new Le.Setting(t).setName("Recurrence Rule").setDesc("RRULE string (e.g., FREQ=WEEKLY;BYDAY=MO)").addText(r=>{n=r,r.setValue(this.currentRule),r.setPlaceholder("FREQ=DAILY"),r.inputEl.style.width="100%",r.inputEl.addEventListener("keydown",a=>{a.stopPropagation(),a.key==="Enter"&&(this.close(),this.onSubmit(n.getValue()))}),r.inputEl.addEventListener("input",()=>{this.updatePreview(n.getValue())})});let i=t.createDiv("tps-gcm-recurrence-options");i.style.display="flex",i.style.flexWrap="wrap",i.style.gap="8px",i.style.marginTop="12px",i.style.marginBottom="12px",wt.forEach(r=>{i.createEl("button",{text:r.label}).addEventListener("click",()=>{n.setValue(r.value),this.updatePreview(r.value)})}),this.previewEl=t.createDiv({cls:"tps-gcm-recurrence-preview"}),this.updatePreview(this.currentRule),new Le.Setting(t).addButton(r=>{r.setButtonText("Clear").setWarning().onClick(()=>{this.close(),this.onSubmit("")})}).addButton(r=>{r.setButtonText("Save").setCta().onClick(()=>{this.close(),this.onSubmit(n.getValue())})})}onClose(){this.contentEl.empty(),this.previewEl=null}};var se=require("obsidian"),He=class extends se.Modal{constructor(e,t,n,i,r){super(e),this.currentDate=t,this.currentTimeEstimate=n||0,this.currentAllDay=i||!1,this.onSubmit=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Set Scheduled Date"});let t=this.currentDate;t&&!t.includes("T")&&(t=`${t}T00:00`),new se.Setting(e).setName("Scheduled").addText(a=>{a.inputEl.type="datetime-local",a.setValue(t),this.dateComponent=a,a.inputEl.addEventListener("input",()=>this.recalculateEndTime()),a.inputEl.addEventListener("click",s=>s.stopPropagation()),a.inputEl.addEventListener("keydown",s=>s.stopPropagation())}),new se.Setting(e).setName("All Day").addToggle(a=>{a.setValue(this.currentAllDay),this.allDayToggle=a}),new se.Setting(e).setName("Time Estimate (minutes)").addText(a=>{a.inputEl.type="number",a.setValue(String(this.currentTimeEstimate)),this.timeEstimateComponent=a,a.inputEl.addEventListener("input",()=>this.recalculateEndTime()),a.inputEl.addEventListener("click",s=>s.stopPropagation()),a.inputEl.addEventListener("keydown",s=>s.stopPropagation())}),new se.Setting(e).setName("End Time").setDesc("Modifying this updates Time Estimate").addText(a=>{a.inputEl.type="datetime-local",this.endTimeComponent=a,a.inputEl.addEventListener("input",()=>this.recalculateTimeEstimate()),a.inputEl.addEventListener("click",s=>s.stopPropagation()),a.inputEl.addEventListener("keydown",s=>s.stopPropagation())}),this.recalculateEndTime();let n=e.createDiv("tps-gcm-modal-footer");n.style.display="flex",n.style.justifyContent="flex-end",n.style.gap="8px",n.style.marginTop="16px";let i=n.createEl("button",{text:"Clear"});i.classList.add("mod-warning"),i.addEventListener("click",()=>{this.close(),this.onSubmit({date:"",timeEstimate:0,allDay:!1})});let r=n.createEl("button",{text:"Save"});r.classList.add("mod-cta"),r.addEventListener("click",()=>{this.close(),this.onSubmit({date:this.dateComponent.getValue(),timeEstimate:parseInt(this.timeEstimateComponent.getValue())||0,allDay:this.allDayToggle.getValue()})})}recalculateEndTime(){if(!this.dateComponent||!this.timeEstimateComponent||!this.endTimeComponent)return;let e=this.dateComponent.getValue(),t=parseInt(this.timeEstimateComponent.getValue())||0;if(!e){this.endTimeComponent.setValue("");return}let n=new Date(e);if(isNaN(n.getTime()))return;let i=new Date(n.getTime()+t*6e4),r=i.getTimezoneOffset()*6e4,s=new Date(i.getTime()-r).toISOString().substring(0,16);this.endTimeComponent.setValue(s)}recalculateTimeEstimate(){if(!this.dateComponent||!this.timeEstimateComponent||!this.endTimeComponent)return;let e=this.dateComponent.getValue(),t=this.endTimeComponent.getValue();if(!e||!t)return;let n=new Date(e),i=new Date(t);if(isNaN(n.getTime())||isNaN(i.getTime()))return;let r=i.getTime()-n.getTime(),a=Math.round(r/6e4);a>=0&&this.timeEstimateComponent.setValue(String(a))}onClose(){this.contentEl.empty()}};var De=require("obsidian"),Ue=class extends De.Modal{constructor(t,n,i,r){super(t);this.value="";this.label=n,this.initialValue=i||"",this.value=this.initialValue,this.onSubmit=r}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:`Edit ${this.label}`}),new De.Setting(t).setName(this.label).addText(n=>{n.setValue(this.initialValue),n.setPlaceholder(`Enter ${this.label}...`),n.inputEl.addEventListener("keydown",i=>{i.stopPropagation(),i.key==="Enter"&&(this.close(),this.onSubmit(this.value))}),n.onChange(i=>{this.value=i}),setTimeout(()=>n.inputEl.focus(),50)}),new De.Setting(t).addButton(n=>{n.setButtonText("Save").setCta().onClick(()=>{this.close(),this.onSubmit(this.value)})}).addButton(n=>{n.setButtonText("Cancel").onClick(()=>{this.close()})})}onClose(){let{contentEl:t}=this;t.empty()}};var sn=require("obsidian"),$e=class extends sn.Modal{constructor(e,t,n,i){super(e),this.files=t,this.customOptions=n,this.onSnooze=i}onOpen(){let{contentEl:e}=this;e.addClass("tps-context-modal"),e.createEl("h2",{text:`Snooze (${this.files.length} notes)`});let t=e.createDiv({cls:"tps-context-grid"});t.style.display="grid",t.style.gridTemplateColumns="repeat(auto-fill, minmax(140px, 1fr))",t.style.gap="10px",t.style.marginTop="15px",this.customOptions.forEach(a=>{let s=t.createEl("button",{text:a.label,cls:"mod-cta"});s.style.width="100%",s.style.height="40px",s.addEventListener("click",async()=>{await this.onSnooze(a.minutes),this.close()})});let n=e.createDiv({cls:"tps-context-input-group"});n.style.marginTop="20px",n.style.borderTop="1px solid var(--background-modifier-border)",n.style.paddingTop="15px",n.createEl("span",{text:"Custom (minutes): "});let i=n.createEl("input",{type:"number"});i.placeholder="30",n.createEl("button",{text:"Apply"}).addEventListener("click",async()=>{let a=parseInt(i.value);!isNaN(a)&&a>0&&(await this.onSnooze(a),this.close())}),i.addEventListener("keydown",a=>{if(a.key==="Enter"){let s=parseInt(i.value);!isNaN(s)&&s>0&&this.onSnooze(s).then(()=>this.close())}})}onClose(){this.contentEl.empty()}};var ze=!1;function We(o){ze=!!o}function C(o,...e){ze&&console.log(o,...e)}function j(o,...e){ze&&console.warn(o,...e)}function P(o,...e){ze&&console.error(o,...e)}function ln(o){let e=0;for(let t=0;t<o.length;t++)e=o.charCodeAt(t)+((e<<5)-e),e=e&e;return Math.abs(e)%360}function I(o,e){o.addEventListener("click",t=>{t.stopPropagation(),e(t)}),o.addEventListener("mousedown",t=>t.stopPropagation())}var je=class{constructor(e){this.plugin=e}detach(){}hideMenu(){}addToNativeMenu(e,t){if(e._tpsHandled)return;e._tpsHandled=!0;let n=e.items?e.items.length:0,i=this.plugin.contextTargetService.resolveTargets(t),r=this.createFileEntries(i);if(!r.length)return;let a=r.filter(d=>{var c;return((c=d.file.extension)==null?void 0:c.toLowerCase())==="md"}),s=a.map(d=>d.file),l=e.addItem;e.addItem=d=>l.call(e,c=>{d(c),c._isTpsItem=!0});let p=this.plugin.settings.systemCommands||[],u=r[0].file;p.includes("open-in-new-tab")&&e.addItem(d=>{d.setTitle("Open in new tab").setIcon("file-plus").setSection("tps-file-ops").onClick(()=>{this.app.workspace.getLeaf("tab").openFile(u)})}),p.includes("open-to-right")&&e.addItem(d=>{d.setTitle("Open to the right").setIcon("separator-vertical").setSection("tps-file-ops").onClick(()=>{this.app.workspace.getLeaf("split").openFile(u)})}),p.includes("open-in-new-window")&&e.addItem(d=>{d.setTitle("Open in new window").setIcon("maximize").setSection("tps-file-ops").onClick(()=>{this.app.workspace.getLeaf("window").openFile(u)})}),p.includes("open-in-same-tab")&&e.addItem(d=>{d.setTitle("Open in same tab").setIcon("file").setSection("tps-file-ops").onClick(()=>{this.app.workspace.getLeaf(!1).openFile(u)})}),p.includes("rename")&&e.addItem(d=>{d.setTitle("Rename...").setIcon("pencil").setSection("tps-file-ops").onClick(()=>{typeof this.app.fileManager.promptForFileRename=="function"?this.app.fileManager.promptForFileRename(u):new S.Notice("Rename not supported in this version via context menu")})}),p.includes("bookmark")&&e.addItem(d=>{var m,g;let c=this.app.internalPlugins.getPluginById("bookmarks"),h=(g=(m=c==null?void 0:c.instance)==null?void 0:m.items)==null?void 0:g.some(y=>y.path===u.path);d.setTitle(h?"Remove bookmark":"Bookmark").setIcon("bookmark").setSection("tps-file-ops").onClick(()=>{c&&c.instance&&(h?c.instance.removeItemByPath(u.path):c.instance.addItem({type:"file",path:u.path}))})}),p.includes("move-file")&&e.addItem(d=>{d.setTitle("Move file to...").setIcon("folder-input").setSection("tps-file-ops").onClick(()=>{typeof this.app.fileManager.promptForFileMove=="function"?this.app.fileManager.promptForFileMove(u):this.app.commands.executeCommandById("app:move-file")})}),p.includes("duplicate")&&e.addItem(d=>{d.setTitle("Duplicate").setIcon("copy").setSection("tps-file-ops").onClick(async()=>{var H;let c=u.basename,h=u.extension,m=((H=u.parent)==null?void 0:H.path)||"",y=!h?u.name:c,v=m?`${m}/${y} copy`:`${y} copy`;h&&(v+=`.${h}`);let E=2;for(;this.app.vault.getAbstractFileByPath(v);)v=m?`${m}/${y} copy ${E}`:`${y} copy ${E}`,h&&(v+=`.${h}`),E++;if(u instanceof S.TFile){let G=await this.app.vault.read(u);await this.app.vault.create(v,G)}else{new S.Notice("Folder duplication not supported yet");return}new S.Notice(`Created ${v}`)})}),p.includes("copy-url")&&e.addItem(d=>{d.setTitle("Copy Obsidian URL").setIcon("link").setSection("tps-file-ops").onClick(()=>{let c=this.app.getObsidianUrl(u);navigator.clipboard.writeText(c),new S.Notice("Obsidian URL copied")})}),p.includes("get-relative-path")&&e.addItem(d=>{d.setTitle("Copy relative path").setIcon("link").setSection("tps-file-ops").onClick(()=>{navigator.clipboard.writeText(u.path),new S.Notice("Path copied to clipboard")})}),p.includes("reveal-finder")&&e.addItem(d=>{d.setTitle("Reveal in system explorer").setIcon("monitor").setSection("tps-reveal-ops").onClick(()=>{this.app.showInFolder(u.path)})}),p.includes("reveal-nav")&&e.addItem(d=>{d.setTitle("Reveal in navigation").setIcon("folder-open").setSection("tps-reveal-ops").onClick(()=>{let c=this.app.workspace.getLeavesOfType("file-explorer")[0];c&&c.view&&c.view.revealInFolder(u)})}),a.length>0&&((this.plugin.settings.properties||[]).forEach(c=>{if(c.showInContextMenu!==!1){if(c.key==="snooze"||c.type==="snooze"){e.addItem(h=>{let m=a[0].frontmatter[c.key];h.setTitle(m?`Snooze: ${m}`:"Snooze...").setIcon(c.icon||"clock").setSection("tps-props").onClick(()=>{this.openSnoozeModal(a,c.key)})});return}c.type==="selector"?this.addSelectorToMenu(e,a,c,"tps-props"):c.type==="list"?this.addListToMenu(e,a,c,"tps-props"):c.type==="datetime"?this.addDatetimeToMenu(e,a,c,"tps-props"):c.type==="recurrence"?this.addRecurrenceToMenu(e,a,c,"tps-props"):c.type==="folder"?this.addFolderToMenu(e,a,c,"tps-props"):(c.type==="text"||c.type==="number")&&e.addItem(h=>{let m=a[0].frontmatter[c.key];h.setTitle(`${c.label}: ${m||"Empty"}`).setIcon(c.icon||"pencil").setSection("tps-props").onClick(()=>{new Ue(this.app,c.label,m!=null?m:"",async g=>{if(g!=null){let y=c.type==="number"?Number(g):g;await this.plugin.bulkEditService.updateFrontmatter(a.map(v=>v.file),{[c.key]:y})}}).open()})})}}),s.length>0&&e.addItem(c=>c.setTitle("Add to note...").setIcon("file-plus").setSection("tps-note-ops").onClick(()=>{this.plugin.noteOperationService.addNotesToAnotherNote(s)}))),e.addItem(d=>{let c=r.length,h=c>1?`Delete (${c} items)`:"Delete";d.setTitle(h).setIcon("trash").setSection("tps-delete").setWarning(!0).onClick(async()=>{if(c===1&&this.app.fileManager.promptForDeletion)this.app.fileManager.promptForDeletion(r[0].file);else{let m=c===1?`Are you sure you want to delete "${r[0].file.name}"?`:`Are you sure you want to delete ${c} items?`;if(confirm(m))for(let g of r)await this.app.vault.trash(g.file,!0)}})}),e.addItem=l}addSelectorToMenu(e,t,n,i){e.addItem(r=>{let a=t.map(u=>u.frontmatter[n.key]||""),l=new Set(a).size===1?a[0]:"Mixed";r.setTitle(`${n.label}: ${l}`).setIcon(n.icon||"hash").setSection(i);let p=r.setSubmenu();(n.options||[]).forEach(u=>{p.addItem(d=>{d.setTitle(u).setChecked(l===u).onClick(async()=>{await this.plugin.bulkEditService.updateFrontmatter(t.map(c=>c.file),{[n.key]:u})})})})})}addListToMenu(e,t,n,i){e.addItem(r=>{let a=t[0].frontmatter[n.key]||[],s=Array.isArray(a)?a.length:0;r.setTitle(`${n.label} (${s})`).setIcon(n.icon||"list").setSection(i);let l=r.setSubmenu();this.populateListSubmenu(l,t,n,a)})}populateListSubmenu(e,t,n,i){e.addItem(r=>{r.setTitle(`Add ${n.label}...`).setIcon("plus").onClick(()=>{this.openAddTagModal(t,n.key)})}),Array.isArray(i)&&i.forEach(r=>{e.addItem(a=>{a.setTitle(r).setIcon("cross").onClick(async()=>{await this.plugin.bulkEditService.removeTag(t.map(s=>s.file),r,n.key)})})})}addDatetimeToMenu(e,t,n,i){let r=t[0].frontmatter[n.key];e.addItem(a=>{a.setTitle(r?`${n.label}: ${r}`:`Set ${n.label}...`).setIcon(n.icon||"calendar").setSection(i).onClick(()=>{this.openScheduledModal(t,n.key)})})}addRecurrenceToMenu(e,t,n,i){let r=this.getRecurrenceValue(t[0].frontmatter);e.addItem(a=>{a.setTitle(r?`Edit ${n.label}...`:`Add ${n.label}...`).setIcon(n.icon||"repeat").setSection(i).onClick(()=>{this.openRecurrenceModalNative(t)})})}addFolderToMenu(e,t,n,i){e.addItem(r=>{var l;let a=((l=t[0].file.parent)==null?void 0:l.path)||"/";r.setTitle(`${n.label}: ${a}`).setIcon(n.icon||"folder").setSection(i);let s=r.setSubmenu();this.populateFolderMenu(s,t)})}createFileEntries(e){return e.map(t=>{var n;return{file:t,frontmatter:((n=this.app.metadataCache.getFileCache(t))==null?void 0:n.frontmatter)||{}}})}getRecurrenceValue(e){return e.recurrenceRule||e.recurrence||""}populateFolderMenu(e,t){let n=this.app.vault.getAllLoadedFiles().filter(i=>i instanceof S.TFolder);n.sort((i,r)=>i.path.localeCompare(r.path)),e.addItem(i=>{var r;i.setTitle("/").setChecked(((r=t[0].file.parent)==null?void 0:r.path)==="/").onClick(async()=>{await this.moveFiles(t,"/")})}),n.forEach(i=>{i.path!=="/"&&e.addItem(r=>{var a;r.setTitle(i.path).setChecked(((a=t[0].file.parent)==null?void 0:a.path)===i.path).onClick(async()=>{await this.moveFiles(t,i.path)})})})}async moveFiles(e,t){for(let n of e){let i=`${t==="/"?"":t}/${n.file.name}`;if(i!==n.file.path)try{await this.app.fileManager.renameFile(n.file,i)}catch(r){P(`Failed to move file to ${i}`,r),new S.Notice(`Failed to move file: ${r.message}`)}}}openStatusSubmenu(e,t,n){let i=new S.Menu;rt.forEach(r=>{i.addItem(a=>{a.setTitle(r).setChecked(t[0].frontmatter.status===r).onClick(async()=>{await this.plugin.bulkEditService.setStatus(t.map(s=>s.file),r),n&&n(r)})})}),this.showMenuAtAnchor(i,e)}openPrioritySubmenu(e,t,n){let i=new S.Menu;it.forEach(r=>{i.addItem(a=>{a.setTitle(r).setChecked(t[0].frontmatter.priority===r).onClick(async()=>{await this.plugin.bulkEditService.setPriority(t.map(s=>s.file),r),n&&n(r)})})}),this.showMenuAtAnchor(i,e)}openTypeSubmenu(e,t,n){let i=new S.Menu;this.populateFolderMenu(i,t),this.showMenuAtAnchor(i,e)}showMenuAtAnchor(e,t){if(t instanceof MouseEvent){e.showAtMouseEvent(t);return}let n=null;if(t instanceof HTMLElement?n=t:t instanceof Event&&t.target instanceof HTMLElement&&(n=t.target),n&&n.getBoundingClientRect){let i=n.getBoundingClientRect();if(i.width>0&&i.height>0){if(S.Platform.isMobile){let{innerHeight:r,innerWidth:a}=window,s=Math.min(i.left,a-250),l=Math.min(i.bottom,r-300);e.showAtPosition({x:Math.max(0,s),y:Math.max(0,l)})}else e.showAtPosition({x:i.left,y:i.bottom});return}}if(this.app.workspace.activeLeaf){let i=this.app.workspace.activeLeaf.view.contentEl.getBoundingClientRect();e.showAtPosition({x:i.left+100,y:i.top+100})}else e.showAtPosition({x:0,y:0})}openAddTagModal(e,t="tags"){C(`[TPS GCM] openAddTagModal called with ${e.length} entries`),new Pe(this.app,this.getAllKnownTags(),async n=>{let i=e.map(a=>a.file);C(`[TPS GCM] Adding tag '${n}' to ${i.length} files`);let r=await this.plugin.bulkEditService.addTag(i,n,t);r>0&&this.plugin.bulkEditService.showNotice("added",`Tag #${n}`,"",r)}).open()}openRecurrenceModalNative(e){let t=e[0].frontmatter,n=t.scheduled||t.start||t.date||t.day,i=new Date;if(n){let r=window.moment(n,["YYYY-MM-DD HH:mm","YYYY-MM-DD"]).toDate();isNaN(r.getTime())||(i=r)}new _e(this.app,this.getRecurrenceValue(t),i,async r=>{await this.plugin.bulkEditService.setRecurrence(e.map(a=>a.file),r)}).open()}openScheduledModal(e,t="scheduled"){let n=e[0].frontmatter;new He(this.app,n[t]||"",n.timeEstimate||0,n.allDay||!1,async i=>{await this.plugin.bulkEditService.updateScheduledDetails(e.map(r=>r.file),i.date,i.timeEstimate,i.allDay,t)}).open()}openSnoozeModal(e,t="snooze"){let n=this.plugin.settings.snoozeOptions||[];new $e(this.app,e.map(i=>i.file),n,async i=>{let r=window.moment().add(i,"minutes").format("YYYY-MM-DD HH:mm");await this.plugin.bulkEditService.updateFrontmatter(e.map(a=>a.file),{[t]:r}),new S.Notice(`Snoozed for ${i} minutes`)}).open()}getAllKnownTags(){let e=this.app.metadataCache,t=typeof e.getTags=="function"?e.getTags():{};return Object.keys(t||{}).map(n=>n.replace("#",""))}triggerTagSearch(e){let n=`tag:#${e.replace(/^#/,"")}`;try{let i=this.app.internalPlugins.getPluginById("global-search");if(i&&i.instance){i.instance.openGlobalSearch(n);return}let r=this.app.workspace.getLeaf(!1);if(!r)return;r.setViewState({type:"search",state:{query:n}})}catch(i){P("[TPS GCM] Failed to trigger tag search:",i),new S.Notice("Failed to search for tag")}}get app(){return this.plugin.app}buildSpecialPanel(e,t={}){let n=this.createFileEntries(e),i=document.createElement("div");if(i.className="tps-gcm-panel",I(i,l=>{}),e.length>1){let l=document.createElement("div");l.className="tps-gcm-multi-banner",l.textContent=`${e.length} items selected`,i.appendChild(l)}let r=this.plugin.settings.properties||[],a=r.some(l=>(l==null?void 0:l.key)==="title"||(l==null?void 0:l.id)==="title");e.length===1&&!a&&i.appendChild(this.createTitleRow(n)),r.forEach(l=>{if(((l==null?void 0:l.key)==="title"||(l==null?void 0:l.id)==="title")&&e.length===1){i.appendChild(this.createTitleRow(n));return}l.type==="selector"?i.appendChild(this.createSelectorRow(n,l)):l.type==="list"?i.appendChild(this.createListRow(n,l)):l.type==="datetime"?i.appendChild(this.createDatetimeRow(n,l)):l.type==="recurrence"?i.appendChild(this.createRecurrenceRow(n,l)):l.type==="folder"?i.appendChild(this.createTypeRow(n,l)):l.type==="text"?i.appendChild(this.createTextRow(n,l)):l.type==="number"&&i.appendChild(this.createNumberRow(n,l))});let s=this.createFileOperationsRow(n);return s&&i.appendChild(s),i.appendChild(this.createActionsRow(n)),i}createFileOperationsRow(e){let t=this.plugin.settings.systemCommands||[];if(t.length===0)return null;let n=document.createElement("div");n.className="tps-gcm-row tps-gcm-file-ops-row";let i=document.createElement("div");i.className="tps-gcm-file-ops";let r=e[0].file;t.forEach(u=>{let d=vt.find(g=>g.id===u);if(!d)return;let c=document.createElement("button");c.className="tps-gcm-file-op-btn",c.title=d.label;let h=document.createElement("span");h.className="tps-gcm-file-op-icon",(0,S.setIcon)(h,d.icon),c.appendChild(h);let m=document.createElement("span");m.className="tps-gcm-file-op-label",m.textContent=d.label,c.appendChild(m),I(c,async g=>{switch(g.stopPropagation(),d.id){case"open-in-new-tab":await this.app.workspace.getLeaf("tab").openFile(r);break;case"open-in-same-tab":await this.app.workspace.getLeaf(!1).openFile(r);break;case"duplicate":let E=r.path.replace(/\.md$/," copy.md"),H=await this.app.vault.read(r);await this.app.vault.create(E,H),new S.Notice(`Duplicated to ${E}`);break;case"get-relative-path":await navigator.clipboard.writeText(r.path),new S.Notice("Path copied to clipboard");break}}),i.appendChild(c)});let a=document.createElement("button"),s=e.length;a.className="tps-gcm-file-op-btn mod-warning",a.title=s>1?`Delete (${s})`:"Delete";let l=document.createElement("span");l.className="tps-gcm-file-op-icon",(0,S.setIcon)(l,"trash-2"),a.appendChild(l);let p=document.createElement("span");return p.className="tps-gcm-file-op-label",p.textContent=s>1?`Delete (${s})`:"Delete",a.appendChild(p),I(a,()=>{new ft(this.app,s===1?`Delete "${e[0].file.basename}"?`:`Delete ${s} files?`,async()=>{for(let d of e)await this.app.vault.trash(d.file,!0)}).open()}),i.appendChild(a),n.appendChild(i),n}createTitleRow(e){var s;let t=document.createElement("div");t.className="tps-gcm-row tps-gcm-title-row";let n=document.createElement("input");n.type="text";let i=e[0].frontmatter.title;n.value=typeof i=="string"&&i.trim()?i:e[0].file.basename,n.className="tps-gcm-title-input",((s=e[0].file.extension)==null?void 0:s.toLowerCase())==="md"||(n.disabled=!0,n.title="Renaming via this box is disabled for non-markdown files. Use the 'Rename' option in the menu logic below.",n.style.opacity="0.7",n.value=e[0].file.basename);let a=async()=>{var d,c;let l=n.value.trim();if(!(((d=e[0].file.extension)==null?void 0:d.toLowerCase())==="md")||!l)return;if(((c=e[0].file.extension)==null?void 0:c.toLowerCase())==="md"&&e[0].frontmatter.title!==l&&await this.plugin.bulkEditService.updateFrontmatter(e.map(h=>h.file),{title:l}),l!==e[0].file.basename)try{let h=e[0].file.path,m=e[0].file.name,g=h.substring(0,h.length-m.length),y=e[0].file.extension,v=g+l+"."+y;C(`[TPS GCM] Renaming: ${h} -> ${v} (Ext: ${y})`),this.app.vault.getAbstractFileByPath(v)?new S.Notice(`Cannot rename to "${l}": File already exists.`):await this.app.fileManager.renameFile(e[0].file,v)}catch(h){P("Failed to rename file:",h)}};return n.addEventListener("keydown",l=>{l.stopPropagation(),l.key==="Enter"&&n.blur()}),n.addEventListener("blur",l=>{l.stopPropagation(),a()}),I(n,l=>l.stopPropagation()),n.addEventListener("mousedown",l=>l.stopPropagation()),t.appendChild(n),t}createSelectorRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t.label;let r=document.createElement("div");r.className="tps-gcm-value tps-gcm-input-button";let a=e.map(p=>p.frontmatter[t.key]||""),l=new Set(a).size===1?a[0]:"Mixed";return r.textContent=l||"Select...",I(r,p=>{let u=new S.Menu;(t.options||[]).forEach(d=>{u.addItem(c=>{c.setTitle(d).setChecked(l===d).onClick(async()=>{await this.plugin.bulkEditService.updateFrontmatter(e.map(h=>h.file),{[t.key]:d}),r.textContent=d})})}),this.showMenuAtAnchor(u,p)}),r.addEventListener("mousedown",p=>p.stopPropagation()),n.appendChild(i),n.appendChild(r),n}createListRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row tps-gcm-tags-row";let i=document.createElement("label");i.textContent=t.label;let r=document.createElement("div");return r.className="tps-gcm-tags-container tps-gcm-tags-inline",(()=>{var d;r.innerHTML="";let l=(((d=this.app.metadataCache.getFileCache(e[0].file))==null?void 0:d.frontmatter)||{})[t.key];(Array.isArray(l)?l.filter(c=>typeof c=="string"&&c.trim()):typeof l=="string"&&l.trim()?[l]:[]).forEach(c=>{let h=document.createElement("span");h.className="tps-gcm-tag tps-gcm-tag-removable";let m=document.createElement("span");m.className="tps-gcm-tag-text",m.textContent=c,h.appendChild(m);let g=document.createElement("button");g.className="tps-gcm-tag-remove",g.innerHTML="\xD7",g.title=`Remove ${c}`,I(g,async v=>{v.stopPropagation(),await this.plugin.bulkEditService.removeTag(e.map(E=>E.file),c,t.key)}),h.appendChild(g);let y=ln(c);h.style.backgroundColor=`hsla(${y}, 40%, 20%, 0.4)`,h.style.color=`hsl(${y}, 60%, 85%)`,h.style.border=`1px solid hsla(${y}, 40%, 30%, 0.5)`,r.appendChild(h)});let u=document.createElement("button");u.innerHTML="+",u.className="tps-gcm-tag-add",u.title="Add tag",I(u,c=>{this.openAddTagModal(e,t.key)}),u.addEventListener("mousedown",c=>c.stopPropagation()),r.appendChild(u)})(),n.appendChild(i),n.appendChild(r),n}createDatetimeRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t.label;let r=document.createElement("div");r.className="tps-gcm-value tps-gcm-input-button";let a=e[0].frontmatter[t.key],s=this.formatDatetimeDisplay(a);return s?r.textContent=s:(r.textContent="Set date...",r.style.color="var(--text-muted)"),I(r,l=>{this.openScheduledModal(e,t.key)}),r.addEventListener("mousedown",l=>l.stopPropagation()),n.appendChild(i),n.appendChild(r),n}formatDatetimeDisplay(e){if(!e)return"";let t=window.moment;if(t){let i=t(e);if(i.isValid())return e.length<=10||i.format("HH:mm:ss")==="00:00:00"?i.format("ddd, MMM D, YYYY"):i.format("ddd, MMM D, YYYY [at] h:mm A")}let n=new Date(e);return isNaN(n.getTime())?e:n.toLocaleString(void 0,{weekday:"short",month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"})}createTextRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t.label;let r=document.createElement("input");return r.type="text",r.value=e[0].frontmatter[t.key]||"",r.placeholder="Empty",r.addEventListener("change",async()=>{await this.plugin.bulkEditService.updateFrontmatter(e.map(a=>a.file),{[t.key]:r.value})}),I(r,a=>a.stopPropagation()),r.addEventListener("mousedown",a=>a.stopPropagation()),n.appendChild(i),n.appendChild(r),n}createNumberRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t.label;let r=document.createElement("input");return r.type="number",r.value=e[0].frontmatter[t.key]||"",r.addEventListener("change",async()=>{let a=r.value?Number(r.value):null;await this.plugin.bulkEditService.updateFrontmatter(e.map(s=>s.file),{[t.key]:a})}),I(r,a=>a.stopPropagation()),r.addEventListener("mousedown",a=>a.stopPropagation()),n.appendChild(i),n.appendChild(r),n}createRecurrenceRow(e,t){let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t?t.label:"Recurrence";let r=document.createElement("div");r.className="tps-gcm-value tps-gcm-input-button";let a=this.getRecurrenceValue(e[0].frontmatter);return r.textContent=a||"Set recurrence...",a||(r.style.color="var(--text-muted)"),I(r,s=>{this.openRecurrenceModalNative(e)}),r.addEventListener("mousedown",s=>s.stopPropagation()),n.appendChild(i),n.appendChild(r),n}createTypeRow(e,t){var a;let n=document.createElement("div");n.className="tps-gcm-row";let i=document.createElement("label");i.textContent=t?t.label:"Type";let r=document.createElement("div");return r.textContent=((a=e[0].file.parent)==null?void 0:a.path)||"/",r.className="tps-gcm-value tps-gcm-input-button",I(r,s=>{this.openTypeSubmenu(s,e,l=>{})}),r.addEventListener("mousedown",s=>s.stopPropagation()),n.appendChild(i),n.appendChild(r),n}createActionsRow(e){let t=document.createElement("div");t.className="tps-gcm-actions-row";let n=document.createElement("button");return n.textContent="Collapse",I(n,i=>{let r=i.target.closest(".tps-global-context-menu");if(r){r.classList.add("tps-global-context-menu--collapsed");let a=r.querySelector(".tps-gcm-panel");a&&a.classList.add("tps-gcm-panel--hidden");let s=r.querySelector(".tps-gcm-collapse-button");s&&(s.setAttribute("aria-expanded","false"),s.setAttribute("title","Expand inline controls"))}}),t.appendChild(n),t}createStatusRow(e){return this.createSelectorRow(e,{label:"Status",key:"status",options:rt})}createPriorityRow(e){return this.createSelectorRow(e,{label:"Priority",key:"priority",options:it})}createTagsRow(e){return this.createListRow(e,{label:"Tags",key:"tags"})}createScheduledRow(e){return this.createDatetimeRow(e,{label:"Scheduled",key:"scheduled"})}createSummaryHeader(e,t){let i=this.createFileEntries([e])[0].frontmatter,r=document.createElement("div");r.className="tps-global-context-header";let a=document.createElement("div");a.className="tps-gcm-header-left";let s=document.createElement("button");s.type="button",s.className="tps-gcm-collapse-button",s.setAttribute("aria-expanded","false"),s.setAttribute("aria-label","Expand inline menu controls"),a.appendChild(s);let l=document.createElement("span");l.className="tps-gcm-file-title";let p=i.title&&i.title!==e.basename?`${i.title} (${e.basename})`:i.title||e.basename||"Untitled";/^\d{4}-\d{2}-\d{2}$/.test(p)||(p=p.replace(/ \d{4}-\d{2}-\d{2}$/,"")),l.textContent=p,l.setAttribute("aria-label",e.path),a.appendChild(l),r.appendChild(a);let u=this.createHeaderBadges(e,t);return r.appendChild(u),r}createHeaderBadges(e,t){let n=this.createFileEntries([e]),i=n[0].frontmatter,r=document.createElement("div");r.className="tps-gcm-header-right";let a=(u,d,c,h)=>{let m=document.createElement("span");return m.className=`tps-gcm-badge tps-gcm-badge-${d}`,m.textContent=u,I(m,h),m},s=[],l=[];return(this.plugin.settings.properties||[]).forEach(u=>{var d;if(u.showInCollapsed!==!1){if(u.type==="selector"){let c=i[u.key]||(u.options&&u.options.length>0?u.options[0]:"");if(c){let h=a(c,`${u.key} tps-gcm-badge-${c}`,null,m=>{m.stopPropagation();let g=new S.Menu;(u.options||[]).forEach(y=>{g.addItem(v=>{v.setTitle(y).setChecked(i[u.key]===y).onClick(async()=>{await this.plugin.bulkEditService.updateFrontmatter(n.map(E=>E.file),{[u.key]:y}),m.target.textContent=y,m.target.className=`tps-gcm-badge tps-gcm-badge-${u.key} tps-gcm-badge-${y}`})})}),this.showMenuAtAnchor(g,m)});s.push(h)}}else if(u.type==="list"){let c=i[u.key],h=a("+","add-tag",null,m=>{m.stopPropagation(),this.openAddTagModal(n,u.key)});if(l.push(h),c&&c!==!1&&c!==null){let g=(Array.isArray(c)?c:[c]).filter(y=>typeof y=="string"&&y.trim());g.slice(0,4).forEach(y=>{let v=y.replace("#",""),E=a(v,"tag",null,G=>{G.stopPropagation(),this.triggerTagSearch(v)}),H=ln(v);E.style.backgroundColor=`hsla(${H}, 40%, 20%, 0.4)`,E.style.color=`hsl(${H}, 60%, 85%)`,E.style.border=`1px solid hsla(${H}, 40%, 30%, 0.5)`,l.push(E)}),g.length>4&&l.push(a(`+${g.length-4}`,"tag-more",null,y=>{y.stopPropagation(),this.openAddTagModal(n,u.key)}))}}else if(u.type==="recurrence"){let c=this.getRecurrenceValue(i);if(c){let h="Recur";c.includes("FREQ=DAILY")?h="Daily":c.includes("FREQ=WEEKLY")?h="Weekly":c.includes("FREQ=MONTHLY")?h="Monthly":c.includes("FREQ=YEARLY")&&(h="Yearly"),s.push(a(h,"recurrence",null,m=>{m.stopPropagation(),this.openRecurrenceModalNative(n)}))}}else if(u.type==="datetime"){let c=i[u.key];if(c){let h=c.split("T")[0];s.push(a(h,u.key,null,m=>{m.stopPropagation(),this.openScheduledModal(n,u.key)}))}}else if(u.type==="folder"){let c=((d=e.parent)==null?void 0:d.path)||"/";s.push(a(c,"folder",null,h=>{h.stopPropagation(),this.openTypeSubmenu(h,n)}))}}}),s.forEach(u=>r.appendChild(u)),l.forEach(u=>r.appendChild(u)),r}},ft=class extends S.Modal{constructor(e,t,n){super(e),this.message=t,this.onConfirm=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h3",{text:"Confirm delete"}),e.createEl("p",{text:this.message});let t=e.createDiv({cls:"tps-gcm-confirm-buttons"}),n=t.createEl("button",{text:"Cancel"}),i=t.createEl("button",{text:"Delete",cls:"mod-warning"});n.addEventListener("click",()=>this.close()),i.addEventListener("click",async()=>{await this.onConfirm(),this.close()})}onClose(){this.contentEl.empty()}};var ce=require("obsidian");var Be=class{constructor(e){this.menus=new Map;this.handleResize=null;this.handleFocus=null;this.handleWindowResize=null;this.baseHeight=window.innerHeight;this.isCurrentlyHidden=!1;this.plugin=e,this.setupKeyboardDetection()}setupKeyboardDetection(){var e;this.baseHeight=((e=window.visualViewport)==null?void 0:e.height)||window.innerHeight,this.handleResize=(0,ce.debounce)(()=>{var d;let t=window.visualViewport,n=(t==null?void 0:t.height)||window.innerHeight;if(n>this.baseHeight&&(this.baseHeight=n),!(ce.Platform.isMobile||document.body.classList.contains("is-mobile")||document.body.classList.contains("is-phone")||window.innerWidth<768)){this.isCurrentlyHidden&&(document.body.classList.remove("tps-context-hidden-for-keyboard"),this.isCurrentlyHidden=!1);return}let r=this.plugin.app.workspace.getActiveViewOfType(ce.MarkdownView);if((r==null?void 0:r.getMode())==="preview"){this.isCurrentlyHidden&&(document.body.classList.remove("tps-context-hidden-for-keyboard"),this.isCurrentlyHidden=!1);return}let s=document.activeElement;if(s&&s.closest(".tps-global-context-menu")){this.isCurrentlyHidden&&(document.body.classList.remove("tps-context-hidden-for-keyboard"),this.isCurrentlyHidden=!1);return}let l=s&&(s.classList.contains("cm-content")||s.tagName==="TEXTAREA"||s.tagName==="INPUT"||s.isContentEditable||s.closest(".markdown-source-view")||s.closest(".cm-editor")),p=this.baseHeight-n>120,u=!!l||p;u!==this.isCurrentlyHidden&&(this.isCurrentlyHidden=u,document.body.classList.toggle("tps-context-hidden-for-keyboard",u),u&&((d=this.plugin.menuController)==null||d.hideMenu()))},300,!0),window.visualViewport&&window.visualViewport.addEventListener("resize",this.handleResize),this.handleFocus=()=>{this.handleResize&&this.handleResize()},this.handleWindowResize=()=>{this.handleResize&&this.handleResize()},document.addEventListener("focusin",this.handleFocus,!0),document.addEventListener("focusout",this.handleFocus,!0),window.addEventListener("resize",this.handleWindowResize),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",()=>{setTimeout(this.handleResize,200)}))}teardownKeyboardDetection(){this.handleResize&&(window.visualViewport&&window.visualViewport.removeEventListener("resize",this.handleResize),this.handleResize=null),this.handleFocus&&(document.removeEventListener("focusin",this.handleFocus,!0),document.removeEventListener("focusout",this.handleFocus,!0),this.handleFocus=null),this.handleWindowResize&&(window.removeEventListener("resize",this.handleWindowResize),this.handleWindowResize=null),this.isCurrentlyHidden=!1,document.body.classList.remove("tps-context-hidden-for-keyboard")}ensureMenus(){var t,n;if(!((n=(t=this.plugin)==null?void 0:t.app)!=null&&n.workspace))return;let e=new Set;this.plugin.app.workspace.getLeavesOfType("markdown").forEach(i=>{let r=i.view;!r||!r.file||(e.add(r),this.ensureReadingMenu(r),this.ensureLiveMenu(r))});for(let i of Array.from(this.menus.keys()))e.has(i)||this.cleanup(i)}ensureReadingMenu(e){var r,a;if(e.getMode()!=="preview"){this.removeReadingMenu(e);return}let t=(r=e.contentEl)==null?void 0:r.querySelector(".markdown-preview-sizer");if(!t){this.removeReadingMenu(e);return}let n=this.menus.get(e)||{};if(n.reading&&n.filePath!==((a=e.file)==null?void 0:a.path))this.removeReadingMenu(e);else if(n.reading&&t.contains(n.reading))return;this.removeReadingMenu(e);let i=this.createPersistentMenu(e,"reading");if(i){let s=t.querySelector(".inline-title");s?s.after(i):t.prepend(i),n.reading=i,n.filePath=e.file.path,this.menus.set(e,n)}}ensureLiveMenu(e){var r,a;if(e.getMode()!=="source"){this.removeLiveMenu(e);return}let t=(r=e.contentEl)==null?void 0:r.querySelector(".markdown-source-view");if(!t||!t.classList.contains("is-live-preview")){this.removeLiveMenu(e);return}let n=this.menus.get(e)||{};if(n.live&&n.filePath!==((a=e.file)==null?void 0:a.path))this.removeLiveMenu(e);else if(n.live&&t.contains(n.live))return;this.removeLiveMenu(e);let i=this.createPersistentMenu(e,"live");i&&(t.appendChild(i),n.live=i,n.filePath=e.file.path,this.menus.set(e,n))}createPersistentMenu(e,t){let n=e.file;if(!n)return null;let i=document.createElement("div");i.className=`tps-global-context-menu tps-global-context-menu--persistent tps-global-context-menu--${t} tps-global-context-menu--collapsed`,i.setAttribute("role","presentation");let r=this.plugin.menuController.createSummaryHeader(n,e.leaf),a=r.querySelector(".tps-gcm-collapse-button"),s=t==="live"&&ce.Platform.isMobile,l=null,p=()=>{if(!l)try{l=this.plugin.buildSpecialPanel(n,{recurrenceRoot:i,closeAfterRecurrence:!1}),l&&i.appendChild(l)}catch(h){console.error("[TPS GCM] Failed to build persistent panel:",h)}},u=h=>{a&&(a.setAttribute("aria-expanded",h.toString()),a.setAttribute("title",h?"Collapse inline controls":"Expand inline controls"))},d=()=>{let h=i.classList.toggle("tps-global-context-menu--collapsed");h||p(),l&&l.classList.toggle("tps-gcm-panel--hidden",h),u(!h)};return I(r,h=>{h.stopPropagation(),h.preventDefault(),d()}),a&&I(a,h=>{d()}),u(!1),i.appendChild(r),s||p(),i}removeReadingMenu(e){let t=this.menus.get(e);if(t!=null&&t.reading){if(t.reading.remove(),t.reading=null,!t.live){this.menus.delete(e);return}this.menus.set(e,t)}}removeLiveMenu(e){let t=this.menus.get(e);if(t!=null&&t.live){if(t.live.remove(),t.live=null,!t.reading){this.menus.delete(e);return}this.menus.set(e,t)}}cleanup(e){var n,i;let t=this.menus.get(e);t&&((n=t.reading)==null||n.remove(),(i=t.live)==null||i.remove(),this.menus.delete(e))}refreshMenusForFile(e){var t;for(let[n,i]of this.menus.entries())if(((t=n.file)==null?void 0:t.path)===e.path){if(i.live){let r=i.live.querySelector(".tps-gcm-header-right");if(r){let a=this.plugin.menuController.createHeaderBadges(e,n.leaf);r.innerHTML="",r.appendChild(a)}}if(i.reading){let r=i.reading.querySelector(".tps-gcm-header-right");if(r){let a=this.plugin.menuController.createHeaderBadges(e,n.leaf);r.innerHTML="",r.appendChild(a)}}}}detach(){this.teardownKeyboardDetection();for(let e of Array.from(this.menus.keys()))this.cleanup(e)}};var k=require("obsidian"),Ve=class extends k.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty();let t=(d,c=!1)=>{let h=e.createEl("details",{cls:"tps-gcm-settings-group"});h.style.border="1px solid var(--background-modifier-border)",h.style.borderRadius="6px",h.style.padding="10px",h.style.marginBottom="10px",c&&h.setAttr("open","");let m=h.createEl("summary",{text:d});return m.style.fontWeight="bold",m.style.cursor="pointer",m.style.marginBottom="10px",h.createDiv({cls:"tps-gcm-settings-group-content"})};e.createEl("h2",{text:"TPS Global Context Menu"}),e.createEl("p",{text:"Define a single context menu that can be reused throughout the vault. Menu items accept JSON definitions to keep the configuration portable and extendable."});let n=t("General Settings",!0);new k.Setting(n).setName("Enable console logging").setDesc("Show debug logs in the developer console.").addToggle(d=>d.setValue(this.plugin.settings.enableLogging).onChange(async c=>{this.plugin.settings.enableLogging=c,await this.plugin.saveSettings()})),new k.Setting(n).setName("Strict Context Menu Mode").setDesc("Completely replace the native context menu with this custom one. Prevents duplicates and gives full control.").addToggle(d=>d.setValue(this.plugin.settings.enableStrictMode).onChange(async c=>{this.plugin.settings.enableStrictMode=c,await this.plugin.saveSettings()})),new k.Setting(n).setName("Enable in specific views").setDesc("Toggle where the custom context menu should appear.").addToggle(d=>d.setTooltip("Live Preview & Editor").setValue(this.plugin.settings.enableInLivePreview).onChange(async c=>{this.plugin.settings.enableInLivePreview=c,await this.plugin.saveSettings()})).addToggle(d=>d.setTooltip("Reading View & Popovers").setValue(this.plugin.settings.enableInPreview).onChange(async c=>{this.plugin.settings.enableInPreview=c,await this.plugin.saveSettings()})).addToggle(d=>d.setTooltip("Side Panels (Explorer, etc)").setValue(this.plugin.settings.enableInSidePanels).onChange(async c=>{this.plugin.settings.enableInSidePanels=c,await this.plugin.saveSettings()}));let i=t("View Mode Settings",!1);new k.Setting(i).setName("Enable View Mode Switching").setDesc("Automatically switch between Source, Live Preview, and Reading modes based on frontmatter.").addToggle(d=>d.setValue(this.plugin.settings.enableViewModeSwitching).onChange(async c=>{this.plugin.settings.enableViewModeSwitching=c,await this.plugin.saveSettings()})),new k.Setting(i).setName("Frontmatter Key").setDesc('The frontmatter property used to determine view mode (e.g. "viewmode")').addText(d=>d.setValue(this.plugin.settings.viewModeFrontmatterKey).setPlaceholder("viewmode").onChange(async c=>{this.plugin.settings.viewModeFrontmatterKey=c||"viewmode",await this.plugin.saveSettings()})),new k.Setting(i).setName("Ignored Folders").setDesc("One path per line. Files in these folders will generally keep their current view mode.").addTextArea(d=>{d.setPlaceholder(`Bases
Atlas/Views`).setValue(this.plugin.settings.viewModeIgnoredFolders||"").onChange(async c=>{this.plugin.settings.viewModeIgnoredFolders=c,await this.plugin.saveSettings()}),d.inputEl.rows=3,d.inputEl.cols=30}),new k.Setting(i).setName("View Mode Rules").setDesc("Define specific statuses that should trigger specific view modes.").addButton(d=>d.setButtonText("Add Rule").setCta().onClick(async()=>{this.plugin.settings.viewModeRules||(this.plugin.settings.viewModeRules=[]),this.plugin.settings.viewModeRules.push({key:"status",value:"",mode:"reading"}),await this.plugin.saveSettings(),this.display()})),this.plugin.settings.viewModeRules&&this.plugin.settings.viewModeRules.forEach((d,c)=>{let h=i.createDiv();h.addClass("tps-gcm-viewmode-rule"),h.style.display="flex",h.style.alignItems="center",h.style.gap="10px",h.style.marginBottom="10px",h.style.paddingLeft="20px",new k.Setting(h).setClass("tps-gcm-no-border").addText(m=>m.setPlaceholder("Key").setValue(d.key).onChange(async g=>{d.key=g,await this.plugin.saveSettings()})),h.createSpan({text:"="}),new k.Setting(h).setClass("tps-gcm-no-border").addText(m=>m.setPlaceholder("Value").setValue(d.value).onChange(async g=>{d.value=g,await this.plugin.saveSettings()})),h.createSpan({text:"\u2192"}),new k.Setting(h).setClass("tps-gcm-no-border").addDropdown(m=>m.addOption("reading","Reading").addOption("source","Source").addOption("live","Live").setValue(d.mode).onChange(async g=>{d.mode=g,await this.plugin.saveSettings()})),new k.Setting(h).setClass("tps-gcm-no-border").addButton(m=>m.setIcon("trash").onClick(async()=>{this.plugin.settings.viewModeRules.splice(c,1),await this.plugin.saveSettings(),this.display()}))});let r=t("Menu Configuration",!1);r.createEl("h4",{text:"System Commands",attr:{style:"margin-bottom: 0.5em;"}});let a=[{id:"open-in-new-tab",label:"New Tab"},{id:"open-to-right",label:"To Right"},{id:"open-in-new-window",label:"New Window"},{id:"rename",label:"Rename"},{id:"move-file",label:"Move"},{id:"duplicate",label:"Duplicate"},{id:"copy-url",label:"Copy URL"},{id:"reveal-finder",label:"Reveal File"}],s=r.createDiv();s.style.display="grid",s.style.gridTemplateColumns="1fr 1fr",s.style.gap="10px",a.forEach(d=>{let c=s.createDiv();c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="space-between";let h=c.createSpan({text:d.label}),m=new k.Setting(c).setClass("tps-gcm-compact-toggle").addToggle(g=>g.setValue((this.plugin.settings.systemCommands||[]).includes(d.id)).onChange(async y=>{let v=this.plugin.settings.systemCommands||[];y&&!v.includes(d.id)?v.push(d.id):y||(v=v.filter(E=>E!==d.id)),this.plugin.settings.systemCommands=v,await this.plugin.saveSettings()}))}),r.createEl("h4",{text:"Custom Properties",attr:{style:"margin-top: 1.5em; margin-bottom: 0.5em;"}});let l=r.createDiv();this.renderProperties(l),new k.Setting(r).addButton(d=>d.setButtonText("Add Property").setCta().onClick(()=>{this.plugin.settings.properties.push({id:Date.now().toString(),label:"New Property",key:"new_prop",type:"text"}),this.plugin.saveSettings(),this.renderProperties(l)}));let p=t("Automation & Features",!1);if(p.createEl("h4",{text:"Checklists & Tasks"}),new k.Setting(p).setName("Check pending items").setDesc("Warn on completion if items unchecked").addToggle(d=>d.setValue(this.plugin.settings.checkOpenChecklistItems).onChange(async c=>{this.plugin.settings.checkOpenChecklistItems=c,await this.plugin.saveSettings()})),new k.Setting(p).setName("Shift+Click Cancel").setDesc("Mark as [-] instead of [x]").addToggle(d=>d.setValue(this.plugin.settings.enableShiftClickCancel).onChange(async c=>{this.plugin.settings.enableShiftClickCancel=c,await this.plugin.saveSettings()})),new k.Setting(p).setName("Task Recurrence").setDesc("Auto-create next recurring task").addToggle(d=>d.setValue(this.plugin.settings.enableRecurrence).onChange(async c=>{this.plugin.settings.enableRecurrence=c,await this.plugin.saveSettings()})),this.plugin.settings.enableRecurrence){let d=p.createDiv({cls:"tps-gcm-sub-settings"});d.style.paddingLeft="15px",d.style.borderLeft="2px solid var(--background-modifier-border)",new k.Setting(d).setName("Completion Triggers").setDesc("Statuses that trigger recurrence").addText(c=>c.setValue((this.plugin.settings.recurrenceCompletionStatuses||[]).join(", ")).onChange(async h=>{this.plugin.settings.recurrenceCompletionStatuses=h.split(",").map(m=>m.trim()).filter(Boolean),await this.plugin.saveSettings()})),new k.Setting(d).setName("Prompt on Edit").setDesc("Ask to update future instances").addToggle(c=>c.setValue(this.plugin.settings.promptOnRecurrenceEdit).onChange(async h=>{this.plugin.settings.promptOnRecurrenceEdit=h,await this.plugin.saveSettings()}))}p.createEl("h4",{text:"File Naming",attr:{style:"margin-top: 1.5em;"}}),new k.Setting(p).setName("Auto-Rename Files").setDesc("Rename based on title/date criteria").addToggle(d=>d.setValue(this.plugin.settings.enableAutoRename).onChange(async c=>{this.plugin.settings.enableAutoRename=c,await this.plugin.saveSettings()})),new k.Setting(p).setName("Auto-Save Folder").setDesc("Save path to frontmatter").addToggle(d=>d.setValue(this.plugin.settings.autoSaveFolderPath).onChange(async c=>{this.plugin.settings.autoSaveFolderPath=c,await this.plugin.saveSettings()})),p.createEl("h4",{text:"Snooze Options",attr:{style:"margin-top: 1.5em;"}});let u=p.createDiv();this.renderSnoozeOptions(u),new k.Setting(p).addButton(d=>d.setButtonText("Add Option").onClick(async()=>{this.plugin.settings.snoozeOptions||(this.plugin.settings.snoozeOptions=[]),this.plugin.settings.snoozeOptions.push({label:"15 Mins",minutes:15}),await this.plugin.saveSettings(),this.renderSnoozeOptions(u)})),e.createEl("p",{text:'Note: enable "Strict Context Menu Mode" to remove the native menu items completely.',cls:"setting-item-description",attr:{style:"margin-top: 20px; text-align: center; opacity: 0.7;"}})}renderProperties(e){e.empty(),this.plugin.settings.properties||(this.plugin.settings.properties=[]),this.plugin.settings.properties.forEach((t,n)=>{let i=e.createDiv("tps-gcm-setting-item");i.style.border="1px solid var(--background-modifier-border)",i.style.padding="10px",i.style.marginBottom="10px",i.style.borderRadius="6px",i.style.display="flex",i.style.flexDirection="column",i.style.gap="10px";let r=i.createDiv();r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.createEl("strong",{text:t.label||"Unnamed Property"});let a=r.createDiv();if(n>0){let p=a.createEl("button",{text:"\u2191"});p.onclick=async()=>{let u=this.plugin.settings.properties[n-1];this.plugin.settings.properties[n-1]=t,this.plugin.settings.properties[n]=u,await this.plugin.saveSettings(),this.renderProperties(e)}}if(n<this.plugin.settings.properties.length-1){let p=a.createEl("button",{text:"\u2193"});p.onclick=async()=>{let u=this.plugin.settings.properties[n+1];this.plugin.settings.properties[n+1]=t,this.plugin.settings.properties[n]=u,await this.plugin.saveSettings(),this.renderProperties(e)}}let s=a.createEl("button",{text:"Delete"});s.onclick=async()=>{this.plugin.settings.properties.splice(n,1),await this.plugin.saveSettings(),this.renderProperties(e)};let l=i.createDiv();if(l.style.display="grid",l.style.gridTemplateColumns="1fr 1fr",l.style.gap="10px",new k.Setting(l).setName("Label").addText(p=>p.setValue(t.label).onChange(async u=>{t.label=u,await this.plugin.saveSettings()})),new k.Setting(l).setName("Frontmatter Key").addText(p=>p.setValue(t.key).onChange(async u=>{t.key=u,await this.plugin.saveSettings()})),new k.Setting(l).setName("Type").addDropdown(p=>p.addOption("text","Text").addOption("number","Number").addOption("datetime","Date/Time").addOption("selector","Selector (Dropdown)").addOption("list","List (Tags)").addOption("recurrence","Recurrence").addOption("folder","Type (Folder)").addOption("snooze","Snooze").setValue(t.type).onChange(async u=>{t.type=u,await this.plugin.saveSettings(),this.renderProperties(e)})),new k.Setting(l).setName("Icon").addText(p=>p.setValue(t.icon||"").setPlaceholder("lucide-icon-name").onChange(async u=>{t.icon=u,await this.plugin.saveSettings()})),new k.Setting(l).setName("Show in Collapsed View").setDesc("Show this property in the inline header when collapsed").addToggle(p=>p.setValue(t.showInCollapsed!==!1).onChange(async u=>{t.showInCollapsed=u,await this.plugin.saveSettings()})),new k.Setting(l).setName("Show in Context Menu").setDesc("Show this property in the right-click context menu").addToggle(p=>p.setValue(t.showInContextMenu!==!1).onChange(async u=>{t.showInContextMenu=u,await this.plugin.saveSettings()})),t.type==="selector"){let p=i.createDiv();p.style.gridColumn="1 / -1",new k.Setting(p).setName("Options (comma separated)").addTextArea(u=>u.setValue((t.options||[]).join(", ")).onChange(async d=>{t.options=d.split(",").map(c=>c.trim()).filter(c=>c),await this.plugin.saveSettings()}))}})}renderSnoozeOptions(e){e.empty(),this.plugin.settings.snoozeOptions||(this.plugin.settings.snoozeOptions=[]),this.plugin.settings.snoozeOptions.forEach((t,n)=>{let i=e.createDiv();i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",i.style.marginBottom="10px",new k.Setting(i).setClass("tps-gcm-no-border").addText(r=>r.setPlaceholder("Label (e.g. 15m)").setValue(t.label).onChange(async a=>{t.label=a,await this.plugin.saveSettings()})),new k.Setting(i).setClass("tps-gcm-no-border").addText(r=>r.setPlaceholder("Minutes").setValue(String(t.minutes)).onChange(async a=>{let s=parseInt(a);isNaN(s)||(t.minutes=s,await this.plugin.saveSettings())})),new k.Setting(i).setClass("tps-gcm-no-border").addButton(r=>r.setIcon("trash").onClick(async()=>{this.plugin.settings.snoozeOptions.splice(n,1),await this.plugin.saveSettings(),this.renderSnoozeOptions(e)}))})}};var ye=require("obsidian");var ue=require("obsidian"),Ge=class extends ue.Modal{constructor(e,t,n){super(e),this.items=t,this.onResult=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Incomplete Checklist Items"}),e.createEl("p",{text:"This note has open checklist items. What would you like to do?"});let t=e.createDiv("tps-gcm-checklist-preview");t.style.maxHeight="200px",t.style.overflowY="auto",t.style.background="var(--background-secondary)",t.style.padding="10px",t.style.borderRadius="4px",t.style.marginBottom="20px",t.style.fontFamily="var(--font-monospace)",t.style.fontSize="0.9em",this.items.slice(0,10).forEach(i=>{t.createDiv({text:i})}),this.items.length>10&&t.createDiv({text:`...and ${this.items.length-10} more`,attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 5px;"}});let n=e.createDiv("tps-gcm-modal-buttons");n.style.display="flex",n.style.flexDirection="column",n.style.gap="10px",new ue.Setting(n).setClass("tps-gcm-no-border").addButton(i=>i.setButtonText("Open Note").onClick(()=>{this.onResult("open"),this.close()})),new ue.Setting(n).setClass("tps-gcm-no-border").addButton(i=>i.setButtonText("Complete Items (- [x])").setCta().onClick(()=>{this.onResult("complete"),this.close()})),new ue.Setting(n).setClass("tps-gcm-no-border").addButton(i=>i.setButtonText("Mark as Question (- [?])").onClick(()=>{this.onResult("progress"),this.close()})),new ue.Setting(n).setClass("tps-gcm-no-border").addButton(i=>i.setButtonText("Ignore Items & Complete Note").setWarning().onClick(()=>{this.onResult("ignore"),this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};var Ke=class{constructor(e){this.recurrenceCreationInProgress=new Set;this.plugin=e}async applyToFiles(e,t){var i,r;let n=0;for(let a of e)try{if(((i=a.extension)==null?void 0:i.toLowerCase())!=="md")continue;(r=this.plugin.recurrenceService)==null||r.markFileAsModified(a.path),await this.plugin.app.fileManager.processFrontMatter(a,s=>{t(s,a)}),n++}catch(s){P(`[TPS GCM] Failed to update ${a.path}:`,s)}return setTimeout(()=>{var a;for(let s of e)(a=this.plugin.persistentMenuManager)==null||a.refreshMenusForFile(s)},100),n}async updateFrontmatter(e,t){if(this.plugin.settings.enableRecurrence&&this.plugin.settings.promptOnRecurrenceEdit)for(let n of e){let i=this.plugin.app.metadataCache.getFileCache(n),r=i==null?void 0:i.frontmatter;if(r&&(r.recurrenceRule||r.recurrence)){if(r.status==="complete"||r.status==="wont-do")continue;let a=Object.keys(t);if(a.includes("status"))continue;let s="updating";if(a.includes("scheduled")?s="changing the scheduled time of":a.includes("priority")?s="changing the priority of":a.some(p=>p.includes("tag"))&&(s="modifying tags on"),await this.plugin.recurrenceService.promptForFrontmatterChange(n,s)==="cancel")return 0}}return this.applyToFiles(e,n=>{for(let i in t)t[i]===null||t[i]===void 0?delete n[i]:n[i]=t[i]})}async setStatus(e,t){var i;let n=(i=this.plugin.settings.recurrenceCompletionStatuses)!=null&&i.length?this.plugin.settings.recurrenceCompletionStatuses:["complete","wont-do"];if(this.plugin.settings.checkOpenChecklistItems&&t==="complete"&&e.length===1){let r=e[0],a=await this.scanChecklistItems(r);if(a.length>0){let s=await new Promise(l=>{new Ge(this.plugin.app,a,p=>{l(p)}).open()});if(s==="cancel")return 0;if(s==="open"){let l=this.plugin.app.workspace.getLeaf(!1);return l&&await l.openFile(r),0}s==="complete"?await this.updateChecklistItems(r,"complete"):s==="progress"&&await this.updateChecklistItems(r,"progress")}}if(this.plugin.settings.enableRecurrence&&n.includes(t))for(let r of e){let a=this.plugin.app.metadataCache.getFileCache(r),s=a==null?void 0:a.frontmatter;if(s&&(s.recurrenceRule||s.recurrence)){let l=s.status||null;await this.createNextRecurrenceInstance(r,s,l)||await this.clearRecurrenceRule(r)}}return this.updateFrontmatter(e,{status:t})}async setPriority(e,t){return this.updateFrontmatter(e,{priority:t})}async addTag(e,t,n="tags"){if(this.plugin.settings.enableRecurrence&&this.plugin.settings.promptOnRecurrenceEdit)for(let i of e){let r=this.plugin.app.metadataCache.getFileCache(i),a=r==null?void 0:r.frontmatter;if(a&&(a.recurrenceRule||a.recurrence)&&a.status!=="complete"&&a.status!=="wont-do"){if(await this.plugin.recurrenceService.promptForFrontmatterChange(i,`adding tag "${t}" to`)==="cancel")return 0;break}}return this.applyToFiles(e,i=>{let r=i[n]||[];Array.isArray(r)||(r=[r].filter(a=>a)),r.includes(t)||(r.push(t),i[n]=r)})}async removeTag(e,t,n="tags"){if(this.plugin.settings.enableRecurrence&&this.plugin.settings.promptOnRecurrenceEdit)for(let i of e){let r=this.plugin.app.metadataCache.getFileCache(i),a=r==null?void 0:r.frontmatter;if(a&&(a.recurrenceRule||a.recurrence)&&a.status!=="complete"&&a.status!=="wont-do"){if(await this.plugin.recurrenceService.promptForFrontmatterChange(i,`removing tag "${t}" from`)==="cancel")return 0;break}}return this.applyToFiles(e,i=>{if(!i[n])return;let r=Array.isArray(i[n])?i[n]:[i[n]];i[n]=r.filter(a=>a!==t)})}async setRecurrence(e,t){var i;let n=await this.applyToFiles(e,r=>{t?(r.recurrenceRule=t,delete r.recurrence):(delete r.recurrenceRule,delete r.recurrence)});if(t&&this.plugin.settings.enableRecurrence){let r=(i=this.plugin.settings.recurrenceCompletionStatuses)!=null&&i.length?this.plugin.settings.recurrenceCompletionStatuses:["complete","wont-do"];for(let a of e)setTimeout(async()=>{let s=this.plugin.app.metadataCache.getFileCache(a),l=s==null?void 0:s.frontmatter;l&&r.includes(l.status)&&await this.createNextRecurrenceInstance(a,l)},200)}return n}async setScheduled(e,t){return this.applyToFiles(e,n=>{t?n.scheduled=t:delete n.scheduled})}async updateScheduledDetails(e,t,n,i,r="scheduled"){return this.applyToFiles(e,a=>{t?a[r]=t:delete a[r],n!=null&&!isNaN(n)?a.timeEstimate=n:delete a.timeEstimate,i?a.allDay=!0:delete a.allDay})}showNotice(e,t,n,i){let r=`${t} ${n} on ${i} file${i!==1?"s":""}`;new ye.Notice(r)}getNextOccurrence(e,t){try{let n=t?new Date(t):new Date,i=b.parseString(e);return i.dtstart=n,new b(i).after(n,!1)}catch(n){return P("[TPS GCM] Failed to calculate next recurrence:",n),null}}async createNextRecurrenceInstance(e,t,n){if(this.recurrenceCreationInProgress.has(e.path))return j("[TPS GCM] Recurrence creation already in progress:",e.path),!0;this.recurrenceCreationInProgress.add(e.path);try{let i=t.recurrenceRule||t.recurrence;if(!i)return!1;let r=t.scheduled,a=this.getNextOccurrence(i,r);if(!a)return j("[TPS GCM] Could not calculate next recurrence date"),await this.clearRecurrenceRule(e),!0;let s=e.basename.replace(/ \d{4}-\d{2}-\d{2}$/,""),l=window.moment(a).format("YYYY-MM-DD"),p=`${s} ${l}.md`,u=e.parent?`${e.parent.path}/${p}`:p;if(await this.plugin.app.vault.adapter.exists(u))return j("[TPS GCM] Next recurrence already exists, skipping creation:",u),await this.clearRecurrenceRule(e),!0;let d=await this.plugin.app.vault.read(e);await this.plugin.app.vault.create(u,d);let c=this.plugin.app.vault.getAbstractFileByPath(u);if(!(c instanceof ye.TFile))return P("[TPS GCM] Could not get newly created file"),!1;let h=window.moment(a).format("YYYY-MM-DDTHH:mm:ss"),m=this.plugin.settings.recurrenceDefaultStatus||"open";return await this.plugin.app.fileManager.processFrontMatter(c,g=>{g.scheduled=h,g.title=s,g.status=m}),await this.clearRecurrenceRule(e),new ye.Notice(`Created next recurrence: ${p}`),!0}catch(i){return P("[TPS GCM] Failed to create next recurrence instance:",i),new ye.Notice("Failed to create next recurrence instance"),!1}finally{this.recurrenceCreationInProgress.delete(e.path)}}async checkMissingRecurrences(){var i;if(!this.plugin.settings.enableRecurrence)return;this.plugin.app.metadataCache.on;let e=this.plugin.app.vault.getMarkdownFiles(),t=0,n=(i=this.plugin.settings.recurrenceCompletionStatuses)!=null&&i.length?this.plugin.settings.recurrenceCompletionStatuses:["complete","wont-do"];for(let r of e){let a=this.plugin.app.metadataCache.getFileCache(r),s=a==null?void 0:a.frontmatter;if(!s)continue;let l=s.recurrenceRule||s.recurrence,p=n.includes(s.status);l&&p&&await this.createNextRecurrenceInstance(r,s)&&t++}t>0&&C(`[TPS GCM] Healed ${t} recurring event chains.`)}async clearRecurrenceRule(e){await this.plugin.app.fileManager.processFrontMatter(e,t=>{delete t.recurrenceRule,delete t.recurrence})}stringifyFrontmatter(e){let t=[];for(let n in e){let i=e[n];if(i!=null)if(Array.isArray(i))t.push(`${n}:`),i.forEach(r=>{t.push(`  - ${r}`)});else{if(typeof i=="object")continue;typeof i=="string"?i.includes(":")||i.includes("#")||i.includes(`
`)?t.push(`${n}: "${i.replace(/"/g,'\\"')}"`):t.push(`${n}: ${i}`):t.push(`${n}: ${i}`)}}return t.join(`
`)+`
`}async scanChecklistItems(e){let n=(await this.plugin.app.vault.read(e)).split(`
`),i=[],r=/^\s*-\s*\[ \]\s+(.*)$/;for(let a of n){let s=a.match(r);s&&i.push(s[1].trim())}return i}async updateChecklistItems(e,t){let n=await this.plugin.app.vault.read(e);t==="complete"?n=n.replace(/^(\s*-\s*)\[ \]/gm,"$1[x]"):t==="progress"&&(n=n.replace(/^(\s*-\s*)\[ \]/gm,"$1[?]")),await this.plugin.app.vault.modify(e,n)}};var de=require("obsidian"),gt=class{constructor(e=5){this.modifiedFiles=new Map;this.sessionDuration=e*60*1e3}updateDuration(e){this.sessionDuration=e*60*1e3}markAsModified(e){this.modifiedFiles.set(e,Date.now())}wasRecentlyModified(e){let t=this.modifiedFiles.get(e);return t?Date.now()-t>this.sessionDuration?(this.modifiedFiles.delete(e),!1):!0:!1}clear(){this.modifiedFiles.clear()}},qe=class{constructor(e){this.contentChangeListeners=new Map;this.activePrompts=new Set;this.activeSplits=new Set;this.plugin=e,this.sessionTracker=new gt(e.settings.recurrencePromptTimeout)}updateSettings(){this.sessionTracker.updateDuration(this.plugin.settings.recurrencePromptTimeout)}markFileAsModified(e){this.sessionTracker.markAsModified(e)}setup(){this.cleanup(),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",async e=>{let t=this.plugin.app.workspace.getActiveFile();t instanceof de.TFile&&t.extension==="md"&&await this.handleFileFocus(t)})),this.plugin.registerEvent(this.plugin.app.vault.on("modify",async e=>{e instanceof de.TFile&&e.extension==="md"&&await this.handleFileModification(e)}))}cleanup(){this.sessionTracker.clear()}async handleFileFocus(e){if(this.sessionTracker.wasRecentlyModified(e.path))return;let t=this.plugin.app.metadataCache.getFileCache(e),n=t==null?void 0:t.frontmatter;!n||!n.recurrenceRule&&!n.recurrence||n.status==="complete"||n.status==="wont-do"||await this.promptOnFocus(e)}async promptOnFocus(e){let t=await this.promptUser("focus",e);t==="update-all"?this.sessionTracker.markAsModified(e.path):t==="split"?(await this.splitInstance(e),this.sessionTracker.markAsModified(e.path)):t==="cancel"&&this.sessionTracker.markAsModified(e.path)}async handleFileModification(e){if(this.sessionTracker.wasRecentlyModified(e.path))return;let t=this.plugin.app.metadataCache.getFileCache(e),n=t==null?void 0:t.frontmatter;!n||!n.recurrenceRule&&!n.recurrence||n.status==="complete"||n.status==="wont-do"||await this.promptForContentChange(e)}async promptForContentChange(e){let t=await this.promptUser("editing",e);t==="update-all"?this.sessionTracker.markAsModified(e.path):t==="split"?(await this.splitInstance(e),this.sessionTracker.markAsModified(e.path)):this.sessionTracker.markAsModified(e.path)}async promptForFrontmatterChange(e,t){if(this.sessionTracker.wasRecentlyModified(e.path))return"update-all";let n=await this.promptUser(t,e);return n==="update-all"?this.sessionTracker.markAsModified(e.path):n==="split"&&(await this.splitInstance(e),this.sessionTracker.markAsModified(e.path)),n}async splitInstance(e){if(this.activeSplits.has(e.path))return;this.activeSplits.add(e.path);let t=this.plugin.app.metadataCache.getFileCache(e),n=t==null?void 0:t.frontmatter;if(!n){this.activeSplits.delete(e.path);return}try{await this.plugin.bulkEditService.createNextRecurrenceInstance(e,n),await this.plugin.bulkEditService.updateFrontmatter([e],{recurrenceRule:null,recurrence:null}),new de.Notice("Split recurring event. Next instance created.")}finally{this.activeSplits.delete(e.path)}}promptUser(e,t){return new Promise(n=>{if(this.activePrompts.has(t.path)){n("cancel");return}this.activePrompts.add(t.path),new yt(this.plugin.app,e,i=>{this.activePrompts.delete(t.path),n(i)}).open()})}},yt=class extends de.Modal{constructor(e,t,n){super(e),this.changeType=t,this.resolve=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("tps-recurrence-update-modal");let t="Update Recurring Task?",n="You are editing a recurring task. How should this change apply?",i="Edit Series (All Future)",r="Changes apply to this and all future instances.",a="Edit Only This Instance",s="This becomes a standalone task. A new recurring instance is generated for the schedule.";this.changeType==="focus"&&(t="Recurring Task Detected",n="You have opened a recurring task. What would you like to do?",i="View/Edit This Series",r="Enter the note to view or make changes to the existing series.",a="Create Next Instance Now",s="Mark this instance as effectively complete/split and generate the next occurrence immediately."),e.createEl("h3",{text:t});let l=e.createEl("p",{text:n});l.style.marginBottom="16px",l.style.color="var(--text-muted)";let p=e.createEl("div");p.style.display="flex",p.style.flexDirection="column",p.style.gap="8px",this.createOption(p,i,r,()=>this.resolveAndClose("update-all")),this.createOption(p,a,s,()=>this.resolveAndClose("split"));let u=e.createEl("button",{text:"Cancel"});u.style.marginTop="10px",u.style.width="100%",u.addEventListener("click",()=>this.resolveAndClose("cancel"))}createOption(e,t,n,i){let r=e.createDiv("tps-recurrence-option");r.style.padding="10px",r.style.border="1px solid var(--background-modifier-border)",r.style.borderRadius="6px",r.style.cursor="pointer";let a=r.createDiv();a.style.fontWeight="bold",a.textContent=t;let s=r.createDiv();s.style.fontSize="0.9em",s.style.color="var(--text-muted)",s.textContent=n,r.addEventListener("click",i),r.addEventListener("mouseenter",()=>r.style.backgroundColor="var(--background-modifier-hover)"),r.addEventListener("mouseleave",()=>r.style.backgroundColor="transparent"),e.appendChild(r)}resolveAndClose(e){this.resolve(e),this.close()}onClose(){this.contentEl.empty()}};var Ze=class{constructor(e){this.processingFiles=new Set;this.plugin=e}async processFileOnOpen(e){var t;if(!this.processingFiles.has(e.path)){this.processingFiles.add(e.path);try{let n=this.plugin.app.metadataCache.getFileCache(e),i=n==null?void 0:n.frontmatter;if(!i){this.processingFiles.delete(e.path);return}let r=!1,a={};if(this.plugin.settings.autoSaveFolderPath){let s=((t=e.parent)==null?void 0:t.path)||"/";i.folderPath!==s&&(a.folderPath=s,r=!0)}r&&await this.plugin.app.fileManager.processFrontMatter(e,s=>{Object.assign(s,a)}),this.plugin.settings.enableAutoRename&&await this.updateFilenameIfNeeded(e)}catch(n){P("[TPS GCM] Error processing file on open:",n)}finally{this.processingFiles.delete(e.path)}}}async syncTitleFromFilename(e){if(this.shouldProcess(e)&&!this.processingFiles.has(e.path)){this.processingFiles.add(e.path);try{let t=this.plugin.app.metadataCache.getFileCache(e),n=t==null?void 0:t.frontmatter;if(!n)return;let i=(e.basename||"").trim();if(!i||i.toLowerCase().includes("template"))return;let r=n.scheduled,a=i,s=a.match(/^(.*)\s(\d{4}-\d{2}-\d{2})$/);if(s){let[,p,u]=s;if(r){let d=window.moment(r),c=window.moment(u,"YYYY-MM-DD",!0);d.isValid()&&c.isValid()?d.format("YYYY-MM-DD")===u&&(a=p):a=p}else a=p}a=a.replace(/\s+/g," ").trim();let l=typeof n.title=="string"?n.title.trim():"";a&&a!==l&&await this.plugin.app.fileManager.processFrontMatter(e,p=>{p.title=a})}catch(t){P("[TPS GCM] Error syncing title from filename:",t)}finally{this.processingFiles.delete(e.path)}}}async updateFilenameIfNeeded(e){let t=this.plugin.app.metadataCache.getFileCache(e),n=t==null?void 0:t.frontmatter;if(!n||!n.title)return;let i=n.title;if(i.toLowerCase().includes("template"))return;let r=n.scheduled,a;if(r){let d=window.moment(r);if(!d.isValid())a=this.sanitizeFilename(i);else{let c=d.format("YYYY-MM-DD");if(i.trim()===c)a=c;else{let h=i.replace(/ \d{4}-\d{2}-\d{2}$/,"");a=this.sanitizeFilename(`${h} ${c}`)}}}else{let d=i.replace(/ \d{4}-\d{2}-\d{2}$/,"");a=this.sanitizeFilename(d)}let s=e.basename.trim().toLowerCase(),l=a.trim().toLowerCase();if(s===l)return;if(r){let d=window.moment(r).format("YYYY-MM-DD");if(new RegExp(`\\s${d.replace(/-/g,"\\-")}(?:\\s|$)`).test(e.basename)){let h=e.basename.replace(/\s+/g," ").trim(),m=a.replace(/\s+/g," ").trim();if(h===m)return}}let p=e.parent?`${e.parent.path}/${a}.md`:`${a}.md`,u=this.plugin.app.vault.getAbstractFileByPath(p);if(u&&u!==e){C(`[TPS GCM] File with name "${a}" already exists, skipping rename`);return}try{await this.plugin.app.fileManager.renameFile(e,p),C(`[TPS GCM] Renamed file from "${e.basename}" to "${a}"`)}catch(d){P(`[TPS GCM] Failed to rename file to "${a}":`,d)}}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*\x00-\x1F]/g,"").replace(/\s+/g," ").trim()}shouldProcess(e){return e.extension!=="md"||this.processingFiles.has(e.path)?!1:this.plugin.settings.folderExclusions&&this.plugin.settings.folderExclusions.split(`
`).map(n=>n.trim()).filter(n=>n.length>0).some(n=>e.path.startsWith(n))?(C(`[TPS GCM] Skipping ${e.path} due to folder exclusion`),!1):!0}};var ee=require("obsidian");var Qe=class extends ee.Component{constructor(e){super(),this.plugin=e}onload(){let e=(0,ee.debounce)(this.handleActiveLeafable.bind(this),500,!1);this.registerEvent(this.plugin.app.workspace.on("active-leaf-change",e));let t=(0,ee.debounce)(n=>{let i=this.plugin.app.workspace.activeLeaf;i&&i.view instanceof ee.MarkdownView&&i.view.file===n&&e(i)},1500,!1);this.plugin.registerEvent(this.plugin.app.metadataCache.on("changed",n=>{t(n)})),this.plugin.addCommand({id:"force-view-mode-check",name:"Force View Mode Check",editorCallback:(n,i)=>{let r=this.plugin.app.workspace.activeLeaf;this.handleActiveLeafable(r!=null?r:null)}})}async handleActiveLeafable(e){if(!this.plugin.settings.enableViewModeSwitching||(e||(e=this.plugin.app.workspace.activeLeaf),!e||!(e.view instanceof ee.MarkdownView))||e.view.getViewType()!=="markdown")return;let n=e.view.file;if(!n)return;if(this.plugin.settings.viewModeIgnoredFolders&&this.plugin.settings.viewModeIgnoredFolders.split(`
`).map(u=>u.trim()).filter(Boolean).some(u=>n.path.startsWith(u))){C(`[TPS GCM] Skipping view mode check for ${n.basename} (Path ignored: ${n.path})`);return}let i=this.plugin.app.metadataCache.getFileCache(n),r=i==null?void 0:i.frontmatter;if(!r)return;let a=null;if(this.plugin.settings.viewModeFrontmatterKey){let p=this.plugin.settings.viewModeFrontmatterKey,u=r[p];u&&["source","preview","reading","live"].includes(String(u).toLowerCase())?a=u:u&&C(`[TPS GCM] Frontmatter key '${p}' found value '${u}' which is not a valid mode. Ignoring.`)}if(!a&&this.plugin.settings.viewModeRules){let p=this.plugin.settings.viewModeRules.find(u=>{let d=r[u.key],c=String(d)===String(u.value);return C(`[TPS GCM] Checking rule: Key=${u.key}, RuleValue=${u.value}, FmValue=${d}, Match=${c}`),c});p&&(a=p.mode,C(`[TPS GCM] Rule matched! Setting mode to ${a}`))}if(!a)return;let s=e.getViewState(),l=!1;if(C(`[TPS GCM] Current State for ${n.basename}: mode=${s.state.mode}, source=${s.state.source}`),C(`[TPS GCM] Target Mode: ${a}`),a==="reading"||a==="preview"?s.state.mode!=="preview"&&(s.state.mode="preview",l=!0):a==="source"?(s.state.mode!=="source"||s.state.source!==!0)&&(s.state.mode="source",s.state.source=!0,l=!0):a==="live"&&(s.state.mode!=="source"||s.state.source!==!1)&&(s.state.mode="source",s.state.source=!1,l=!0),l){C(`[TPS GCM] Switching view mode for ${n.basename} to ${a}`);try{let p=JSON.parse(JSON.stringify(s));await e.setViewState(p)}catch(p){P(`[TPS GCM] Failed to set view state for ${n.basename}`,p)}}else C("[TPS GCM] No update needed.")}};var te=require("obsidian");var Xe=class{constructor(e){this.plugin=e}get app(){return this.plugin.app}resolveTargets(e,t){if(e&&e.length>0){let i=this.expandSelection(e);return i.length>0?i:e}if(t&&t.target instanceof HTMLElement){let i=this.resolveEmbedTarget(t.target);if(i)return[i];let r=this.resolveExplorerPath(t.target);if(r){let a=this.app.vault.getAbstractFileByPath(r);if(a instanceof te.TFolder)return[];if(a instanceof te.TFile)return[a]}}let n=this.app.workspace.getActiveFile();return n?[n]:[]}expandSelection(e){if(e.length===0)return[];let t=this.getSelectedFiles();if(t.length===0)return e;let n=new Set(e.map(s=>s.path)),i=new Set(t.map(s=>s.path));return e.every(s=>i.has(s.path))?t:e.some(s=>i.has(s.path))?(C("[Context Target] Partial overlap detected - using DOM selection",{primary:Array.from(n),selection:Array.from(i)}),t):(C("[Context Target] No overlap with DOM selection - using explicit files",{primary:Array.from(n),selection:Array.from(i)}),e)}getSelectedFiles(){let e=new Map,t=r=>{r&&r.path&&e.set(r.path,r)};return Array.from(document.querySelectorAll(".explorer2-selected[data-path]")).forEach(r=>{let a=r.dataset.path;if(!a)return;let s=this.app.vault.getAbstractFileByPath(a);s instanceof te.TFile&&t(s)}),Array.from(document.querySelectorAll(".workspace-leaf-content .nav-file.is-selected[data-path]")).forEach(r=>{let a=r.dataset.path;if(!a)return;let s=this.app.vault.getAbstractFileByPath(a);s instanceof te.TFile&&t(s)}),Array.from(e.values())}resolveExplorerPath(e){let t=e.closest(".nav-file, .nav-folder, .tree-item, .tree-item-self, .tps-calendar-entry, .bases-feed-entry, [data-path]");if(t instanceof HTMLElement&&t.dataset.path)return t.dataset.path;let n=e.closest("a.internal-link");if(n instanceof HTMLElement&&n.dataset.href){let r=n.dataset.href,a=this.app.metadataCache.getFirstLinkpathDest(r,"");if(a instanceof te.TFile)return a.path}let i=e.closest(".search-result-file-title, .search-result-file-match");return null}resolveEmbedTarget(e){var n,i;let t=e.closest(".block-language-sync, .cm-embed-block, .sync-embed, .sync-container");if(t){let r=null,a=t.previousElementSibling;for(let s=0;s<3&&a&&!r;s++){if(a instanceof HTMLElement&&((n=a.dataset)!=null&&n.calendarEmbed)){r=a;break}let l=(i=a.querySelector)==null?void 0:i.call(a,"span[data-calendar-embed]");if(l instanceof HTMLElement){r=l;break}a=a.previousElementSibling}if(!r&&t.parentElement){let s=t.parentElement.querySelectorAll("span[data-calendar-embed]");for(let l of Array.from(s))if(l instanceof HTMLElement){let p=Array.from(t.parentElement.children).indexOf(l.closest(".markdown-preview-sizer > *")||l),u=Array.from(t.parentElement.children).indexOf(t);if(p!==-1&&u!==-1&&p<u&&(p===u-1||p===u-2)){r=l;break}}}if(r&&r.dataset.calendarEmbed){let s=r.dataset.calendarEmbed,l=this.app.vault.getAbstractFileByPath(s.endsWith(".md")?s:s+".md");if(l instanceof te.TFile)return l}}return null}};var F=require("obsidian");var Je=class{constructor(e){this.plugin=e,this.app=e.app}async addNotesToAnotherNote(e){try{if(!e.length){new F.Notice("Select a file first");return}let t=await new Promise(a=>{let s=!1,l=u=>{s||(s=!0,a(u))};class p extends F.FuzzySuggestModal{constructor(d){super(d),this.setPlaceholder("Choose note to append to...")}getItems(){return this.app.vault.getMarkdownFiles()}getItemText(d){return d.path}onChooseItem(d,c){l(d)}onClose(){l(null)}}new p(this.app).open()});if(!t)return;let n=[];for(let a of e)try{let s=await this.buildSectionForNote(a);n.push(s)}catch(s){P("Failed to build section for",a.path,s)}if(!n.length){new F.Notice("Nothing to append");return}let i=await this.app.vault.read(t),r=i.endsWith(`
`)?`
`:`

`;await this.app.vault.modify(t,`${i}${r}${n.join(`
`)}`),new F.Notice(`Added ${n.length} note(s) to ${t.basename}`)}catch(t){P("Add to note failed",t),new F.Notice("Unable to add to note")}}async addNotesToDailyNotes(e){var t;try{if(!e.length){new F.Notice("Select a file first");return}let n=new Map;for(let i of e){let r=await this.extractNoteParts(i),a=this.pickCreatedDate(r.frontmatter,i);if(!a){j("No created date for file",i.path);continue}let s=await this.buildSectionForNote(i,r);n.has(a)?(t=n.get(a))==null||t.push(s):n.set(a,[s])}if(!n.size){new F.Notice("No usable created dates found");return}for(let[i,r]of n.entries())try{let a=await this.ensureDailyNote(i);if(!a)continue;let s=await this.app.vault.read(a),l=s.endsWith(`
`)?`
`:`

`;await this.app.vault.modify(a,`${s}${l}${r.join(`
`)}`)}catch(a){P("Failed to append to daily note",i,a)}new F.Notice(`Added ${e.length} note(s) to daily notes`)}catch(n){P("Add to daily note failed",n),new F.Notice("Unable to add to daily note")}}async extractNoteParts(e){var a;let t=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e),i={},r=t;try{if((a=n==null?void 0:n.frontmatter)!=null&&a.position){let{start:s,end:l}=n.frontmatter.position,p=t.split(`
`),u=p.slice(s.line+1,l.line).join(`
`);i=(0,F.parseYaml)(u)||{},r=p.slice(l.line+1).join(`
`)}}catch(s){P("Failed to parse frontmatter for",e.path,s)}return{frontmatter:i,body:r}}async buildSectionForNote(e,t){t||(t=await this.extractNoteParts(e));let n=e.basename||e.name,i=this.serializeFrontmatterForSection(t.frontmatter||{}),r=this.demoteHeadingsForEmbed((t.body||"").trim());return r.trim()||(r="_(empty)_"),`### ${n}

#### Frontmatter
${i}

#### Body
${r}
`}serializeFrontmatterForSection(e){if(!e||typeof e!="object")return"- (none)";let t=[];for(let[n,i]of Object.entries(e)){if(i===void 0)continue;let r;n.toLowerCase()==="tags"?r=this.normalizeTagsWithHash(i):Array.isArray(i)?r=i.map(a=>a===null?"":typeof a=="object"?JSON.stringify(a):`${a}`).filter(Boolean).join(", "):i&&typeof i=="object"?r=JSON.stringify(i):r=`${i}`,t.push(`- ${n}: ${r}`)}return t.length?t.join(`
`):"- (none)"}normalizeTagsWithHash(e){if(e==null)return"";let t=[];return Array.isArray(e)?t=e.slice():typeof e=="string"?t=e.split(/[\s,]+/).filter(Boolean):t=[`${e}`],t.map(n=>{let r=(typeof n=="string"?n:`${n||""}`).replace(/^#/,"");return r?`#${r}`:""}).filter(Boolean).join(" ")}demoteHeadingsForEmbed(e){if(!e)return"";let t=!1;return e.split(`
`).map(n=>{if(n.trimStart().startsWith("```"))return t=!t,n;if(t)return n;let r=n.match(/^(#{1,6})\s+(.*)$/);if(!r)return n;let a=r[1].length,s=r[2],l=Math.min(6,a+3);return`${"#".repeat(l)} ${s}`}).join(`
`)}pickCreatedDate(e,t){let n=[];e=e||{};for(let[r,a]of Object.entries(e)){let s=r.replace(/\s+/g,"").toLowerCase();["createddate","datecreated","created"].includes(s)&&n.push(a)}let i=window.moment;for(let r of n)try{if(i){let s=i(r);if(s!=null&&s.isValid&&s.isValid())return s.format("YYYY-MM-DD")}let a=Date.parse(`${r}`);if(!Number.isNaN(a))return new Date(a).toISOString().split("T")[0]}catch(a){}return t.stat.ctime?new Date(t.stat.ctime).toISOString().split("T")[0]:null}async ensureDailyNote(e){var l,p,u;let t="System/Dailynotes",n="System/Dailynotes/Daily Note Template.md";try{let d=(p=(l=this.app.internalPlugins)==null?void 0:l.plugins)==null?void 0:p["daily-notes"];if(d!=null&&d.enabled&&((u=d==null?void 0:d.instance)!=null&&u.options)){let c=d.instance.options;c.folder&&(t=c.folder),c.template&&(n=c.template),n.endsWith(".md")||(n+=".md")}}catch(d){j("Failed to read core Daily Notes settings",d)}let i=(0,F.normalizePath)(`${t}/${e}.md`),r=this.app.vault.adapter;if(await r.exists(i)){let d=this.app.vault.getAbstractFileByPath(i);return d instanceof F.TFile?d:null}await r.exists(t)||await this.app.vault.createFolder(t);let a="",s=!1;try{let d=(0,F.normalizePath)(n);await r.exists(d)&&(a=await r.read(d),s=a.trimStart().startsWith("---"))}catch(d){a=""}return a?s?/^title\s*:/m.test(a)?a=a.replace(/^title\s*:.*$/m,`title: ${e}`):a=a.replace(/^---\n/,`---
title: ${e}
`):a=`---
title: ${e}
tags: [dailynote]
---

${a}`:a=`---
title: ${e}
tags: [dailynote]
---

`,await this.app.vault.create(i,a)}};function cn(){typeof Date.prototype.contains!="function"&&(Date.prototype.contains=function(o){let e=String(this);return typeof e.contains=="function"?e.contains(o):e.toLowerCase().includes(String(o).toLowerCase())})}function un(){let o=console.error;return console.error=function(...e){let t=e.length>0?e[0]:"",n=typeof t=="string"?t:t&&t.message?String(t.message):String(t);n.includes("Cannot find function")&&n.includes("on type Date")||n.includes("Failed to evaluate a filter")&&n.includes("Date")||o.apply(console,e)},()=>{console.error=o}}var et=class extends L.Plugin{constructor(){super(...arguments);this.styleEl=null;this.ignoreNextContext=!1;this.keyboardVisible=!1;this.restoreConsoleError=null;this.restoreMenuPatch=null;this.debouncedSave=(0,L.debounce)(async()=>{await this.saveData(this.settings)},1e3,!0)}async onload(){this.ignoreNextContext=!1,await this.loadSettings(),We(this.settings.enableLogging),cn(),this.restoreConsoleError=un(),this.contextTargetService=new Xe(this),this.bulkEditService=new Ke(this),this.recurrenceService=new qe(this),this.fileNamingService=new Ze(this),this.noteOperationService=new Je(this),this.menuController=new je(this),this.persistentMenuManager=new Be(this),this.viewModeManager=new Qe(this),this.addChild(this.viewModeManager),this.recurrenceService.setup(),this.patchMenuMethods(),this.injectStyles(),this.keyboardVisible=!1,this.registerEvent(this.app.workspace.on("file-menu",(r,a)=>{a instanceof L.TFile&&this.menuController.addToNativeMenu(r,[a])})),this.registerEvent(this.app.workspace.on("files-menu",(r,a)=>{let s=a.filter(l=>l&&l.path&&typeof l.path=="string");s.length>0&&this.menuController.addToNativeMenu(r,s)})),this.registerEvent(this.app.workspace.on("editor-menu",(r,a,s)=>{s&&s.file instanceof L.TFile&&this.menuController.addToNativeMenu(r,[s.file])})),this.addSettingTab(new Ve(this.app,this));let t=this.persistentMenuManager.ensureMenus.bind(this.persistentMenuManager),n=(0,L.debounce)(t,500,!1);L.Platform.isMobile||this.registerEvent(this.app.workspace.on("layout-change",n)),this.registerEvent(this.app.workspace.on("active-leaf-change",n)),this.registerEvent(this.app.workspace.on("file-open",r=>{t(),r&&L.Platform.isMobile&&setTimeout(()=>{this.persistentMenuManager.refreshMenusForFile(r)},500),r&&this.fileNamingService.shouldProcess(r)&&setTimeout(()=>{this.fileNamingService.processFileOnOpen(r)},500)}));let i=(0,L.debounce)(r=>{r&&r.extension==="md"&&this.persistentMenuManager.refreshMenusForFile(r)},2e3,!1);if(this.registerEvent(this.app.metadataCache.on("changed",r=>{i(r)})),this.registerEvent(this.app.vault.on("rename",r=>{r instanceof L.TFile&&r.extension==="md"&&(this.persistentMenuManager.refreshMenusForFile(r),setTimeout(()=>{this.fileNamingService.syncTitleFromFilename(r)},150))})),this.register(()=>this.persistentMenuManager.detach()),this.register(()=>this.menuController.detach()),this.registerEvent(this.app.vault.on("delete",()=>{var r,a;C("[TPS GCM] vault delete detected; blurring and closing menu");try{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}catch(s){j("TPS GCM: blur after delete failed",s)}try{(a=(r=this.menuController)==null?void 0:r.hideMenu)==null||a.call(r)}catch(s){j("TPS GCM: hideMenu after delete failed",s)}try{this.app.workspace.trigger("tps-gcm-delete-complete")}catch(s){j("TPS GCM: trigger delete-complete failed",s)}})),t(),this.app.workspace.onLayoutReady(async()=>{if(L.Platform.isMobile){C("[TPS GCM] Skipping recurrence scan on mobile startup.");return}setTimeout(async()=>{C("[TPS GCM] Checking for missing recurrences on startup..."),await this.bulkEditService.checkMissingRecurrences()},2e3)}),this.registerDomEvent(document,"contextmenu",r=>{var u;let a=this.contextTargetService.resolveTargets([],r);if(a.length===0)return;let s=a[0],l=!!this.contextTargetService.resolveEmbedTarget(r.target),p=!!((u=r.target)!=null&&u.closest("a.internal-link, .cm-link, [data-href], [data-path]"));if(this.settings.enableStrictMode||l||p){r.preventDefault(),r.stopPropagation();let d=new L.Menu;this.menuController.addToNativeMenu(d,a),d.showAtPosition({x:r.pageX,y:r.pageY})}},{capture:!0}),this.addCommand({id:"open-in-right-sidebar",name:"Open active file in Right Sidebar",checkCallback:r=>{let a=this.app.workspace.getActiveFile();if(a){if(!r){let s=this.app.workspace.getRightLeaf(!0);s&&(s.openFile(a),this.app.workspace.revealLeaf(s))}return!0}return!1}}),this.addCommand({id:"open-in-left-sidebar",name:"Open active file in Left Sidebar",checkCallback:r=>{let a=this.app.workspace.getActiveFile();if(a){if(!r){let s=this.app.workspace.getLeftLeaf(!0);s&&(s.openFile(a),this.app.workspace.revealLeaf(s))}return!0}return!1}}),L.Platform.isMobile||this.registerDomEvent(document,"click",r=>{if(!this.settings.enableShiftClickCancel||!r.shiftKey)return;let a=r.target;!(a instanceof HTMLElement)||!(a.matches&&a.matches('input[type="checkbox"]')||a.classList&&a.classList.contains("task-list-item-checkbox")||a.classList&&a.classList.contains("cm-formatting-task"))||(C("[TPS GCM] Shift+click on checkbox detected"),r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),this.handleCheckboxClick(a))},{capture:!0}),L.Platform.isMobile){let r=null,a=!1,s=null,l=(p,u,d)=>{C("[TPS GCM] Long-press on checkbox detected"),this.handleCheckboxLongPress(p,u,d)};this.registerDomEvent(document,"touchstart",p=>{if(a=!1,s=null,r&&(clearTimeout(r),r=null),!this.settings.enableShiftClickCancel)return;let u=p.target;if(!(u instanceof HTMLElement)||!(u.matches&&u.matches('input[type="checkbox"]')||u.classList&&u.classList.contains("task-list-item-checkbox")||u.classList&&u.classList.contains("cm-formatting-task")))return;s=u;let c=p.touches[0],h=c.clientX,m=c.clientY;r=window.setTimeout(()=>{a=!0,r=null,l(u,h,m)},500)},{capture:!0,passive:!0}),this.registerDomEvent(document,"touchend",p=>{!r&&!a||(r&&(clearTimeout(r),r=null),a&&(p.cancelable&&(p.preventDefault(),p.stopPropagation()),a=!1),s=null)},{capture:!0}),this.registerDomEvent(document,"touchmove",()=>{r&&(clearTimeout(r),r=null,a=!1,s=null)},{capture:!0,passive:!0})}}handleCheckboxClick(t){let n=this.app.workspace.activeLeaf;if(!n)return;let i=n.view;if(!i)return;let r=this.findCheckboxLineNumber(t,i);r>=0&&i.file&&this.modifyCheckboxLine(i.file,r,"[-]")}handleCheckboxLongPress(t,n,i){let r=this.app.workspace.activeLeaf;if(!r)return;let a=r.view;if(!a)return;let s=this.findCheckboxLineNumber(t,a);if(s<0||!a.file)return;let l=a.file,p=new L.Menu;p.addItem(u=>{u.setTitle("\u2713 Complete").setIcon("check").onClick(()=>this.modifyCheckboxLine(l,s,"[x]"))}),p.addItem(u=>{u.setTitle("\u2014 Cancel").setIcon("minus").onClick(()=>this.modifyCheckboxLine(l,s,"[-]"))}),p.addItem(u=>{u.setTitle("\u25CB Unchecked").setIcon("circle").onClick(()=>this.modifyCheckboxLine(l,s,"[ ]"))}),p.showAtPosition({x:n,y:i})}findCheckboxLineNumber(t,n){let i=-1,r=t.closest("[data-line]");if(r){let a=r.getAttribute("data-line");a&&(i=parseInt(a,10))}if(i<0&&n.editor){let a=n.editor;try{let s=a.cm;if(s&&s.posAtDOM){let l=t.closest(".cm-line")||t,p=s.posAtDOM(l);p!=null&&(i=s.state.doc.lineAt(p).number-1)}}catch(s){}}return i}modifyCheckboxLine(t,n,i){this.app.vault.read(t).then(r=>{let a=r.split(`
`);if(n<0||n>=a.length)return;let s=a[n],l=s;if(/\[[ x\-]\]/i.test(s))l=s.replace(/\[[ x\-]\]/i,i);else return;a[n]=l,this.app.vault.modify(t,a.join(`
`))})}patchMenuMethods(){if(L.Menu.prototype._tpsPatched){this.restoreMenuPatch=L.Menu.prototype._tpsPatched;return;}let t=L.Menu.prototype.showAtPosition,n=L.Menu.prototype.showAtMouseEvent,i=r=>{if(r.items){let a=r.items,s=[],l=[];for(let h of a)h._isTpsItem?s.push(h):l.push(h);let p=h=>{let m=h.title;if(!m&&h.dom){let g=h.dom.querySelector(\".menu-item-title\");g?m=g.innerText:m=h.dom.innerText}return m?m.toLowerCase().replace(/\.\.\.$/,\"\").replace(/\/g,\" \" ).trim():\"\"},u=new Set;s.forEach(h=>{let m=p(h);m&&(u.add(m),m===\"reveal in system explorer\"&&(u.add(\"reveal in finder\"),u.add(\"show in system explorer\"),u.add(\"show in folder\")),m===\"reveal in navigation\"&&u.add(\"reveal file in navigation\"),m===\"copy relative path\"&&u.add(\"copy path\"))});let d=new Set(u),c=l.filter(h=>{let m=p(h);return m?d.has(m)?!1:(d.add(m),!0):!0});s.length>0&&(r.items=[...s,...c])}};L.Menu.prototype.showAtPosition=function(r){return i(this),t.call(this,r)},L.Menu.prototype.showAtMouseEvent=function(r){return i(this),n.call(this,r)},L.Menu.prototype._tpsPatched=()=>{L.Menu.prototype.showAtPosition=t,L.Menu.prototype.showAtMouseEvent=n,delete L.Menu.prototype._tpsPatched},this.restoreMenuPatch=L.Menu.prototype._tpsPatched}onunload(){var t,n,i,r,a,s;this.restoreMenuPatch&&(this.restoreMenuPatch(),this.restoreMenuPatch=null),(t=this.restoreConsoleError)==null||t.call(this),this.restoreConsoleError=null,(n=this.menuController)==null||n.detach(),this.removeStyles(),(i=this.persistentMenuManager)==null||i.detach(),(r=this.recurrenceService)==null||r.cleanup(),(s=(a=document.body)==null?void 0:a.classList)==null||s.remove("tps-context-hidden-for-keyboard")}async loadSettings(){this.settings=Object.assign({},bt,await this.loadData()),We(this.settings.enableLogging)}async saveSettings(){We(this.settings.enableLogging),this.debouncedSave()}injectStyles(){if(this.styleEl)return;let t=document.createElement("style");t.id="tps-global-context-style",t.textContent=xt,document.head.appendChild(t),this.styleEl=t}removeStyles(){this.styleEl&&(this.styleEl.remove(),this.styleEl=null)}createMenuHeader(t){let n=document.createElement("div");return n.className="tps-global-context-header",n.textContent=t.basename,n}createMultiMenuHeader(t){let n=document.createElement("div");return n.className="tps-global-context-header",n.textContent=`${t.length} files selected`,n}buildSpecialPanel(t,n={}){let i=Array.isArray(t)?t:[t];return this.menuController.buildSpecialPanel(i,n)}};
