/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var he=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var Oe=Object.prototype.hasOwnProperty;var Ie=(u,t)=>{for(var e in t)he(u,e,{get:t[e],enumerable:!0})},Ve=(u,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ne(t))!Oe.call(u,i)&&i!==e&&he(u,i,{get:()=>t[i],enumerable:!(n=Be(t,i))||n.enumerable});return u};var ze=u=>Ve(he({},"__esModule",{value:!0}),u);var tt={};Ie(tt,{default:()=>pe});module.exports=ze(tt);var F=require("obsidian");var T=require("obsidian");var G=class{constructor(){this.timers=new Map}schedule(t,e,n){let i=this.timers.get(t);i!=null&&window.clearTimeout(i);let r=window.setTimeout(()=>{this.timers.delete(t),n()},Math.max(0,e));this.timers.set(t,r)}cancel(t){let e=this.timers.get(t);e!=null&&(window.clearTimeout(e),this.timers.delete(t))}cancelAll(){for(let t of this.timers.values())window.clearTimeout(t);this.timers.clear()}};var M=require("obsidian");var Ce=[{value:"",label:"(none)"},{value:"templater-icon",label:"templater-icon (template)"},{value:"lucide:check-square-2",label:"lucide:check-square-2 (complete)"},{value:"lucide:clipboard-list",label:"lucide:clipboard-list (working)"},{value:"lucide:clipboard-check",label:"lucide:clipboard-check (done)"},{value:"lucide:clipboard-x",label:"lucide:clipboard-x (blocked)"},{value:"lucide:triangle-alert",label:"lucide:triangle-alert (warning)"},{value:"lucide:archive",label:"lucide:archive (archive)"},{value:"lucide:calendar",label:"lucide:calendar (date)"},{value:"lucide:file-text",label:"lucide:file-text (note)"}];function xe(u){return u==="is"||u==="!is"||u==="contains"||u==="!contains"||u==="exists"||u==="!exists"?u:"is"}function U(u){return u==="is"||u==="contains"||u==="exists"||u==="!is"||u==="!contains"||u==="!exists"||u==="is-not-empty"||u==="starts"||u==="!starts"||u==="within-next-days"||u==="!within-next-days"||u==="has-open-checkboxes"||u==="!has-open-checkboxes"||u==="is-today"||u==="!is-today"||u==="is-before-today"||u==="!is-before-today"||u==="is-after-today"||u==="!is-after-today"?u:"is"}function Y(u){return u==="frontmatter"||u==="path"||u==="extension"||u==="name"||u==="tag"||u==="body"||u==="backlink"||u==="date-created"||u==="date-modified"?u:"frontmatter"}function P(u){return u==="any"?"any":"all"}function j(u="frontmatter"){return{source:u,field:u==="frontmatter"?"status":"",operator:"is",value:""}}function Re(u){return u==="contains"||u==="!contains"||u==="exists"||u==="!exists"?u:u==="!is"?"!is":"is"}function q(u){if(u.operator==="within-next-days"||u.operator==="!within-next-days")return"7";if(u.source==="path")return"01 Action Items";if(u.source==="extension")return"md";if(u.source==="name")return"Daily Standup";if(u.source==="tag")return"hide";let t=String(u.field||"").trim().toLowerCase();return t==="priority"?"normal":t==="status"?"working":t==="scheduled"||t==="due"?"2026-02-12 14:45:00":t==="folderpath"?"01 Action Items":"value"}function X(u){return u.split(",").map(t=>t.trim()).filter(Boolean).flatMap(t=>{let e=t.includes("=")?"=":t.includes(":")?":":"";if(!e)return[];let[n,i]=t.split(e),r=String(n||"").trim(),s=String(i||"").trim();return!r||!s?[]:[{input:r,output:s}]})}function ke(u){return u.map(t=>`${t.input}=${t.output}`).join(", ")}function J(u){let t=String(u||"").trim();return t?t.startsWith("lucide:")||t.startsWith("lucide-")?t.slice(7).trim():t:""}function ge(u){let t=String(u||"").trim();if(!t)return!1;try{if(typeof CSS!="undefined"&&typeof CSS.supports=="function")return CSS.supports("color",t)}catch(e){}return/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(t)}function K(u){let t=["is","!is","contains","!contains","exists","!exists","is-not-empty","starts","!starts"],e=["within-next-days","!within-next-days","is-today","!is-today","is-before-today","!is-before-today","is-after-today","!is-after-today"];return u==="frontmatter"?[...t,...e]:u==="name"?[...t,"is-today","!is-today","is-before-today","!is-before-today","is-after-today","!is-after-today"]:u==="date-created"||u==="date-modified"?[...t,...e]:u==="body"?[...t,"has-open-checkboxes","!has-open-checkboxes"]:t}var B=null,fe="",$e=["#4caf50","#478fee","#e49320","#d34f56","#8656ae","#2f482e","#a0a5b8",""],Z=class{constructor(t){this.context=t}render(t){let{plugin:e,refresh:n,persistRuleChange:i}=this.context,r=t.createDiv({cls:"tps-nn-section"});r.createEl("h3",{text:"Rules"}),r.createEl("p",{cls:"setting-item-description",text:"First match wins for icon/color. Use the left list to pick a rule; edit only one rule at a time."});let s=r.createDiv({cls:"tps-nn-toolbar"});if(this.createActionButton(s,"+ Add rule",async()=>{let f=e.createDefaultRule();e.settings.rules.push(f),B=f.id,await i(!1),n()},!0),this.createActionButton(s,"Apply active note",async()=>{await e.applyRulesToActiveFile(!0)}),this.createActionButton(s,"Apply all notes",async()=>{await e.applyRulesToAllFiles(!0)}),e.settings.rules.length===0){r.createEl("p",{cls:"setting-item-description",text:"No rules configured."});return}let a=this.getSelectedRule(e.settings.rules);if(!a){r.createEl("p",{cls:"setting-item-description",text:"No rule selected."});return}let o=r.createDiv({cls:"tps-nn-split"}),l=o.createDiv({cls:"tps-nn-list-pane"}),c=o.createDiv({cls:"tps-nn-editor-pane"}),p=l.createDiv({cls:"tps-nn-toolbar"}).createEl("input",{cls:"tps-nn-filter-input",attr:{type:"search",placeholder:"Filter rules..."}});p.value=fe,p.addEventListener("input",()=>{fe=p.value.trim().toLowerCase(),n()});let y=e.settings.rules.map((f,R)=>({rule:f,index:R})).filter(({rule:f,index:R})=>this.matchesFilter(f,R+1,fe));y.length===0?l.createEl("p",{cls:"setting-item-description",text:"No rules match the current filter."}):y.forEach(({rule:f,index:R})=>{this.renderRuleListItem(l,f,R,a.id)}),this.renderRuleEditor(c,a.rule,a.index)}renderRuleListItem(t,e,n,i){let r=t.createEl("button",{cls:"tps-nn-list-item"});r.type="button",e.id===i&&r.addClass("is-active"),r.addEventListener("click",()=>{B=e.id,this.context.refresh()});let s=r.createDiv({cls:"tps-nn-list-item-title-row"}),a=String(e.icon||"").trim();if(a){let c=s.createSpan({cls:"tps-nn-list-item-icon"}),d=J(a);if(d)try{(0,M.setIcon)(c,d);let p=String(e.color||"").trim();c.style.color=p&&ge(p)?p:"var(--text-muted)"}catch(p){c.setText("?")}}let o=String(e.name||"").trim()||`Rule ${n+1}`,l=s.createSpan({cls:"tps-nn-list-item-title",text:o});e.enabled||l.addClass("is-muted"),r.createDiv({cls:"tps-nn-list-item-summary",text:this.getRuleSummary(e)}),r.createDiv({cls:"tps-nn-list-item-summary",text:e.enabled?"Enabled":"Disabled"})}renderRuleEditor(t,e,n){let{plugin:i,bindCommittedText:r,refresh:s,persistRuleChange:a}=this.context,o=e.id,l=String(e.name||"").trim()||`Rule ${n+1}`;t.createEl("h4",{text:`Editing: ${l}`});let c=t.createDiv({cls:"tps-nn-toolbar"});this.createActionButton(c,"Previous",async()=>{let w=Math.max(0,n-1),C=i.settings.rules[w];C&&(B=C.id,s())},!1,n===0),this.createActionButton(c,"Next",async()=>{let w=Math.min(i.settings.rules.length-1,n+1),C=i.settings.rules[w];C&&(B=C.id,s())},!1,n>=i.settings.rules.length-1),this.createMenuButton(c,"Rule actions",w=>{this.openRuleActionsMenu(w,o,n)}),this.createMenuButton(c,"Icon presets",w=>{this.openIconPresetMenu(w,o)}),this.createMenuButton(c,"Color presets",w=>{this.openColorPresetMenu(w,o)});let d=i.getRuleMatchForActiveFile(e);t.createEl("div",{cls:"tps-nn-callout",text:d==null?"Active note preview unavailable.":`Active note preview: ${d?"matches":"does not match"}.`}),new M.Setting(t).setName("Display name").setDesc("Optional name shown in the rule list.").addText(w=>{w.setPlaceholder("e.g. Working items"),r(w,e.name||"",async C=>{let x=this.getLiveRule(o);x&&(x.name=C.trim())})}),new M.Setting(t).setName("Enabled").setDesc("Disable without deleting the rule.").addToggle(w=>{w.setValue(e.enabled).onChange(async C=>{let x=this.getLiveRule(o);x&&(x.enabled=C,await a(!0),s())})});let p=this.isConditionRule(e);new M.Setting(t).setName("Rule editor mode").setDesc("Simple mode is one check. Advanced mode supports mixed condition sources.").addDropdown(w=>{w.addOption("simple","Simple").addOption("conditions","Advanced conditions").setValue(p?"conditions":"simple").onChange(async C=>{let x=this.getLiveRule(o);x&&(C==="conditions"?this.convertRuleToConditionMode(x):this.convertRuleToSimpleMode(x),await a(!1),s())})});let y=t.createEl("details",{cls:"tps-nn-sub-collapsible"});y.open=!0,y.createEl("summary",{text:"Match Criteria"});let f=y.createDiv({cls:"tps-nn-sub-body"});p?this.renderConditionCriteria(f,o,e):this.renderSimpleCriteria(f,o,e);let R=t.createEl("details",{cls:"tps-nn-sub-collapsible"});R.open=!0,R.createEl("summary",{text:"Outputs"});let S=R.createDiv({cls:"tps-nn-sub-body"}),v=S.createDiv({cls:"setting-item-description"});v.style.display="flex",v.style.alignItems="center",v.style.gap="8px";let h=v.createSpan();h.style.width="18px",h.style.height="18px",h.style.display="inline-flex",h.style.alignItems="center",h.style.justifyContent="center";let m=v.createSpan(),g=w=>{let C=String(w||"").trim();if(h.empty(),!C){h.setText("\u2014"),m.setText("Icon preview: (none)");return}let x=J(C);this.tryRenderIcon(h,x)||h.setText("?"),m.setText(`Icon preview: ${C}`)};new M.Setting(S).setName("Icon output").setDesc("Choose from menu or type custom icon id.").addDropdown(w=>{let C=this.getIconOptions(e.icon);for(let x of C)w.addOption(x.value,x.label);w.setValue(e.icon||"").onChange(async x=>{let L=this.getLiveRule(o);L&&(L.icon=x.trim(),g(L.icon),await a(!0),s())})}).addText(w=>{w.setPlaceholder("custom (e.g. lucide:check-square-2)"),r(w,e.icon,async C=>{let x=this.getLiveRule(o);x&&(x.icon=C.trim())},!1,!0),w.inputEl.addEventListener("input",C=>{var L,V;let x=(V=(L=C.target)==null?void 0:L.value)!=null?V:"";g(x)})}),g(e.icon);let b=S.createDiv({cls:"setting-item-description"});b.style.display="flex",b.style.alignItems="center",b.style.gap="8px";let D=b.createSpan();D.style.width="14px",D.style.height="14px",D.style.borderRadius="3px",D.style.border="1px solid var(--background-modifier-border)";let W=b.createSpan({text:"Aa"});W.style.fontWeight="700";let H=b.createSpan(),me=w=>{let C=String(w||"").trim();if(!C){D.style.backgroundColor="transparent",W.style.color="var(--text-normal)",H.setText("Color preview: (none)");return}if(!ge(C)){D.style.backgroundColor="transparent",W.style.color="var(--text-normal)",H.setText(`Color preview: ${C} (invalid)`);return}D.style.backgroundColor=C,W.style.color=C,H.setText(`Color preview: ${C}`)};new M.Setting(S).setName("Color output").setDesc("Pick with color picker or type any CSS color value.").addColorPicker(w=>{var x;let C=(x=this.toColorPickerValue(e.color))!=null?x:"#4caf50";w.setValue(C).onChange(async L=>{let V=this.getLiveRule(o);V&&(V.color=L.trim(),me(V.color),await a(!0))})}).addText(w=>{w.setPlaceholder("#4caf50 or var(--color-green)"),r(w,e.color,async C=>{var V;let x=this.getLiveRule(o);if(!x)return;x.color=C.trim();let L=this.toColorPickerValue(x.color);if(L){let we=(V=w.inputEl.closest(".setting-item-control"))==null?void 0:V.querySelector("input[type='color']");we&&(we.value=L)}},!1,!0),w.inputEl.addEventListener("input",C=>{var L,V;let x=(V=(L=C.target)==null?void 0:L.value)!=null?V:"";me(x)})}),me(e.color)}renderSimpleCriteria(t,e,n){let{bindCommittedText:i,persistRuleChange:r}=this.context;new M.Setting(t).setName("Frontmatter property").setDesc("Example: status, priority, folderPath.").addText(s=>{s.setPlaceholder("status"),i(s,n.property,async a=>{let o=this.getLiveRule(e);o&&(o.property=a.trim())})}),new M.Setting(t).setName("Operator").addDropdown(s=>{s.addOption("is","is").addOption("!is","is not").addOption("contains","contains").addOption("!contains","does not contain").addOption("exists","exists").addOption("!exists","not exists").setValue(n.operator).onChange(async a=>{let o=this.getLiveRule(e);o&&(o.operator=xe(a),await r(!0))})}),new M.Setting(t).setName("Match value").addText(s=>{s.setPlaceholder("complete"),i(s,n.value,async a=>{let o=this.getLiveRule(e);o&&(o.value=a)})}),new M.Setting(t).setName("Path prefix (optional)").setDesc("Only evaluate notes under this folder path prefix.").addText(s=>{s.setPlaceholder("01 Action Items"),i(s,n.pathPrefix,async a=>{let o=this.getLiveRule(e);o&&(o.pathPrefix=a)})})}renderConditionCriteria(t,e,n){let{persistRuleChange:i,refresh:r}=this.context,s=this.ensureRuleConditions(n);n.match=P(n.match),new M.Setting(t).setName("Match mode").addDropdown(a=>{a.addOption("all","All conditions").addOption("any","Any condition").setValue(n.match).onChange(async o=>{let l=this.getLiveRule(e);l&&(l.match=P(o),await i(!0))})}),s.length===0&&t.createEl("p",{cls:"setting-item-description",text:"No conditions configured yet."}),s.forEach((a,o)=>{let c=t.createDiv({cls:"tps-nn-condition-card"}).createDiv({cls:"tps-nn-condition-grid"}),d=c.createDiv({cls:"tps-nn-condition-field"});d.createEl("label",{text:"Source"});let p=d.createEl("select");for(let h of["frontmatter","path","extension","name","tag","body","backlink"])p.createEl("option",{value:h,text:h});p.value=a.source,p.addEventListener("change",()=>{let h=this.getLiveRule(e);if(!h)return;let m=this.ensureRuleConditions(h)[o];m&&(m.source=Y(p.value),m.source=Y(p.value),m.source!=="frontmatter"&&m.source!=="backlink"&&(m.field=""),i(!1).then(()=>r()))});let y=c.createDiv({cls:"tps-nn-condition-field"});y.createEl("label",{text:"Operator"});let f=y.createEl("select");for(let h of K(a.source))f.createEl("option",{value:h,text:h});if(f.value=a.operator,f.addEventListener("change",()=>{let h=this.getLiveRule(e);if(!h)return;let m=this.ensureRuleConditions(h)[o];if(!m)return;let g=U(f.value);m.operator=g,(g==="exists"||g==="!exists"||g==="is-not-empty"||g==="has-open-checkboxes"||g==="!has-open-checkboxes"||g==="is-today"||g==="!is-today")&&(m.value=""),i(!0).then(()=>r())}),a.source==="frontmatter"||a.source==="backlink"){let h=c.createDiv({cls:"tps-nn-condition-field"});h.createEl("label",{text:"Field (Key)"});let m=h.createEl("input",{attr:{type:"text",placeholder:"status"}});m.value=String(a.field||""),m.addEventListener("blur",()=>{let g=this.getLiveRule(e);if(!g)return;let b=this.ensureRuleConditions(g)[o];b&&(b.field=m.value.trim(),i(!1))})}if(!(a.operator==="exists"||a.operator==="!exists"||a.operator==="is-not-empty"||a.operator==="has-open-checkboxes"||a.operator==="!has-open-checkboxes"||a.operator==="is-today"||a.operator==="!is-today")){let h=c.createDiv({cls:"tps-nn-condition-field tps-nn-condition-field-value"});h.createEl("label",{text:"Value"});let m=h.createEl("input",{attr:{type:"text",placeholder:q(a)}});m.value=String(a.value||""),m.addEventListener("blur",()=>{let g=this.getLiveRule(e);if(!g)return;let b=this.ensureRuleConditions(g)[o];b&&(b.value=m.value,i(!1))})}let v=c.createDiv({cls:"tps-nn-condition-field"}).createEl("button",{text:"\u2715",cls:"tps-nn-compact-btn mod-warning"});v.type="button",v.style.minHeight="30px",v.style.padding="0 8px",v.addEventListener("click",()=>{let h=this.getLiveRule(e);h&&(h.conditions=this.ensureRuleConditions(h).filter((m,g)=>g!==o),i(!1).then(()=>r()))})}),new M.Setting(t).setName("Add condition").addButton(a=>{a.setButtonText("+ Add condition").onClick(async()=>{let o=this.getLiveRule(e);o&&(this.ensureRuleConditions(o).push(j()),await i(!1),r())})})}openRuleActionsMenu(t,e,n){let{plugin:i,refresh:r,persistRuleChange:s}=this.context,a=this.getLiveRule(e);if(!a)return;let o=new M.Menu;o.addItem(l=>{l.setTitle(a.enabled?"Disable rule":"Enable rule").setIcon(a.enabled?"toggle-right":"toggle-left").onClick(()=>{(async()=>{let c=this.getLiveRule(e);c&&(c.enabled=!c.enabled,await s(!0),r())})()})}),o.addSeparator(),o.addItem(l=>{l.setTitle("Move up").setIcon("arrow-up").setDisabled(n===0).onClick(()=>{(async()=>{if(n===0)return;let c=i.settings.rules;[c[n-1],c[n]]=[c[n],c[n-1]],await s(!1),r()})()})}),o.addItem(l=>{l.setTitle("Move down").setIcon("arrow-down").setDisabled(n>=i.settings.rules.length-1).onClick(()=>{(async()=>{if(n>=i.settings.rules.length-1)return;let c=i.settings.rules;[c[n+1],c[n]]=[c[n],c[n+1]],await s(!1),r()})()})}),o.addItem(l=>{l.setTitle("Duplicate").setIcon("copy").onClick(()=>{(async()=>{let c=this.getLiveRule(e);if(!c)return;let d=i.createDefaultRule();d.name=c.name?`${c.name} (copy)`:"",d.enabled=c.enabled,d.property=c.property,d.operator=c.operator,d.value=c.value,d.pathPrefix=c.pathPrefix,d.icon=c.icon,d.color=c.color,d.match=c.match,d.conditions=this.ensureRuleConditions(c).map(p=>({...p})),i.settings.rules.splice(n+1,0,d),B=d.id,await s(!1),r()})()})}),o.addSeparator(),o.addItem(l=>{l.setTitle("Delete").setIcon("trash").onClick(()=>{(async()=>{var c,d;i.settings.rules=i.settings.rules.filter(p=>p.id!==e),B===e&&(B=(d=(c=i.settings.rules[0])==null?void 0:c.id)!=null?d:null),await s(!1),r()})()})}),this.showMenuBelowElement(o,t)}openIconPresetMenu(t,e){let{persistRuleChange:n,refresh:i}=this.context,r=this.getLiveRule(e);if(!r)return;let s=new M.Menu,a=this.getIconOptions(r.icon);for(let o of a)s.addItem(l=>{l.setTitle(o.label);let c=J(o.value);if(c)try{l.setIcon(c)}catch(d){}l.onClick(()=>{(async()=>{let d=this.getLiveRule(e);d&&(d.icon=o.value.trim(),await n(!0),i())})()})});this.showMenuBelowElement(s,t)}openColorPresetMenu(t,e){let{persistRuleChange:n,refresh:i}=this.context;if(!this.getLiveRule(e))return;let s=new M.Menu;for(let a of $e)s.addItem(o=>{o.setTitle(a||"(clear color)"),o.onClick(()=>{(async()=>{let l=this.getLiveRule(e);l&&(l.color=a,await n(!0),i())})()})});this.showMenuBelowElement(s,t)}getSelectedRule(t){if(t.length===0)return B=null,null;(!B||!t.some(n=>n.id===B))&&(B=t[0].id);let e=t.findIndex(n=>n.id===B);return e<0?null:{id:B,rule:t[e],index:e}}createActionButton(t,e,n,i=!1,r=!1){let s=t.createEl("button",{text:e});return s.type="button",s.disabled=r,i&&s.addClass("mod-cta"),s.addEventListener("click",()=>{n()}),s}createMenuButton(t,e,n,i=!1){let r=t.createEl("button",{text:e});return r.type="button",r.addEventListener("click",s=>{i&&(s.preventDefault(),s.stopPropagation()),n(r)}),r}createBadge(t,e){t.createSpan({cls:"tps-nn-badge",text:e})}showMenuBelowElement(t,e){let n=e.getBoundingClientRect();t.showAtPosition({x:n.left,y:n.bottom+4})}getLiveRule(t){var e;return(e=this.context.plugin.settings.rules.find(n=>n.id===t))!=null?e:null}isConditionRule(t){return Array.isArray(t.conditions)&&t.conditions.length>0}ensureRuleConditions(t){return Array.isArray(t.conditions)||(t.conditions=[]),t.conditions}convertRuleToConditionMode(t){if(this.isConditionRule(t)){t.match=P(t.match);return}let e=[],n=String(t.property||"").trim();n&&e.push({source:"frontmatter",field:n,operator:U(t.operator),value:String(t.value||"")});let i=String(t.pathPrefix||"").trim();i&&e.push({source:"path",field:"",operator:"starts",value:i}),e.length===0&&e.push(j()),t.conditions=e,t.match=P(t.match)}convertRuleToSimpleMode(t){let e=this.ensureRuleConditions(t),n=e.find(r=>r.source==="frontmatter"&&String(r.field||"").trim().length>0);n&&(t.property=String(n.field||"").trim(),t.operator=Re(n.operator),t.value=String(n.value||""));let i=e.find(r=>r.source==="path"&&(r.operator==="starts"||r.operator==="is"||r.operator==="contains")&&String(r.value||"").trim().length>0);i&&(t.pathPrefix=String(i.value||"").trim()),t.conditions=[],t.match="all"}getIconOptions(t){let{plugin:e}=this.context,n=new Map;for(let r of Ce)n.set(r.value,r.label);for(let r of e.settings.rules){let s=String(r.icon||"").trim();s&&!n.has(s)&&n.set(s,`${s} (custom)`)}let i=String(t||"").trim();return i&&!n.has(i)&&n.set(i,`${i} (current)`),Array.from(n.entries()).sort((r,s)=>r[0]===""?-1:s[0]===""?1:r[0].localeCompare(s[0])).map(([r,s])=>({value:r,label:s}))}tryRenderIcon(t,e){let n=String(e||"").trim();if(!n)return!1;try{return(0,M.setIcon)(t,n),!0}catch(i){return!1}}toColorPickerValue(t){let e=String(t||"").trim();if(!e)return null;let n=e.match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/);if(!n)return null;let i=n[1].toLowerCase();return i.length===3?`#${i.split("").map(r=>`${r}${r}`).join("")}`:i.length===8?`#${i.slice(0,6)}`:`#${i}`}getRuleSummary(t){return this.isConditionRule(t)?`${this.ensureRuleConditions(t).length} conditions (${t.match})`:`simple: ${String(t.property||"").trim()||"(property)"} ${t.operator}`}matchesFilter(t,e,n){let i=String(n||"").trim().toLowerCase();return i?[`rule ${e}`,this.getRuleSummary(t),t.enabled?"enabled":"disabled",this.isConditionRule(t)?"advanced":"simple",String(t.icon||""),String(t.color||"")].join(" ").toLowerCase().includes(i):!0}};var O=require("obsidian");var k={enabled:!0,autoApplyOnFileOpen:!0,autoApplyOnMetadataChange:!0,applyOnStartup:!0,startupDelayMs:800,metadataDebounceMs:150,syncTitleFromFilename:!1,syncFilenameFromTitle:!1,frontmatterIconField:"icon",frontmatterColorField:"color",upstreamLinkKeys:["parent"],frontmatterWriteExclusions:"",noteCheckboxIconColor:"",clearIconWhenNoMatch:!1,clearColorWhenNoMatch:!1,debugLogging:!1,rules:[],smartSort:{enabled:!1,field:"navigator_sort",separator:"_",appendBasename:!0,clearWhenNoMatch:!1,buckets:[]},hideRules:[]},We="rule",He="sort-segment";function ve(){return`${We}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}function ye(){return`${He}-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}function Ee(){return{id:ve(),name:"",enabled:!0,property:"status",operator:"is",value:"",pathPrefix:"",icon:"",color:"",match:"all",conditions:[]}}function ee(){return`bucket-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}function Me(){return{source:"frontmatter",field:"priority",type:"priority",direction:"asc",mappings:[],missingValuePlacement:"last"}}function Te(){return{id:ee(),enabled:!0,name:"New Bucket",match:"all",conditions:[],sortCriteria:[]}}function te(){return{id:ye(),enabled:!0,source:"frontmatter",field:"priority",fallback:"",mappings:[],match:"all",conditions:[]}}var N=null,be="",Ye="high=001, normal=002, low=003",_e="open=001, working=002, complete=003, wont-do=004",ne=class{constructor(t){this.context=t}render(t){let{plugin:e,bindCommittedText:n,refresh:i}=this.context,r=t.createDiv({cls:"tps-nn-section"});r.createEl("h3",{text:"Smart Sort Buckets"}),r.createEl("p",{cls:"setting-item-description",text:"Define buckets to group and sort notes. Files match the first bucket whose conditions they meet."}),r.createEl("div",{cls:"tps-nn-callout",text:"Buckets are evaluated top-to-bottom. Within each bucket, notes are sorted by the defined criteria."});let s=e.getSmartSortPreviewForActiveFile();r.createEl("p",{cls:"setting-item-description",text:s?`Active note key preview: ${s}`:"Active note key preview: (unavailable)"});let a=e.settings.smartSort;new O.Setting(r).setName("Enable smart sort key").setDesc("Write computed sort key to frontmatter.").addToggle(S=>{S.setValue(a.enabled).onChange(async v=>{a.enabled=v,await e.saveSettings(),await e.applyRulesToActiveFile(!1),i()})}),new O.Setting(r).setName("Sort key field").setDesc("Frontmatter key for computed sort key.").addText(S=>{S.setPlaceholder("navigator_sort"),n(S,a.field,async v=>{a.field=v.trim().replace(/\s+/g,"")||"navigator_sort"},!1,!0)}),new O.Setting(r).setName("Segment separator").setDesc("Delimiter used to join segments.").addText(S=>{S.setPlaceholder("_"),n(S,a.separator,async v=>{let h=v.trim();a.separator=h.slice(0,3)||"_"},!1,!0)}),new O.Setting(r).setName("Append basename").setDesc("Append note basename as final segment.").addToggle(S=>{S.setValue(a.appendBasename).onChange(async v=>{a.appendBasename=v,await e.saveSettings(),await e.applyRulesToActiveFile(!1),i()})}),new O.Setting(r).setName("Clear key when empty").setDesc("Remove sort field when no bucket matched.").addToggle(S=>{S.setValue(a.clearWhenNoMatch).onChange(async v=>{a.clearWhenNoMatch=v,await e.saveSettings(),await e.applyRulesToActiveFile(!1),i()})});let o=r.createDiv({cls:"tps-nn-toolbar"});if(this.createActionButton(o,"+ Add bucket",async()=>{let S=e.createDefaultSortBucket();e.settings.smartSort.buckets.push(S),N=S.id,await e.saveSettings(),i()},!0),this.createActionButton(o,"Apply active note",async()=>{await e.applyRulesToActiveFile(!0)}),a.buckets.length===0){r.createEl("p",{cls:"setting-item-description",text:"No buckets configured. Add a bucket to start organizing your notes."});return}let l=this.getSelectedBucket(a.buckets);if(!l)return;let c=r.createDiv({cls:"tps-nn-split"}),d=c.createDiv({cls:"tps-nn-list-pane"}),p=c.createDiv({cls:"tps-nn-editor-pane"}),f=d.createDiv({cls:"tps-nn-toolbar"}).createEl("input",{cls:"tps-nn-filter-input",attr:{type:"search",placeholder:"Filter buckets..."}});f.value=be,f.addEventListener("input",()=>{be=f.value.trim().toLowerCase(),i()});let R=a.buckets.map((S,v)=>({bucket:S,index:v})).filter(({bucket:S,index:v})=>this.matchesBucketFilter(S,v+1,be));R.length===0?d.createEl("p",{cls:"setting-item-description",text:"No buckets match the current filter."}):R.forEach(({bucket:S,index:v})=>{this.renderBucketListItem(d,S,v,l.id)}),this.renderBucketEditor(p,l.bucket,l.index)}renderBucketListItem(t,e,n,i){let r=t.createEl("button",{cls:"tps-nn-list-item"});r.type="button",e.id===i&&r.addClass("is-active"),r.addEventListener("click",()=>{N=e.id,this.context.refresh()});let s=e.name||`Bucket ${n+1}`;r.createDiv({cls:"tps-nn-list-item-title",text:`${n+1}. ${s}`}),r.createDiv({cls:"tps-nn-list-item-summary",text:this.getBucketSummary(e)}),r.createDiv({cls:"tps-nn-list-item-summary",text:e.enabled?"Enabled":"Disabled"})}renderBucketEditor(t,e,n){let{plugin:i,bindCommittedText:r,refresh:s}=this.context,a=e.id;t.createEl("h4",{text:`Editing Bucket ${n+1}`});let o=t.createDiv({cls:"tps-nn-toolbar"});this.createActionButton(o,"Previous",async()=>{let l=Math.max(0,n-1),c=i.settings.smartSort.buckets[l];c&&(N=c.id,s())},!1,n===0),this.createActionButton(o,"Next",async()=>{let l=Math.min(i.settings.smartSort.buckets.length-1,n+1),c=i.settings.smartSort.buckets[l];c&&(N=c.id,s())},!1,n>=i.settings.smartSort.buckets.length-1),this.createMenuButton(o,"Bucket actions",l=>{this.openBucketActionsMenu(l,e,n)}),new O.Setting(t).setName("Bucket name").setDesc("Descriptive name for this bucket.").addText(l=>{l.setPlaceholder("My Bucket"),r(l,e.name,async c=>{let d=this.getLiveBucket(a);d&&(d.name=c.trim())})}),new O.Setting(t).setName("Enabled").setDesc("Disable this bucket without deleting it.").addToggle(l=>{l.setValue(e.enabled).onChange(async c=>{let d=this.getLiveBucket(a);d&&(d.enabled=c,await i.saveSettings(),await i.applyRulesToActiveFile(!1),s())})}),this.renderBucketConditions(t,a,e),this.renderSortCriteria(t,a,e)}renderBucketConditions(t,e,n){let{plugin:i,refresh:r}=this.context;n.match=P(n.match);let s=this.ensureBucketConditions(n),a=t.createEl("details",{cls:"tps-nn-sub-collapsible"});a.open=s.length>0,a.createEl("summary",{text:"Bucket matching conditions"});let o=a.createDiv({cls:"tps-nn-sub-body"});o.createEl("p",{cls:"setting-item-description",text:"Define which notes belong in this bucket. If no conditions are set, all notes match."}),new O.Setting(o).setName("Match mode").setDesc("How to combine multiple conditions.").addDropdown(l=>{l.addOption("all","All conditions").addOption("any","Any condition").setValue(n.match).onChange(async c=>{let d=this.getLiveBucket(e);d&&(d.match=P(c),await i.saveSettings(),await i.applyRulesToActiveFile(!1))})}),s.length===0&&o.createEl("p",{cls:"setting-item-description",text:"No conditions configured; this bucket matches all notes."}),s.forEach((l,c)=>{this.renderCondition(o,e,l,c)}),new O.Setting(o).setName("Add condition").addButton(l=>{l.setButtonText("+ Add condition").onClick(async()=>{let c=this.getLiveBucket(e);c&&(this.ensureBucketConditions(c).push(j()),c.match=P(c.match),await i.saveSettings(),await i.applyRulesToActiveFile(!1),r())})})}renderCondition(t,e,n,i){let{plugin:r,refresh:s}=this.context,o=t.createDiv({cls:"tps-nn-condition-card"}).createDiv({cls:"tps-nn-condition-grid"}),l=o.createDiv({cls:"tps-nn-condition-field"});l.createEl("label",{text:"Source"});let c=l.createEl("select");for(let v of["frontmatter","path","extension","name","tag","body","backlink","date-created","date-modified"])c.createEl("option",{value:v,text:v});c.value=n.source,c.addEventListener("change",()=>{(async()=>{let v=this.getLiveBucket(e);if(!v)return;let h=this.ensureBucketConditions(v)[i];if(!h)return;h.source=Y(c.value),h.source!=="frontmatter"&&(h.field=""),K(h.source).includes(h.operator)||(h.operator="contains"),await r.saveSettings(),await r.applyRulesToActiveFile(!1),s()})()});let d=o.createDiv({cls:"tps-nn-condition-field"});d.createEl("label",{text:"Operator"});let p=d.createEl("select"),y=K(n.source);for(let v of y)p.createEl("option",{value:v,text:v});if(p.value=n.operator,y.includes(n.operator)||(p.value="contains"),p.addEventListener("change",()=>{(async()=>{let v=this.getLiveBucket(e);if(!v)return;let h=this.ensureBucketConditions(v)[i];if(!h)return;let m=U(p.value);h.operator=m,(m==="exists"||m==="!exists"||m==="is-not-empty"||m==="has-open-checkboxes"||m==="!has-open-checkboxes"||m==="is-today"||m==="!is-today")&&(h.value=""),await r.saveSettings(),await r.applyRulesToActiveFile(!1),s()})()}),n.source==="frontmatter"||n.source==="backlink"){let v=o.createDiv({cls:"tps-nn-condition-field"});v.createEl("label",{text:"Property"});let h=v.createEl("input",{attr:{type:"text",placeholder:n.source==="backlink"?"parent":"status"}});h.value=String(n.field||""),h.addEventListener("blur",()=>{(async()=>{let m=this.getLiveBucket(e);if(!m)return;let g=this.ensureBucketConditions(m)[i];g&&(g.field=h.value.trim(),await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()})}if(!(n.operator==="exists"||n.operator==="!exists"||n.operator==="is-not-empty"||n.operator==="has-open-checkboxes"||n.operator==="!has-open-checkboxes"||n.operator==="is-today"||n.operator==="!is-today")){let v=o.createDiv({cls:"tps-nn-condition-field tps-nn-condition-field-value"});v.createEl("label",{text:"Value"});let h=v.createEl("input",{attr:{type:"text",placeholder:q(n)}});h.value=String(n.value||""),h.addEventListener("blur",()=>{(async()=>{let m=this.getLiveBucket(e);if(!m)return;let g=this.ensureBucketConditions(m)[i];g&&(g.value=h.value,await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()})}let S=o.createDiv({cls:"tps-nn-condition-field"}).createEl("button",{text:"\u2715",cls:"tps-nn-compact-btn mod-warning"});S.type="button",S.style.minHeight="30px",S.style.padding="0 8px",S.addEventListener("click",()=>{(async()=>{let v=this.getLiveBucket(e);v&&(v.conditions=this.ensureBucketConditions(v).filter((h,m)=>m!==i),await r.saveSettings(),await r.applyRulesToActiveFile(!1),s())})()})}renderSortCriteria(t,e,n){let{plugin:i,bindCommittedText:r,refresh:s}=this.context,a=this.ensureSortCriteria(n),o=t.createEl("details",{cls:"tps-nn-sub-collapsible"});o.open=a.length>0,o.createEl("summary",{text:"Sort criteria (within bucket)"});let l=o.createDiv({cls:"tps-nn-sub-body"});l.createEl("p",{cls:"setting-item-description",text:"Define how notes are sorted within this bucket. Criteria are applied in order."}),a.length===0&&l.createEl("p",{cls:"setting-item-description",text:"No sort criteria configured; notes will be sorted by basename only."}),a.forEach((c,d)=>{this.renderSortCriterion(l,e,c,d)}),new O.Setting(l).setName("Add sort criterion").addButton(c=>{c.setButtonText("+ Add criterion").onClick(async()=>{let d=this.getLiveBucket(e);d&&(this.ensureSortCriteria(d).push(Me()),await i.saveSettings(),await i.applyRulesToActiveFile(!1),s())})})}renderSortCriterion(t,e,n,i){let{plugin:r,bindCommittedText:s,refresh:a}=this.context,o=t.createDiv({cls:"tps-nn-condition-card"}),l=o.createDiv({cls:"tps-nn-condition-head"});l.createEl("strong",{text:`Criterion ${i+1}`});let c=l.createDiv({cls:"tps-nn-inline-actions"});if(i>0){let m=c.createEl("button",{text:"\u2191",cls:"tps-nn-compact-btn"});m.type="button",m.addEventListener("click",()=>{(async()=>{let g=this.getLiveBucket(e);if(!g)return;let b=this.ensureSortCriteria(g);[b[i-1],b[i]]=[b[i],b[i-1]],await r.saveSettings(),await r.applyRulesToActiveFile(!1),a()})()})}if(i<this.ensureSortCriteria(this.getLiveBucket(e)||{sortCriteria:[]}).length-1){let m=c.createEl("button",{text:"\u2193",cls:"tps-nn-compact-btn"});m.type="button",m.addEventListener("click",()=>{(async()=>{let g=this.getLiveBucket(e);if(!g)return;let b=this.ensureSortCriteria(g);[b[i+1],b[i]]=[b[i],b[i+1]],await r.saveSettings(),await r.applyRulesToActiveFile(!1),a()})()})}let d=c.createEl("button",{text:"Delete",cls:"tps-nn-compact-btn"});d.type="button",d.addEventListener("click",()=>{(async()=>{let m=this.getLiveBucket(e);m&&(m.sortCriteria=this.ensureSortCriteria(m).filter((g,b)=>b!==i),await r.saveSettings(),await r.applyRulesToActiveFile(!1),a())})()});let p=o.createDiv({cls:"tps-nn-condition-grid"}),y=p.createDiv({cls:"tps-nn-condition-field"});y.createEl("label",{text:"Source"});let f=y.createEl("select");for(let m of["frontmatter","path","extension","name","tag"])f.createEl("option",{value:m,text:m});f.value=n.source,f.addEventListener("change",()=>{(async()=>{let m=this.getLiveBucket(e);if(!m)return;let g=this.ensureSortCriteria(m)[i];g&&(g.source=Y(f.value),g.source!=="frontmatter"&&(g.field=""),await r.saveSettings(),await r.applyRulesToActiveFile(!1),a())})()});let R=n.source==="frontmatter",S=n.source==="frontmatter"||n.source==="tag";if(R){let m=p.createDiv({cls:"tps-nn-condition-field"});m.createEl("label",{text:"Type"});let g=m.createEl("select");for(let b of["date","status","priority","text","number"])g.createEl("option",{value:b,text:b});g.value=n.type,g.addEventListener("change",()=>{(async()=>{let b=this.getLiveBucket(e);if(!b)return;let D=this.ensureSortCriteria(b)[i];D&&(D.type=g.value,await r.saveSettings(),await r.applyRulesToActiveFile(!1),a())})()})}if(n.source==="frontmatter"){let m=p.createDiv({cls:"tps-nn-condition-field"});m.createEl("label",{text:"Field"});let g=m.createEl("input",{attr:{type:"text",placeholder:"scheduled"}});g.value=String(n.field||""),g.addEventListener("blur",()=>{(async()=>{let b=this.getLiveBucket(e);if(!b)return;let D=this.ensureSortCriteria(b)[i];D&&(D.field=g.value.trim(),await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()})}let v=p.createDiv({cls:"tps-nn-condition-field"});v.createEl("label",{text:"Direction"});let h=v.createEl("select");if(h.createEl("option",{value:"asc",text:"Ascending"}),h.createEl("option",{value:"desc",text:"Descending"}),h.value=n.direction,h.addEventListener("change",()=>{(async()=>{let m=this.getLiveBucket(e);if(!m)return;let g=this.ensureSortCriteria(m)[i];g&&(g.direction=h.value,await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()}),S){let m=p.createDiv({cls:"tps-nn-condition-field"});m.createEl("label",{text:"Missing values"});let g=m.createEl("select");g.createEl("option",{value:"last",text:"Sort last"}),g.createEl("option",{value:"first",text:"Sort first"}),g.value=n.missingValuePlacement,g.addEventListener("change",()=>{(async()=>{let W=this.getLiveBucket(e);if(!W)return;let H=this.ensureSortCriteria(W)[i];H&&(H.missingValuePlacement=g.value,await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()});let b=p.createDiv({cls:"tps-nn-condition-field tps-nn-condition-field-value"});b.createEl("label",{text:"Value mappings (optional)"});let D=b.createEl("input",{attr:{type:"text",placeholder:"high=001, normal=002, low=003"}});D.value=ke(n.mappings),D.addEventListener("blur",()=>{(async()=>{let W=this.getLiveBucket(e);if(!W)return;let H=this.ensureSortCriteria(W)[i];H&&(H.mappings=X(D.value),await r.saveSettings(),await r.applyRulesToActiveFile(!1))})()})}if(R&&(n.type==="priority"||n.type==="status")){let m=o.createDiv({cls:"tps-nn-toolbar"});n.type==="priority"&&this.createActionButton(m,"Priority preset",async()=>{let g=this.getLiveBucket(e);if(!g)return;let b=this.ensureSortCriteria(g)[i];b&&(b.mappings=X(Ye),await r.saveSettings(),await r.applyRulesToActiveFile(!1),a())}),n.type==="status"&&this.createActionButton(m,"Status preset",async()=>{let g=this.getLiveBucket(e);if(!g)return;let b=this.ensureSortCriteria(g)[i];b&&(b.mappings=X(_e),await r.saveSettings(),await r.applyRulesToActiveFile(!1),a())})}}openBucketActionsMenu(t,e,n){let{plugin:i,refresh:r}=this.context,s=new O.Menu;s.addItem(a=>{a.setTitle(e.enabled?"Disable bucket":"Enable bucket").setIcon(e.enabled?"toggle-right":"toggle-left").onClick(()=>{(async()=>(e.enabled=!e.enabled,await i.saveSettings(),await i.applyRulesToActiveFile(!1),r()))()})}),s.addSeparator(),s.addItem(a=>{a.setTitle("Move up").setIcon("arrow-up").setDisabled(n===0).onClick(()=>{(async()=>{if(n===0)return;let o=i.settings.smartSort.buckets;[o[n-1],o[n]]=[o[n],o[n-1]],await i.saveSettings(),r()})()})}),s.addItem(a=>{a.setTitle("Move down").setIcon("arrow-down").setDisabled(n>=i.settings.smartSort.buckets.length-1).onClick(()=>{(async()=>{if(n>=i.settings.smartSort.buckets.length-1)return;let o=i.settings.smartSort.buckets;[o[n+1],o[n]]=[o[n],o[n+1]],await i.saveSettings(),r()})()})}),s.addItem(a=>{a.setTitle("Duplicate").setIcon("copy").onClick(()=>{(async()=>{let o=i.createDefaultSortBucket();o.enabled=e.enabled,o.name=`${e.name} (copy)`,o.match=P(e.match),o.conditions=this.ensureBucketConditions(e).map(l=>({...l})),o.sortCriteria=this.ensureSortCriteria(e).map(l=>({...l,mappings:l.mappings.map(c=>({...c}))})),i.settings.smartSort.buckets.splice(n+1,0,o),N=o.id,await i.saveSettings(),r()})()})}),s.addSeparator(),s.addItem(a=>{a.setTitle("Delete").setIcon("trash").onClick(()=>{(async()=>{var o,l;i.settings.smartSort.buckets=i.settings.smartSort.buckets.filter(c=>c.id!==e.id),N===e.id&&(N=(l=(o=i.settings.smartSort.buckets[0])==null?void 0:o.id)!=null?l:null),await i.saveSettings(),r()})()})}),this.showMenuBelowElement(s,t)}getSelectedBucket(t){if(t.length===0)return N=null,null;(!N||!t.some(n=>n.id===N))&&(N=t[0].id);let e=t.findIndex(n=>n.id===N);return e<0?null:{id:N,bucket:t[e],index:e}}getLiveBucket(t){var e;return(e=this.context.plugin.settings.smartSort.buckets.find(n=>n.id===t))!=null?e:null}ensureBucketConditions(t){return Array.isArray(t.conditions)||(t.conditions=[]),t.conditions}ensureSortCriteria(t){return Array.isArray(t.sortCriteria)||(t.sortCriteria=[]),t.sortCriteria}matchesBucketFilter(t,e,n){if(!n)return!0;let i=(t.name||"").toLowerCase(),r=String(e);return i.includes(n)||r.includes(n)}getBucketSummary(t){var i,r,s,a;let e=(r=(i=t.conditions)==null?void 0:i.length)!=null?r:0,n=(a=(s=t.sortCriteria)==null?void 0:s.length)!=null?a:0;return`${e} condition(s), ${n} sort criterion/criteria`}createActionButton(t,e,n,i=!1,r=!1){let s=t.createEl("button",{text:e});return s.type="button",s.disabled=r,i&&s.addClass("mod-cta"),s.addEventListener("click",()=>{n()}),s}createMenuButton(t,e,n,i=!1){let r=t.createEl("button",{text:e});return r.type="button",r.addEventListener("click",s=>{i&&(s.preventDefault(),s.stopPropagation()),n(r)}),r}showMenuBelowElement(t,e){let n=e.getBoundingClientRect();t.showAtPosition({x:n.left,y:n.bottom+4})}};var z=require("obsidian");var I=null,Se="",ie=class{constructor(t){this.context=t}render(t){let{plugin:e,refresh:n,persistRuleChange:i}=this.context,r=t.createDiv({cls:"tps-nn-section"});r.createEl("h3",{text:"Hide Rules"}),r.createEl("p",{cls:"setting-item-description",text:"Automatically add or remove specific tags (like '#hide') based on file criteria."});let s=r.createDiv({cls:"tps-nn-toolbar"});if(this.createActionButton(s,"+ Add hide rule",async()=>{let f=e.createDefaultHideRule();e.settings.hideRules.push(f),I=f.id,await i(!1),n()},!0),this.createActionButton(s,"Apply active note",async()=>{await e.applyRulesToActiveFile(!0)}),e.settings.hideRules.length===0){r.createEl("p",{cls:"setting-item-description",text:"No hide rules configured."});return}let a=this.getSelectedRule(e.settings.hideRules);if(!a)return;let o=r.createDiv({cls:"tps-nn-split"}),l=o.createDiv({cls:"tps-nn-list-pane"}),c=o.createDiv({cls:"tps-nn-editor-pane"}),p=l.createDiv({cls:"tps-nn-toolbar"}).createEl("input",{cls:"tps-nn-filter-input",attr:{type:"search",placeholder:"Filter rules..."}});p.value=Se,p.addEventListener("input",()=>{Se=p.value.trim().toLowerCase(),n()});let y=e.settings.hideRules.map((f,R)=>({rule:f,index:R})).filter(({rule:f,index:R})=>this.matchesFilter(f,R+1,Se));y.length===0?l.createEl("p",{cls:"setting-item-description",text:"No rules match the current filter."}):y.forEach(({rule:f,index:R})=>{this.renderRuleListItem(l,f,R,a.id)}),this.renderRuleEditor(c,a.rule,a.index)}renderRuleListItem(t,e,n,i){let r=t.createEl("button",{cls:"tps-nn-list-item"});r.type="button",e.id===i&&r.addClass("is-active"),r.addEventListener("click",()=>{I=e.id,this.context.refresh()});let s=r.createDiv({cls:"tps-nn-list-item-title",text:`${n+1}. ${e.name||"Untitled Rule"}`});e.enabled||s.addClass("is-muted");let a=e.mode==="add"?"Adds":"Removes",o=e.tagName?e.tagName.startsWith("#")?e.tagName:`#${e.tagName}`:"#???";r.createDiv({cls:"tps-nn-list-item-summary",text:`${a} ${o}`}),r.createDiv({cls:"tps-nn-list-item-summary",text:e.enabled?"Enabled":"Disabled"})}renderRuleEditor(t,e,n){let{plugin:i,bindCommittedText:r,refresh:s,persistRuleChange:a}=this.context,o=e.id;t.createEl("h4",{text:`Editing Rule ${n+1}`});let l=t.createDiv({cls:"tps-nn-toolbar"});this.createActionButton(l,"Previous",async()=>{let p=Math.max(0,n-1),y=i.settings.hideRules[p];y&&(I=y.id,s())},!1,n===0),this.createActionButton(l,"Next",async()=>{let p=Math.min(i.settings.hideRules.length-1,n+1),y=i.settings.hideRules[p];y&&(I=y.id,s())},!1,n>=i.settings.hideRules.length-1),this.createMenuButton(l,"Rule actions",p=>{this.openRuleActionsMenu(p,o,n)}),new z.Setting(t).setName("Rule name").setDesc("Descriptive name for this rule.").addText(p=>{p.setPlaceholder("Hide archived notes"),r(p,e.name,async y=>{let f=this.getLiveRule(o);f&&(f.name=y.trim())},!0)}),new z.Setting(t).setName("Enabled").setDesc("Disable without deleting the rule.").addToggle(p=>{p.setValue(e.enabled).onChange(async y=>{let f=this.getLiveRule(o);f&&(f.enabled=y,await a(!0),s())})}),new z.Setting(t).setName("Action mode").setDesc("Whether to add or remove the tag when conditions match.").addDropdown(p=>{p.addOption("add","Add tag").addOption("remove","Remove tag").setValue(e.mode).onChange(async y=>{let f=this.getLiveRule(o);f&&(f.mode=y,await a(!0),s())})}),new z.Setting(t).setName("Tag name").setDesc("The tag to add or remove (e.g. 'hide' or '#hide').").addText(p=>{p.setPlaceholder("hide"),r(p,e.tagName,async y=>{let f=this.getLiveRule(o);f&&(f.tagName=y.trim().replace(/^#+/,""))},!1,!0)});let c=t.createEl("details",{cls:"tps-nn-sub-collapsible"});c.open=!0,c.createEl("summary",{text:"Match Criteria"});let d=c.createDiv({cls:"tps-nn-sub-body"});this.renderConditionCriteria(d,o,e)}renderConditionCriteria(t,e,n){let{persistRuleChange:i,refresh:r}=this.context,s=this.ensureRuleConditions(n);n.match=P(n.match),new z.Setting(t).setName("Match mode").addDropdown(a=>{a.addOption("all","All conditions").addOption("any","Any condition").setValue(n.match).onChange(async o=>{let l=this.getLiveRule(e);l&&(l.match=P(o),await i(!0))})}),s.length===0&&t.createEl("p",{cls:"setting-item-description",text:"No conditions configured (matches all files)."}),s.forEach((a,o)=>{let c=t.createDiv({cls:"tps-nn-condition-card"}).createDiv({cls:"tps-nn-condition-grid"}),d=c.createDiv({cls:"tps-nn-condition-field"});d.createEl("label",{text:"Source"});let p=d.createEl("select");for(let h of["frontmatter","path","extension","name","tag","body","backlink"])p.createEl("option",{value:h,text:h});p.value=a.source,p.addEventListener("change",()=>{let h=this.getLiveRule(e);if(!h)return;let m=this.ensureRuleConditions(h)[o];m&&(m.source=Y(p.value),m.source!=="frontmatter"&&(m.field=""),i(!1).then(()=>r()))});let y=c.createDiv({cls:"tps-nn-condition-field"});y.createEl("label",{text:"Operator"});let f=y.createEl("select");for(let h of K(a.source))f.createEl("option",{value:h,text:h});if(f.value=a.operator,f.addEventListener("change",()=>{let h=this.getLiveRule(e);if(!h)return;let m=this.ensureRuleConditions(h)[o];if(!m)return;let g=U(f.value);m.operator=g,(g==="exists"||g==="!exists"||g==="is-not-empty"||g==="has-open-checkboxes"||g==="!has-open-checkboxes"||g==="is-today"||g==="!is-today")&&(m.value=""),i(!0).then(()=>r())}),a.source==="frontmatter"){let h=c.createDiv({cls:"tps-nn-condition-field"});h.createEl("label",{text:"Field"});let m=h.createEl("input",{attr:{type:"text",placeholder:"status"}});m.value=String(a.field||""),m.addEventListener("blur",()=>{let g=this.getLiveRule(e);if(!g)return;let b=this.ensureRuleConditions(g)[o];b&&(b.field=m.value.trim(),i(!1))})}if(!(a.operator==="exists"||a.operator==="!exists"||a.operator==="is-not-empty"||a.operator==="has-open-checkboxes"||a.operator==="!has-open-checkboxes"||a.operator==="is-today"||a.operator==="!is-today")){let h=c.createDiv({cls:"tps-nn-condition-field tps-nn-condition-field-value"});h.createEl("label",{text:"Value"});let m=h.createEl("input",{attr:{type:"text",placeholder:q(a)}});m.value=String(a.value||""),m.addEventListener("blur",()=>{let g=this.getLiveRule(e);if(!g)return;let b=this.ensureRuleConditions(g)[o];b&&(b.value=m.value,i(!1))})}let v=c.createDiv({cls:"tps-nn-condition-field"}).createEl("button",{text:"\u2715",cls:"tps-nn-compact-btn mod-warning"});v.type="button",v.style.minHeight="30px",v.style.padding="0 8px",v.addEventListener("click",()=>{let h=this.getLiveRule(e);h&&(h.conditions=this.ensureRuleConditions(h).filter((m,g)=>g!==o),i(!1).then(()=>r()))})}),new z.Setting(t).setName("Add condition").addButton(a=>{a.setButtonText("+ Add condition").onClick(async()=>{let o=this.getLiveRule(e);o&&(this.ensureRuleConditions(o).push(j()),await i(!1),r())})})}openRuleActionsMenu(t,e,n){let{plugin:i,refresh:r,persistRuleChange:s}=this.context,a=this.getLiveRule(e);if(!a)return;let o=new z.Menu;o.addItem(l=>{l.setTitle(a.enabled?"Disable rule":"Enable rule").setIcon(a.enabled?"toggle-right":"toggle-left").onClick(()=>{(async()=>{let c=this.getLiveRule(e);c&&(c.enabled=!c.enabled,await s(!0),r())})()})}),o.addSeparator(),o.addItem(l=>{l.setTitle("Move up").setIcon("arrow-up").setDisabled(n===0).onClick(()=>{(async()=>{if(n===0)return;let c=i.settings.hideRules;[c[n-1],c[n]]=[c[n],c[n-1]],await s(!1),r()})()})}),o.addItem(l=>{l.setTitle("Move down").setIcon("arrow-down").setDisabled(n>=i.settings.hideRules.length-1).onClick(()=>{(async()=>{if(n>=i.settings.hideRules.length-1)return;let c=i.settings.hideRules;[c[n+1],c[n]]=[c[n],c[n+1]],await s(!1),r()})()})}),o.addItem(l=>{l.setTitle("Duplicate").setIcon("copy").onClick(()=>{(async()=>{let c=this.getLiveRule(e);if(!c)return;let d=i.createDefaultHideRule();d.name=c.name+" (Copy)",d.enabled=c.enabled,d.mode=c.mode,d.tagName=c.tagName,d.match=c.match,d.conditions=this.ensureRuleConditions(c).map(p=>({...p})),i.settings.hideRules.splice(n+1,0,d),I=d.id,await s(!1),r()})()})}),o.addSeparator(),o.addItem(l=>{l.setTitle("Delete").setIcon("trash").onClick(()=>{(async()=>{var c,d;i.settings.hideRules=i.settings.hideRules.filter(p=>p.id!==e),I===e&&(I=(d=(c=i.settings.hideRules[0])==null?void 0:c.id)!=null?d:null),await s(!1),r()})()})}),this.showMenuBelowElement(o,t)}getSelectedRule(t){if(t.length===0)return I=null,null;(!I||!t.some(n=>n.id===I))&&(I=t[0].id);let e=t.findIndex(n=>n.id===I);return e<0?null:{id:I,rule:t[e],index:e}}createActionButton(t,e,n,i=!1,r=!1){let s=t.createEl("button",{text:e});return s.type="button",s.disabled=r,i&&s.addClass("mod-cta"),s.addEventListener("click",()=>{n()}),s}createMenuButton(t,e,n){let i=t.createEl("button",{cls:"clickable-icon"});return i.type="button",i.ariaLabel=e,(0,z.setIcon)(i,"more-horizontal"),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),n(i)}),i}showMenuBelowElement(t,e){let n=e.getBoundingClientRect();t.showAtPosition({x:n.left,y:n.bottom+4})}getLiveRule(t){var e;return(e=this.context.plugin.settings.hideRules.find(n=>n.id===t))!=null?e:null}ensureRuleConditions(t){return t.conditions||(t.conditions=[]),t.conditions}matchesFilter(t,e,n){return n?`${e} ${t.name} ${t.tagName}`.toLowerCase().includes(n):!0}};var Ue=300,Fe="tps-nn-companion-settings-style",re=class extends T.PluginSettingTab{constructor(e,n){super(e,n);this.textDebouncer=new G;this.bindCommittedText=(e,n,i,r=!1,s=!1)=>{let a=n!=null?n:"",o=a,l=async()=>{o!==a&&(await i(o),a=o,await this.plugin.saveSettings(),s&&await this.plugin.applyRulesToActiveFile(!1),r&&this.render())};e.setValue(a);let c=`text:${Math.random().toString(36).slice(2,9)}`;e.onChange(d=>{o=d,this.textDebouncer.schedule(c,Ue,async()=>{await l()})}),e.inputEl.addEventListener("blur",()=>{this.textDebouncer.cancel(c),l()}),e.inputEl.addEventListener("keydown",d=>{if(d.key==="Enter"){d.preventDefault(),e.inputEl.blur();return}d.key==="Escape"&&(d.preventDefault(),this.textDebouncer.cancel(c),o=a,e.setValue(a),e.inputEl.blur())})};this.plugin=n}display(){this.render()}hide(){this.textDebouncer.cancelAll()}render(){let{containerEl:e}=this;e.empty(),this.ensureSettingsStyles(),e.createEl("h2",{text:"TPS Notebook Navigator Companion"}),e.createEl("p",{cls:"setting-item-description",text:"Data steward for Notebook Navigator. Applies frontmatter icon/color plus optional computed sort key for consistent sorting/grouping."}),this.renderGeneralSettings(e);let n={plugin:this.plugin,bindCommittedText:this.bindCommittedText.bind(this),refresh:()=>this.display(),persistRuleChange:(i=!1)=>this.persistRuleChange(i)};new ne(n).render(e),new ie(n).render(e),new Z(n).render(e)}renderGeneralSettings(e){new T.Setting(e).setName("Enable automation").setDesc("Apply configured rules to markdown files.").addToggle(r=>{r.setValue(this.plugin.settings.enabled).onChange(async s=>{this.plugin.settings.enabled=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Auto-apply on file open").setDesc("Evaluate and apply rules when a file becomes active.").addToggle(r=>{r.setValue(this.plugin.settings.autoApplyOnFileOpen).onChange(async s=>{this.plugin.settings.autoApplyOnFileOpen=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Auto-apply on metadata change").setDesc("Evaluate and apply rules after frontmatter changes.").addToggle(r=>{r.setValue(this.plugin.settings.autoApplyOnMetadataChange).onChange(async s=>{this.plugin.settings.autoApplyOnMetadataChange=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Startup vault scan").setDesc("Startup scanning is now managed by the TPS-Controller plugin.").setDisabled(!0),new T.Setting(e).setName("Metadata debounce (ms)").setDesc("Debounce for metadata-change events before re-applying rules.").addText(r=>{r.setPlaceholder("350"),this.bindCommittedText(r,String(this.plugin.settings.metadataDebounceMs),async s=>{let a=Number.parseInt(s,10);this.plugin.settings.metadataDebounceMs=Number.isFinite(a)?Math.max(0,Math.min(a,5e3)):350})}),new T.Setting(e).setName("Sync title from filename").setDesc("Update frontmatter `title` when a file is renamed. Disabled by default to avoid surprise metadata writes.").addToggle(r=>{r.setValue(this.plugin.settings.syncTitleFromFilename).onChange(async s=>{this.plugin.settings.syncTitleFromFilename=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Sync filename from title").setDesc("Rename files when frontmatter `title` changes. Disabled by default because it is a high-impact write path.").addToggle(r=>{r.setValue(this.plugin.settings.syncFilenameFromTitle).onChange(async s=>{this.plugin.settings.syncFilenameFromTitle=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Frontmatter icon field").setDesc("Frontmatter key used to store icon value.").addText(r=>{r.setPlaceholder("icon"),this.bindCommittedText(r,this.plugin.settings.frontmatterIconField,async s=>{this.plugin.settings.frontmatterIconField=s.trim().replace(/\s+/g,"")||"icon"},!1,!0)}),new T.Setting(e).setName("Frontmatter color field").setDesc("Frontmatter key used to store color value.").addText(r=>{r.setPlaceholder("color"),this.bindCommittedText(r,this.plugin.settings.frontmatterColorField,async s=>{this.plugin.settings.frontmatterColorField=s.trim().replace(/\s+/g,"")||"color"},!1,!0)}),new T.Setting(e).setName("Upstream link keys").setDesc("Comma-separated list of frontmatter keys (e.g. 'parent, project') that should trigger updates on the linked note when modified.").addText(r=>{r.setPlaceholder("parent"),this.bindCommittedText(r,this.plugin.settings.upstreamLinkKeys.join(", "),async s=>{this.plugin.settings.upstreamLinkKeys=s.split(/[\n,]+/).map(a=>a.trim()).filter(Boolean)},!1,!1)}),new T.Setting(e).setName("Frontmatter write exclusions").setDesc("Skip companion frontmatter writes for matching files. One pattern per line. Supports exact paths, folder prefixes (end with /), wildcards (*), name:<basename>, and re:<regex>.").addTextArea(r=>{r.setValue(this.plugin.settings.frontmatterWriteExclusions||"").setPlaceholder(`System/Templates/
System/*
name:daily-template
re:^System/`).onChange(async s=>{this.plugin.settings.frontmatterWriteExclusions=s,await this.plugin.saveSettings()})});let n=null,i=null;new T.Setting(e).setName('Navigator "note includes checkboxes" icon color').setDesc('Overrides Notebook Navigator system icon color for notes with checkboxes (`interfaceIcons["file-unfinished-task"]`). Leave blank to use Navigator default.').addColorPicker(r=>{var s;i=r,r.setValue((s=this.toPickerHexColor(this.plugin.settings.noteCheckboxIconColor))!=null?s:"#7a7a7a"),r.onChange(async a=>{this.plugin.settings.noteCheckboxIconColor=a,n&&n.setValue(a),await this.plugin.saveSettings()})}).addText(r=>{n=r,r.setPlaceholder("#4caf50 or var(--interactive-accent)"),this.bindCommittedText(r,this.plugin.settings.noteCheckboxIconColor,async s=>{let a=s.trim();this.plugin.settings.noteCheckboxIconColor=a;let o=this.toPickerHexColor(a);o&&i&&i.setValue(o)})}),new T.Setting(e).setName("Clear icon when no match").setDesc("Remove icon field when no icon rule matches.").addToggle(r=>{r.setValue(this.plugin.settings.clearIconWhenNoMatch).onChange(async s=>{this.plugin.settings.clearIconWhenNoMatch=s,await this.plugin.saveSettings(),await this.plugin.applyRulesToActiveFile(!1)})}),new T.Setting(e).setName("Clear color when no match").setDesc("Remove color field when no color rule matches.").addToggle(r=>{r.setValue(this.plugin.settings.clearColorWhenNoMatch).onChange(async s=>{this.plugin.settings.clearColorWhenNoMatch=s,await this.plugin.saveSettings(),await this.plugin.applyRulesToActiveFile(!1)})}),new T.Setting(e).setName("Debug logging").setDesc("Emit verbose diagnostics to Developer Console.").addToggle(r=>{r.setValue(this.plugin.settings.debugLogging).onChange(async s=>{this.plugin.settings.debugLogging=s,await this.plugin.saveSettings()})}),new T.Setting(e).setName("Manual apply").setDesc("Apply rules immediately.").addButton(r=>{r.setButtonText("Active file").onClick(async()=>{await this.plugin.applyRulesToActiveFile(!0)})}).addButton(r=>{r.setButtonText("All markdown files").onClick(async()=>{await this.plugin.applyRulesToAllFiles(!0)})})}async persistRuleChange(e=!1){await this.plugin.saveSettings(),e&&await this.plugin.applyRulesToActiveFile(!1)}ensureSettingsStyles(){if(document.getElementById(Fe))return;let e=document.createElement("style");e.id=Fe,e.textContent=`
      .tps-nn-section {
        margin: 18px 0;
        padding: 14px;
        border: 1px solid var(--background-modifier-border);
        border-radius: 12px;
        background: color-mix(in srgb, var(--background-secondary) 60%, transparent);
      }

      .tps-nn-section > h3 {
        margin-top: 0;
      }

      .tps-nn-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 10px 0 14px;
      }

      .tps-nn-toolbar button,
      .tps-nn-inline-actions button {
        border-radius: 8px;
      }

      .tps-nn-split {
        display: grid;
        grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
        gap: 12px;
      }

      .tps-nn-list-pane {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .tps-nn-filter-input {
        width: 100%;
        min-height: 32px;
        border-radius: 8px;
        border: 1px solid var(--background-modifier-border);
        padding: 0 10px;
        background: var(--background-primary);
        color: var(--text-normal);
      }

      .tps-nn-editor-pane {
        border: 1px solid var(--background-modifier-border);
        border-radius: 10px;
        padding: 10px;
        background: color-mix(in srgb, var(--background-primary) 85%, transparent);
      }

      .tps-nn-list-item {
        width: 100%;
        border: 1px solid var(--background-modifier-border);
        border-radius: 10px;
        padding: 8px;
        background: var(--background-primary);
        text-align: left;
      }

      .tps-nn-list-item.is-active {
        border-color: var(--interactive-accent);
        box-shadow: inset 0 0 0 1px var(--interactive-accent);
      }

      .tps-nn-list-item-title-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tps-nn-list-item-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      .tps-nn-list-item-icon svg {
        width: 16px;
        height: 16px;
      }

      .tps-nn-list-item-title {
        font-weight: 700;
        color: var(--text-accent);
      }

      .tps-nn-list-item-title.is-muted {
        color: var(--text-muted);
      }

      .tps-nn-list-item-summary {
        margin-top: 3px;
        color: var(--text-muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tps-nn-badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0;
      }

      .tps-nn-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: var(--background-modifier-border-hover);
        color: var(--text-muted);
      }

      .tps-nn-rule-card,
      .tps-nn-sort-card {
        border: 1px solid var(--background-modifier-border);
        border-radius: 10px;
        padding: 0;
        margin: 12px 0;
        background: var(--background-primary);
      }

      .tps-nn-collapsible {
        border-radius: 10px;
      }

      .tps-nn-collapsible summary::-webkit-details-marker {
        display: none;
      }

      .tps-nn-collapsible-summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        padding: 10px;
        border-radius: 10px;
        background: color-mix(in srgb, var(--background-secondary) 75%, transparent);
      }

      .tps-nn-collapsible-summary::before {
        content: "\u25B8";
        margin-right: 6px;
        color: var(--text-faint);
      }

      .tps-nn-collapsible[open] > .tps-nn-collapsible-summary::before {
        content: "\u25BE";
      }

      .tps-nn-collapsible-title-wrap {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 220px;
      }

      .tps-nn-collapsible-body {
        padding: 10px;
      }

      .tps-nn-rule-header,
      .tps-nn-sort-header {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .tps-nn-rule-title,
      .tps-nn-sort-title {
        margin: 0;
      }

      .tps-nn-inline-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tps-nn-summary {
        margin: 0 0 10px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .tps-nn-divider {
        margin: 10px 0;
        border-top: 1px dashed var(--background-modifier-border);
      }

      .tps-nn-subsection-title {
        margin: 6px 0;
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }

      .tps-nn-icon-choices,
      .tps-nn-color-swatches {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0 4px;
      }

      .tps-nn-icon-choice {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border-radius: 7px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-secondary);
      }

      .tps-nn-icon-choice.is-active {
        border-color: var(--interactive-accent);
        box-shadow: inset 0 0 0 1px var(--interactive-accent);
      }

      .tps-nn-swatch {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        border: 1px solid var(--background-modifier-border);
      }

      .tps-nn-swatch.is-active {
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--interactive-accent) 60%, transparent);
      }

      .tps-nn-condition-card {
        border: 1px solid var(--background-modifier-border);
        border-radius: 8px;
        padding: 6px;
        margin: 8px 0;
        background: color-mix(in srgb, var(--background-secondary) 55%, transparent);
      }

      .tps-nn-condition-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }

      .tps-nn-compact-btn {
        min-height: 28px;
        padding: 0 10px;
        border-radius: 8px;
      }

      .tps-nn-condition-grid {
        display: grid;
        grid-template-columns: minmax(110px, 1fr) minmax(110px, 1fr) minmax(120px, 1.3fr) minmax(160px, 2fr) auto;
        gap: 8px;
        align-items: center;
      }

      .tps-nn-condition-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .tps-nn-condition-field-value {
        grid-column: auto;
      }

      .tps-nn-condition-field label {
        display: none;
      }

      .tps-nn-condition-field input,
      .tps-nn-condition-field select {
        width: 100%;
        min-height: 30px;
        border-radius: 8px;
        border: 1px solid var(--background-modifier-border);
        background: var(--background-primary);
        color: var(--text-normal);
        padding: 0 8px;
      }

      .tps-nn-sub-collapsible {
        margin: 10px 0;
        border: 1px dashed var(--background-modifier-border);
        border-radius: 8px;
      }

      .tps-nn-sub-collapsible > summary {
        cursor: pointer;
        list-style: none;
        padding: 8px;
        color: var(--text-muted);
        font-weight: 600;
      }

      .tps-nn-sub-collapsible > summary::-webkit-details-marker {
        display: none;
      }

      .tps-nn-sub-collapsible > summary::before {
        content: "+";
        margin-right: 6px;
        color: var(--text-faint);
      }

      .tps-nn-sub-collapsible[open] > summary::before {
        content: "\u2212";
      }

      .tps-nn-sub-body {
        padding: 0 8px 8px;
      }

      .tps-nn-callout {
        margin: 10px 0;
        padding: 8px 10px;
        border-left: 3px solid var(--interactive-accent);
        background: color-mix(in srgb, var(--interactive-accent) 10%, transparent);
        border-radius: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }

      @media (max-width: 900px) {
        .tps-nn-split {
          grid-template-columns: 1fr;
        }

        .tps-nn-condition-grid {
          grid-template-columns: 1fr;
        }
        
        .tps-nn-condition-field label {
          display: block;
          font-size: 11px;
          color: var(--text-muted);
        }
      }
    `,document.head.appendChild(e)}toPickerHexColor(e){let n=String(e!=null?e:"").trim().replace(/^#/,"");return/^[0-9a-fA-F]{3}$/.test(n)?`#${n.split("").map(r=>`${r}${r}`).join("").toLowerCase()}`:/^[0-9a-fA-F]{6}$/.test(n)?`#${n.toLowerCase()}`:/^[0-9a-fA-F]{8}$/.test(n)?`#${n.slice(0,6).toLowerCase()}`:null}};var se=class{constructor(t){this.prefix=t.prefix,this.debugEnabled=t.debugEnabled}debug(t,e){if(this.debugEnabled()){if(e){console.info(`[${this.prefix}] ${t}`,e);return}console.info(`[${this.prefix}] ${t}`)}}info(t,e){if(e){console.info(`[${this.prefix}] ${t}`,e);return}console.info(`[${this.prefix}] ${t}`)}warn(t,e){if(e){console.warn(`[${this.prefix}] ${t}`,e);return}console.warn(`[${this.prefix}] ${t}`)}error(t,e,n){if(n&&e!==void 0){console.error(`[${this.prefix}] ${t}`,{...n,error:e});return}if(e!==void 0){console.error(`[${this.prefix}] ${t}`,e);return}if(n){console.error(`[${this.prefix}] ${t}`,n);return}console.error(`[${this.prefix}] ${t}`)}};var oe=require("obsidian"),_=class _{constructor(t){this.app=t}resolveVisualOutputs(t,e){let n={matched:!1,value:"",ruleId:null},i={matched:!1,value:"",ruleId:null};for(let r of t)if(r.enabled&&this.matchesRule(r,e)){if(!n.matched){let s=String(r.icon||"").trim();s&&(n.matched=!0,n.value=s,n.ruleId=r.id)}if(!i.matched){let s=String(r.color||"").trim();s&&(i.matched=!0,i.value=s,i.ruleId=r.id)}if(n.matched&&i.matched)break}return{icon:n,color:i}}composeSortKey(t,e){let n=String(t.separator||"").trim()||"_",i=[],r=null,s=-1;for(let o=0;o<t.buckets.length;o++){let l=t.buckets[o];if(l.enabled&&this.matchesBucket(l,e)){r=l,s=o;break}}if(r){i.push(String(s).padStart(3,"0"));for(let o of r.sortCriteria){let l=this.getSortCriteriaValue(o,e),c=this.normalizeSortKeyPart(l,n);c&&i.push(c)}}else i.push("999");if(t.appendBasename){let o=this.normalizeSortKeyPart(e.file.basename,n);o&&i.push(o)}return i.join(n)}matchesBucket(t,e){let n=Array.isArray(t.conditions)&&t.conditions.length>0,i=Array.isArray(t.conditionGroups)&&t.conditionGroups.length>0;if(!n&&!i)return!0;let r=n?this.matchesConditionGroup(t.conditions,t.match,e):t.match==="all",s=i?t.conditionGroups.map(a=>this.matchesConditionGroup(a.conditions,a.match,e)):[];if(t.match==="all")return r&&(s.length===0||s.every(a=>a));{let a=s.some(o=>o);return n&&r||a}}getSortCriteriaValue(t,e){var a;let i=(a=this.getValuesForConditionSource(t.source,e,t.field).find(o=>String(o||"").trim().length>0))!=null?a:"",r=this.applyMapping(i,t.mappings);if(r)return t.direction==="desc"?this.invertSortValue(r):r;if(t.type==="date"){let o=this.normalizeDateSortValue(t,i);if(o)return t.direction==="desc"?this.invertSortValue(o):o;if(this.isDateCriteria(t)){let c=this.normalizeDateSortValue(t,e.file.basename);if(c)return t.direction==="desc"?this.invertSortValue(c):c}let l=t.missingValuePlacement==="first"?"0000-00-00":"9999-12-31";return t.direction==="desc"?this.invertSortValue(l):l}if(i){if(t.source==="date-modified"||t.source==="frontmatter"&&t.field&&(t.field.toLowerCase().includes("modified")||t.field.toLowerCase().includes("updated"))){let o=i.substring(0,10);return t.direction==="desc"?this.invertSortValue(o):o}return t.direction==="desc"?this.invertSortValue(i):i}let s=t.missingValuePlacement==="first"?"000":"999";return t.direction==="desc"?this.invertSortValue(s):s}isDateCriteria(t){if(t.source!=="frontmatter")return!1;let e=String(t.field||"").trim().toLowerCase();return _.DATE_SORT_FIELDS.has(e)||t.type==="date"}invertSortValue(t){return t.split("").map(e=>{let n=e.charCodeAt(0);return n>=48&&n<=57?String.fromCharCode(105-n):e}).join("")}matchesRule(t,e){if(Array.isArray(t.conditions)&&t.conditions.length>0)return this.matchesConditionGroup(t.conditions,t.match,e);if(!("property"in t)||!t.property)return!1;let n=String(t.property||"").trim();if(!n||!this.matchesPathPrefix(e.file.path,t.pathPrefix))return!1;if(n.toLowerCase()==="folderpath"){let r=this.getValuesForConditionSource("path",e,"");return this.matchesValues(r,t.operator,t.value,!1)}if(t.operator==="exists")return this.hasFrontmatterKey(e.frontmatter,n);let i=this.toComparableValues(this.getFrontmatterValue(e.frontmatter,n));return this.matchesValues(i,t.operator,t.value,!0)}getFolderPath(t){let e=De(t),n=e.lastIndexOf("/");return n<0?"":e.slice(0,n)}getValuesForConditionSource(t,e,n){if(t==="path"){let r=this.getFolderPath(e.file.path);return r?[r]:[]}if(t==="extension"){let r=String(e.file.extension||"").trim();return r?[r]:[]}if(t==="name"){let r=new Set,s=String(e.file.name||"").trim(),a=String(e.file.basename||"").trim();return s&&r.add(s),a&&r.add(a),Array.from(r)}if(t==="tag")return this.collectTags(e);if(t==="body")return e.body?[e.body]:[];if(t==="backlink"){let r=e.backlinks||[],s=(n||"").trim();if(!s){let l=new Set;for(let c of r){l.add(c);let d=this.app.vault.getAbstractFileByPath(c);d instanceof oe.TFile&&l.add(d.basename)}return Array.from(l)}let a=r.filter(l=>{let c=this.app.vault.getAbstractFileByPath(l);if(!(c instanceof oe.TFile))return!1;let d=this.app.metadataCache.getFileCache(c);return d!=null&&d.frontmatterLinks?d.frontmatterLinks.some(p=>{if(!p.key||p.key.toLowerCase()!==s.toLowerCase())return!1;let y=this.app.metadataCache.getFirstLinkpathDest(p.link,l);return y&&y.path===e.file.path}):!1}),o=new Set;for(let l of a){o.add(l);let c=this.app.vault.getAbstractFileByPath(l);c instanceof oe.TFile&&o.add(c.basename)}return Array.from(o)}if(t==="date-created")return[window.moment(e.file.stat.ctime).format()];if(t==="date-modified")return[window.moment(e.file.stat.mtime).format()];let i=String(n||"").trim();return i?i.toLowerCase()==="folderpath"?this.getValuesForConditionSource("path",e,""):this.toComparableValues(this.getFrontmatterValue(e.frontmatter,i)):[]}matchesConditionGroup(t,e,n){return t.length===0?!1:e==="any"?t.some(i=>this.matchesCondition(i,n)):t.every(i=>this.matchesCondition(i,n))}matchesCondition(t,e){let n=this.normalizeSmartOperator(t.operator);if(!n)return!1;let i=t.source;if(i==="frontmatter"){let a=String(t.field||"").trim();if(!a)return!1;if(a.toLowerCase()==="folderpath"){let l=this.getValuesForConditionSource("path",e,"");return this.matchesValues(l,n,t.value,!1)}if((n==="exists"||n==="!exists")&&!String(t.value||"").trim()){let l=this.hasFrontmatterKey(e.frontmatter,a);return n==="exists"?l:!l}if(n==="is-not-empty"){let l=this.getValuesForConditionSource("frontmatter",e,a);return l.length>0&&l.some(c=>String(c||"").trim().length>0)}let o=this.getValuesForConditionSource("frontmatter",e,a);return this.matchesValues(o,n,t.value,!0)}let r=this.getValuesForConditionSource(i,e,t.field),s=i!=="path";return this.matchesValues(r,n,t.value,s)}collectTags(t){let e=new Set;for(let i of t.tags){let r=this.normalizeTag(i);r&&e.add(r)}let n=this.getFrontmatterValue(t.frontmatter,"tags");if(Array.isArray(n))for(let i of n){let r=this.normalizeTag(i);r&&e.add(r)}else if(typeof n=="string")for(let i of n.split(/[\s,]+/)){let r=this.normalizeTag(i);r&&e.add(r)}return Array.from(e)}normalizeTag(t){let e=String(t!=null?t:"").trim();return e?e.replace(/^#+/,"").toLowerCase():""}matchesPathPrefix(t,e){let n=De(e);if(!n)return!0;let i=this.getFolderPath(t);return i?i===n||i.startsWith(`${n}/`):!1}hasFrontmatterKey(t,e){if(!t)return!1;if(Object.prototype.hasOwnProperty.call(t,e))return!0;let n=e.toLowerCase();return Object.keys(t).some(i=>i.toLowerCase()===n)}getFrontmatterValue(t,e){if(!t)return;if(Object.prototype.hasOwnProperty.call(t,e))return t[e];let n=e.toLowerCase();for(let[i,r]of Object.entries(t))if(i.toLowerCase()===n)return r}toComparableValues(t){if(t==null)return[];if(Array.isArray(t))return t.flatMap(e=>this.toComparableValues(e));if(typeof t=="string"){let e=t.trim();return e?[e]:[]}if(typeof t=="number"||typeof t=="boolean")return[String(t)];try{return[JSON.stringify(t)]}catch(e){return[String(t)]}}matchesValues(t,e,n,i){let r=t.map(l=>String(l!=null?l:"").trim()).filter(Boolean),s=i?String(n!=null?n:"").trim():String(n!=null?n:"");if(e==="within-next-days"||e==="!within-next-days")return this.matchesWithinNextDays(r,s,e==="!within-next-days");if(e==="has-open-checkboxes"||e==="!has-open-checkboxes"){let l=r.some(c=>/^[\s]*[-*]\s+\[\s\]/m.test(c));return e==="has-open-checkboxes"?l:!l}if(e==="is-today"||e==="!is-today"){let l=window.moment().startOf("day"),c=l.format("YYYY-MM-DD"),d=r.some(p=>{let y=window.moment(p,[window.moment.ISO_8601,"YYYY-MM-DD","YYYY-MM-DD HH:mm","YYYY-MM-DDTHH:mm:ss","YYYY/MM/DD"],!0);return y.isValid()?y.isSame(l,"day"):p.includes(c)});return e==="is-today"?d:!d}if(e==="is-before-today"||e==="!is-before-today"){let l=window.moment().startOf("day"),c=r.some(d=>{let p=window.moment(d,[window.moment.ISO_8601,"YYYY-MM-DD","YYYY-MM-DD HH:mm","YYYY-MM-DDTHH:mm:ss","YYYY/MM/DD"],!0);return p.isValid()?p.isBefore(l,"day"):!1});return e==="is-before-today"?c:!c}if(e==="is-after-today"||e==="!is-after-today"){let l=window.moment().startOf("day"),c=r.some(d=>{let p=window.moment(d,[window.moment.ISO_8601,"YYYY-MM-DD","YYYY-MM-DD HH:mm","YYYY-MM-DDTHH:mm:ss","YYYY/MM/DD"],!0);return p.isValid()?p.isAfter(l,"day"):!1});return e==="is-after-today"?c:!c}if(e==="is-not-empty")return r.length>0&&r.some(l=>l.length>0);let a=r.map(l=>l.toLowerCase()),o=s.toLowerCase();return e==="exists"?o?a.some(l=>l.includes(o)):a.length>0:e==="!exists"?o?a.every(l=>!l.includes(o)):a.length===0:o?e==="is"?a.some(l=>l===o):e==="!is"?a.every(l=>l!==o):e==="contains"?a.some(l=>l.includes(o)):e==="!contains"?a.every(l=>!l.includes(o)):e==="starts"?a.some(l=>l.startsWith(o)):e==="!starts"?a.every(l=>!l.startsWith(o)):!1:!1}normalizeSmartOperator(t){return t==="is"||t==="contains"||t==="exists"||t==="!is"||t==="!contains"||t==="!exists"||t==="is-not-empty"||t==="starts"||t==="!starts"||t==="within-next-days"||t==="!within-next-days"||t==="has-open-checkboxes"||t==="!has-open-checkboxes"||t==="is-today"||t==="!is-today"||t==="is-before-today"||t==="!is-before-today"||t==="is-after-today"||t==="!is-after-today"?t:null}matchesWithinNextDays(t,e,n){let i=this.parseDayCount(e);if(i==null)return!1;let r=window.moment().startOf("day"),s=window.moment().add(i,"days").endOf("day"),a=t.some(o=>{let l=window.moment(o,[window.moment.ISO_8601,"YYYY-MM-DD","YYYY-MM-DD HH:mm","YYYY/MM/DD"],!1);return l.isValid()?l.isSameOrAfter(r)&&l.isSameOrBefore(s):!1});return n?!a:a}parseDayCount(t){let e=String(t||"").trim();if(!e)return null;let n=e.match(/^-?\d+(?:\.\d+)?/);if(!n)return null;let i=Number.parseFloat(n[0]);return Number.isFinite(i)?Math.max(0,i):null}parseDateLikeTimestamp(t){let e=String(t||"").trim();if(!e)return null;let n=e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1).trim():e;if(!n)return null;let i=Number(n);if(Number.isFinite(i)){if(/^\d{13}$/.test(n))return i;if(/^\d{10}$/.test(n))return i*1e3}let r=n.match(/^(\d{4})[-/](\d{2})[-/](\d{2})$/);if(r){let o=Number.parseInt(r[1],10),l=Number.parseInt(r[2],10),c=Number.parseInt(r[3],10);if(Number.isFinite(o)&&Number.isFinite(l)&&Number.isFinite(c))return new Date(o,l-1,c,0,0,0,0).getTime()}let s=n.match(/^(\d{4})[-/](\d{2})[-/](\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);if(s){let o=Number.parseInt(s[1],10),l=Number.parseInt(s[2],10),c=Number.parseInt(s[3],10),d=Number.parseInt(s[4],10),p=Number.parseInt(s[5],10),y=Number.parseInt(s[6]||"0",10);if(Number.isFinite(o)&&Number.isFinite(l)&&Number.isFinite(c)&&Number.isFinite(d)&&Number.isFinite(p)&&Number.isFinite(y))return new Date(o,l-1,c,d,p,y,0).getTime()}let a=[n];/^\d{4}-\d{2}-\d{2}\s+\d/.test(n)&&a.push(n.replace(/\s+/,"T"));for(let o of a){let l=Date.parse(o);if(!Number.isNaN(l))return l}return null}matchesSortSegment(t,e){return!Array.isArray(t.conditions)||t.conditions.length===0?!0:this.matchesConditionGroup(t.conditions,t.match,e)}getSortSegmentValue(t,e){var o;let i=(o=this.getValuesForConditionSource(t.source,e,t.field).find(l=>String(l||"").trim().length>0))!=null?o:"",r=this.applyMapping(i,t.mappings);if(r)return r;let s=this.normalizeDateSortValue(t,i);if(s)return s;if(this.isDateFrontmatterSegment(t)){let l=this.normalizeDateSortValue(t,e.file.basename);if(l)return l}return i||String(t.fallback||"").trim()}applyMapping(t,e){let n=String(t||"").trim().toLowerCase();if(!n)return"";for(let i of e){let r=String(i.input||"").trim().toLowerCase();if(r&&r===n)return String(i.output||"").trim()}return""}normalizeDateSortValue(t,e){let n=String(e||"").trim();if(!n)return"";let i="type"in t,r=t.source,s=String(t.field||"").trim().toLowerCase();if(r!=="frontmatter"&&r!=="date-modified"&&r!=="date-created"||!(i?t.type==="date"||_.DATE_SORT_FIELDS.has(s)||this.looksLikeDateValue(n):_.DATE_SORT_FIELDS.has(s)||this.looksLikeDateValue(n)))return"";let o=this.parseDateLikeTimestamp(n);if(o==null)return"";let l=this.formatSortTimestamp(o);return r==="date-modified"||s.includes("modified")||s.includes("updated")?l.substring(0,10):l}isDateFrontmatterSegment(t){if(t.source!=="frontmatter")return!1;let e=String(t.field||"").trim().toLowerCase();return _.DATE_SORT_FIELDS.has(e)}looksLikeDateValue(t){let e=String(t||"").trim();if(!e)return!1;let n=e.replace(/^['"]|['"]$/g,"");return/^\d{4}-\d{2}-\d{2}/.test(n)||/^\d{4}\/\d{2}\/\d{2}/.test(n)||/t\d{2}:\d{2}/i.test(n)}formatSortTimestamp(t){let e=new Date(t),n=e.getFullYear(),i=this.pad2(e.getMonth()+1),r=this.pad2(e.getDate()),s=this.pad2(e.getHours()),a=this.pad2(e.getMinutes()),o=this.pad2(e.getSeconds());return`${n}-${i}-${r}-${s}-${a}-${o}`}pad2(t){return String(t).padStart(2,"0")}normalizeSortKeyPart(t,e){let n=String(t||"").trim();if(!n)return"";let i=je(e),r=new RegExp(i,"g");return n.replace(/[\r\n\t]+/g," ").replace(/\s+/g,"-").replace(r,"-").replace(/^[-_]+|[-_]+$/g,"")}};_.MS_PER_DAY=24*60*60*1e3,_.DATE_SORT_FIELDS=new Set(["scheduled","due","date","start","startdate","end","enddate","deadline","created","datecreated","modified","datemodified","updated","dateupdated"]);var ae=_;function De(u){return String(u||"").replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function je(u){return u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Ke={batchSize:5,queueYieldMs:10,selfWriteIgnoreMs:2e3,parseFailureCooldownMs:8e3,enableFrontmatterAutoRepair:!0},le=class{constructor(t,e,n){this.queue=[];this.selfWrites=new Map;this.parseFailures=new Map;this.debouncer=new G;this.isProcessing=!1;this.app=t,this.logger=e,this.options={...Ke,...n},this.setupLinterCoordination()}setupLinterCoordination(){var t,e;try{let n=(e=(t=this.app.plugins)==null?void 0:t.getPlugin)==null?void 0:e.call(t,"obsidian-linter");if(!(n!=null&&n.enabled))return;this.logger.info("Linter plugin detected, enhanced coordination enabled")}catch(n){this.logger.debug("Linter coordination setup failed (not critical)",n)}}queueFrontmatterUpdate(t,e,n){return new Promise(i=>{this.queue.push({file:t,reason:e,mutate:n,resolve:i}),this.kick()})}scheduleDebounced(t,e,n){this.debouncer.schedule(t,e,async()=>{try{await n()}catch(i){this.logger.error("Debounced metadata callback failed",i,{path:t})}})}shouldIgnoreFileEvent(t){let e=this.selfWrites.get(t);return e?Date.now()>e.until?(this.selfWrites.delete(t),this.hasActiveParseFailure(t)):!0:this.hasActiveParseFailure(t)}dispose(){this.debouncer.cancelAll(),this.queue.length=0,this.selfWrites.clear(),this.parseFailures.clear()}kick(){this.isProcessing||(this.isProcessing=!0,this.processQueue())}async processQueue(){try{for(;this.queue.length>0;){let t=0;for(;t<this.options.batchSize&&this.queue.length>0;){let e=this.queue.shift();e&&(await this.executeMutation(e),t+=1)}this.queue.length>0&&await this.yieldToUi()}}finally{this.isProcessing=!1,this.queue.length>0&&this.kick()}}async executeMutation(t){let e=this.createOperationId(t.file.path);if(this.hasActiveParseFailure(t.file.path)){t.resolve(!1);return}try{let n=await this.runFrontmatterMutation(t);this.handleSuccessfulMutation(t.file.path,e,n),t.resolve(n)}catch(n){let i=await this.tryRecoverFromYamlError(t,n,e);if(i.handled){t.resolve(i.changed);return}this.logger.error("processFrontMatter failed",n,{file:t.file.path,reason:t.reason,operationId:e}),t.resolve(!1)}}createOperationId(t){return`${Date.now()}-${Math.random().toString(36).slice(2,8)}-${t}`}async runFrontmatterMutation(t){let e=!1;return await this.app.fileManager.processFrontMatter(t.file,n=>{let i=n!=null?n:{};e=t.mutate(i)}),e}handleSuccessfulMutation(t,e,n){this.clearParseFailure(t),n&&this.selfWrites.set(t,{operationId:e,until:Date.now()+this.options.selfWriteIgnoreMs})}async tryRecoverFromYamlError(t,e,n){return this.isYamlParseError(e)?this.hasActiveParseFailure(t.file.path)?(this.logger.warn("\u26A0\uFE0F File has active parse failure cooldown - skipping to prevent corruption",{file:t.file.path,reason:t.reason,suggestion:"Check file frontmatter for YAML syntax errors"}),{handled:!0,changed:!1}):(this.logger.warn("YAML parse error - frontmatter mutation skipped for cooldown window",{file:t.file.path,reason:t.reason,suggestion:"Fix YAML syntax manually; plugin will not rewrite malformed frontmatter",error:this.summarizeError(e)}),this.markParseFailure(t.file.path,t.reason,e,n),{handled:!0,changed:!1}):{handled:!1,changed:!1}}markParseFailure(t,e,n,i){var a;let r=Date.now(),s=this.parseFailures.get(t);if(s&&r<=s.until){this.parseFailures.set(t,{until:r+this.options.parseFailureCooldownMs,failures:s.failures+1});return}this.parseFailures.set(t,{until:r+this.options.parseFailureCooldownMs,failures:((a=s==null?void 0:s.failures)!=null?a:0)+1}),this.logger.warn("Skipping metadata mutation for malformed frontmatter",{file:t,reason:e,operationId:i,retryInMs:this.options.parseFailureCooldownMs,error:this.summarizeError(n)})}clearParseFailure(t){this.parseFailures.delete(t)}hasActiveParseFailure(t){let e=this.parseFailures.get(t);return e?Date.now()>e.until?(this.parseFailures.delete(t),!1):!0:!1}isYamlParseError(t){let e=this.summarizeError(t).toLowerCase();return e.includes("yamlparseerror")||e.includes("map keys must be unique")||e.includes("nested mappings are not allowed")||e.includes("yaml")&&e.includes("parse")}summarizeError(t){if(t instanceof Error)return`${t.name}: ${t.message}`;if(typeof t=="string")return t;try{return JSON.stringify(t)}catch(e){return String(t)}}async yieldToUi(){if(typeof window!="undefined"&&typeof window.requestAnimationFrame=="function"){await new Promise(t=>{window.requestAnimationFrame(()=>t())});return}await new Promise(t=>{setTimeout(()=>t(),this.options.queueYieldMs)})}validateFrontmatterValue(t,e){return t.toLowerCase()==="tags"&&Array.isArray(e)?e.every(n=>typeof n=="string"):e!==null&&typeof e!="string"?(this.logger.warn("\u26A0\uFE0F Rejecting non-string frontmatter value",{key:t,valueType:typeof e,suggestion:"Only string values are safe for frontmatter"}),!1):(typeof e=="string"&&/:\s/.test(e)&&!/^["']/.test(e)&&this.logger.debug("Frontmatter value contains colon - Linter may quote this",{key:t,value:e}),!0)}};var ue=class ue{constructor(t,e){this.host=t,this.logger=e}async loadSettings(){let t=null;try{t=await this.host.loadData()}catch(e){this.logger.error("Failed to load plugin settings via loadData",e)}return this.sanitizeSettings(t)}async saveSettings(t){let e=this.sanitizeSettings(t);try{await this.host.saveData(e)}catch(n){throw this.logger.error("Failed to save plugin settings via saveData",n),n}return e}sanitizeSettings(t){let e=$(t),n=$(e.smartSort),i=Array.isArray(e.sortRules),r={...n,segments:Array.isArray(n.segments)?n.segments:i?e.sortRules:n.segments};return{enabled:A(e.enabled,k.enabled),autoApplyOnFileOpen:A(e.autoApplyOnFileOpen,k.autoApplyOnFileOpen),autoApplyOnMetadataChange:A(e.autoApplyOnMetadataChange,k.autoApplyOnMetadataChange),applyOnStartup:A(e.applyOnStartup,k.applyOnStartup),startupDelayMs:Ae(e.startupDelayMs,k.startupDelayMs,0,3e4),metadataDebounceMs:Ae(e.metadataDebounceMs,k.metadataDebounceMs,0,5e3),syncTitleFromFilename:A(e.syncTitleFromFilename,k.syncTitleFromFilename),syncFilenameFromTitle:A(e.syncFilenameFromTitle,k.syncFilenameFromTitle),frontmatterIconField:this.normalizeSafeFrontmatterField(e.frontmatterIconField,k.frontmatterIconField),frontmatterColorField:this.normalizeSafeFrontmatterField(e.frontmatterColorField,k.frontmatterColorField),upstreamLinkKeys:Je(e.upstreamLinkKeys,k.upstreamLinkKeys),frontmatterWriteExclusions:qe(e.frontmatterWriteExclusions,k.frontmatterWriteExclusions),noteCheckboxIconColor:Le(e.noteCheckboxIconColor),clearIconWhenNoMatch:A(e.clearIconWhenNoMatch,k.clearIconWhenNoMatch),clearColorWhenNoMatch:A(e.clearColorWhenNoMatch,k.clearColorWhenNoMatch),debugLogging:A(e.debugLogging,k.debugLogging),rules:this.sanitizeRules(e.rules),smartSort:this.sanitizeSmartSort(r),hideRules:this.sanitizeHideRules(e.hideRules)}}sanitizeHideRules(t){if(!Array.isArray(t))return[];let e=[];for(let n of t){let i=$(n),r=this.normalizeMatchMode(i.match),s=this.sanitizeConditions(i.conditions);e.push({id:E(i.id,`hide-rule-${Date.now()}`),name:E(i.name,""),enabled:A(i.enabled,!0),match:r,conditions:s,mode:i.mode==="remove"?"remove":"add",tagName:E(i.tagName,"hide")})}return e}sanitizeRules(t){if(!Array.isArray(t))return[];let e=[];for(let n of t){let i=$(n),r=this.normalizeMatchMode(i.match),s=this.sanitizeConditions(i.conditions);e.push({id:E(i.id,ve()),name:Le(i.name),enabled:A(i.enabled,!0),property:E(i.property,""),operator:this.normalizeRuleOperator(i.operator),value:E(i.value,""),pathPrefix:Xe(E(i.pathPrefix,"")),icon:E(i.icon,""),color:E(i.color,""),match:r,conditions:s})}return e}sanitizeConditions(t){if(!Array.isArray(t))return[];let e=[];for(let n of t){let i=$(n),r=this.normalizeConditionSource(i.source),s=this.normalizeSmartOperator(i.operator);if(!r||!s)continue;let a={source:r,field:E(i.field,""),operator:s,value:E(i.value,"")};e.push(a)}return e}sanitizeSmartSort(t){var i;let e=$(t),n=this.sanitizeSortBuckets((i=e.buckets)!=null?i:e.segments);return{enabled:A(e.enabled,k.smartSort.enabled),field:this.normalizeSafeFrontmatterField(e.field,k.smartSort.field),separator:Qe(e.separator,k.smartSort.separator),appendBasename:A(e.appendBasename,k.smartSort.appendBasename),clearWhenNoMatch:A(e.clearWhenNoMatch,k.smartSort.clearWhenNoMatch),buckets:n}}normalizeSafeFrontmatterField(t,e){let n=Ge(t,e);return ue.PROTECTED_FRONTMATTER_KEYS.has(n.toLowerCase())?(this.logger.warn("Blocked protected frontmatter field in settings; falling back to default",{requested:n,fallback:e}),e):n}sanitizeSortSegments(t){var n,i;if(!Array.isArray(t))return[];let e=[];for(let r of t){let s=$(r),a=(n=this.normalizeConditionSource(s.source))!=null?n:te().source,o=this.normalizeMatchMode(s.match),l=this.sanitizeConditions(s.conditions);e.push({id:E(s.id,ye()),enabled:A(s.enabled,!0),source:a,field:E(s.field,a==="frontmatter"?"status":""),fallback:E(s.fallback,""),mappings:this.sanitizeValueMappings((i=s.mappings)!=null?i:s.map),match:o,conditions:l})}return e}sanitizeSortBuckets(t){var n,i;if(!Array.isArray(t))return[];let e=[];for(let r of t){let s=$(r);if(s.fallback!==void 0&&s.sortCriteria===void 0){let o=this.normalizeMatchMode(s.match),l=this.sanitizeConditions(s.conditions),c=(n=this.normalizeConditionSource(s.source))!=null?n:"frontmatter",d=E(s.field,""),p=[{source:c,field:d,type:this.inferFieldType(d),direction:"asc",mappings:this.sanitizeValueMappings((i=s.mappings)!=null?i:s.map),missingValuePlacement:(s.fallback,"last")}];e.push({id:E(s.id,ee()),enabled:A(s.enabled,!0),name:`Migrated: ${d||"Unnamed"}`,match:o,conditions:l,sortCriteria:p})}else{let o=this.normalizeMatchMode(s.match),l=this.sanitizeConditions(s.conditions),c=this.sanitizeSortCriteria(s.sortCriteria);e.push({id:E(s.id,ee()),enabled:A(s.enabled,!0),name:E(s.name,"Unnamed Bucket"),match:o,conditions:l,sortCriteria:c})}}return e}sanitizeSortCriteria(t){var n;if(!Array.isArray(t))return[];let e=[];for(let i of t){let r=$(i),s=(n=this.normalizeConditionSource(r.source))!=null?n:"frontmatter",a=E(r.field,""),o=this.normalizeFieldType(r.type);e.push({source:s,field:a,type:o,direction:r.direction==="desc"?"desc":"asc",mappings:this.sanitizeValueMappings(r.mappings),missingValuePlacement:r.missingValuePlacement==="first"?"first":"last"})}return e}normalizeFieldType(t){return t==="date"||t==="status"||t==="priority"||t==="text"||t==="number"?t:"text"}inferFieldType(t){let e=t.toLowerCase();return e.includes("date")||e==="scheduled"||e==="due"||e==="deadline"?"date":e==="status"?"status":e==="priority"?"priority":"text"}sanitizeValueMappings(t){if(Array.isArray(t)){let n=[];for(let i of t){let r=$(i),s=E(r.input,""),a=E(r.output,"");!s||!a||n.push({input:s,output:a})}return n}if(typeof t=="string"){let n=[],i=t.split(",");for(let r of i){let s=r.trim();if(!s)continue;let a=s.includes("=")?"=":s.includes(":")?":":"";if(!a)continue;let[o,l]=s.split(a),c=String(o||"").trim(),d=String(l||"").trim();!c||!d||n.push({input:c,output:d})}return n}let e=$(t);return Object.entries(e).map(([n,i])=>({input:String(n||"").trim(),output:String(i!=null?i:"").trim()})).filter(n=>n.input.length>0&&n.output.length>0)}normalizeRuleOperator(t){return t==="is"||t==="!is"||t==="contains"||t==="!contains"||t==="exists"||t==="!exists"?t:"is"}normalizeSmartOperator(t){return t==="is"||t==="contains"||t==="exists"||t==="!is"||t==="!contains"||t==="!exists"||t==="is-not-empty"||t==="starts"||t==="!starts"||t==="within-next-days"||t==="!within-next-days"||t==="has-open-checkboxes"||t==="!has-open-checkboxes"||t==="is-today"||t==="!is-today"||t==="is-before-today"||t==="!is-before-today"||t==="is-after-today"||t==="!is-after-today"?t:null}normalizeConditionSource(t){return t==="frontmatter"||t==="path"||t==="extension"||t==="name"||t==="tag"||t==="body"||t==="backlink"||t==="date-created"||t==="date-modified"?t:null}normalizeMatchMode(t){return t==="any"?"any":"all"}};ue.PROTECTED_FRONTMATTER_KEYS=new Set(["externaleventid","tpscalendaruid"]);var ce=ue;function $(u){return!u||typeof u!="object"||Array.isArray(u)?{}:u}function A(u,t){return typeof u=="boolean"?u:t}function Ae(u,t,e,n){return typeof u!="number"||Number.isNaN(u)?t:Math.min(Math.max(u,e),n)}function E(u,t){return String(u!=null?u:"").trim()||t}function Ge(u,t){return E(u,t).replace(/\s+/g,"")}function Le(u){return String(u!=null?u:"").trim()}function qe(u,t){return typeof u!="string"?t:u.split(/\r?\n/).map(e=>e.trimEnd()).join(`
`).trim()}function Qe(u,t){let e=String(u!=null?u:"").trim();return e?e.slice(0,3):t}function Xe(u){return String(u||"").replace(/\\/g,"/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function Je(u,t){return Array.isArray(u)?u.map(e=>String(e||"").trim()).filter(Boolean):typeof u=="string"?u.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean):t}var Pe={chunkSize:100,chunkDelayMs:10,parallelism:3},de=class{constructor(t,e){var n;this.logger=t,this.options={...Pe,...e,parallelism:et((n=e==null?void 0:e.parallelism)!=null?n:Pe.parallelism)}}async walk(t,e,n){let i=t.length,r=0,s=0;for(;r<i;){let a=Math.min(r+this.options.chunkSize,i);for(let o=r;o<a;o+=this.options.parallelism){let l=Math.min(o+this.options.parallelism,a),c=Ze(o,l),d=await Promise.all(c.map(async p=>{let y=t[p];try{let f=await e(y,p);return{idx:p,file:y,didChange:f}}catch(f){return this.logger.error("Vault walker file callback failed",f,{file:y.path,index:p}),{idx:p,file:y,didChange:!1}}}));d.sort((p,y)=>p.idx-y.idx);for(let p of d)p.didChange&&(s+=1),r+=1,n==null||n({processed:r,total:i,changed:s,currentPath:p.file.path})}r<i&&await this.yieldToUi()}return{processed:r,total:i,changed:s}}async yieldToUi(){if(typeof window!="undefined"&&typeof window.requestAnimationFrame=="function"){await new Promise(t=>{window.requestAnimationFrame(()=>t())});return}await new Promise(t=>{setTimeout(()=>t(),this.options.chunkDelayMs)})}};function Ze(u,t){let e=[];for(let n=u;n<t;n+=1)e.push(n);return e}function et(u){return!Number.isFinite(u)||u<1?1:Math.min(Math.floor(u),16)}var Q=class Q extends F.Plugin{constructor(...e){super(...e);this.settings=k;this.statusBarEl=null;this.runtimeStyleEl=null;this.warnedAboutSharedFields=!1;this.deviceRoleManager=null;this.logger=new se({prefix:"TPS Notebook Navigator Companion",debugEnabled:()=>this.settings.debugLogging}),this.ruleEngine=new ae(this.app),this.metadataManager=new le(this.app,this.logger,{batchSize:5,queueYieldMs:10,selfWriteIgnoreMs:600}),this.settingsManager=new ce(this,this.logger),this.vaultWalker=new de(this.logger,{chunkSize:100,chunkDelayMs:10})}async onload(){var e,n;this.settings=await this.settingsManager.loadSettings(),this.applyNavigatorSystemIconColorOverride();try{let i=(n=(e=this.app.plugins)==null?void 0:e.getPlugin)==null?void 0:n.call(e,"tps-controller");i!=null&&i.api&&(this.deviceRoleManager={isController:()=>i.api.getRole()==="controller"},this.logger.debug("Connected to Controller for device role detection"))}catch(i){this.logger.debug("Could not connect to Controller (not critical)",i)}this.addSettingTab(new re(this.app,this)),this.addCommand({id:"apply-rules-active-file",name:"Apply icon/color/sort rules to active file",callback:async()=>{await this.applyRulesToActiveFile(!0)}}),this.addCommand({id:"apply-rules-all-files",name:"Apply icon/color/sort rules to all markdown files",callback:async()=>{await this.applyRulesToAllFiles(!0)}}),this.registerEvent(this.app.workspace.on("file-open",i=>{!i||!this.settings.enabled||!this.settings.autoApplyOnFileOpen||this.isMarkdownFile(i)&&(this.metadataManager.shouldIgnoreFileEvent(i.path)||this.shouldIgnoreFrontmatterWrite(i)||(this.applyRulesToFile(i,{reason:"file-open"}),this.updateActiveViewStyle(i)))})),this.registerEvent(this.app.metadataCache.on("changed",i=>{!this.settings.enabled||!this.settings.autoApplyOnMetadataChange||this.isMarkdownFile(i)&&(this.metadataManager.shouldIgnoreFileEvent(i.path)||this.shouldIgnoreFrontmatterWrite(i)||this.metadataManager.scheduleDebounced(i.path,this.settings.metadataDebounceMs,async()=>{var o,l,c;let r=this.app.vault.getAbstractFileByPath(i.path);if(!(r instanceof F.TFile)||!this.isMarkdownFile(r)||this.metadataManager.shouldIgnoreFileEvent(r.path)||this.shouldIgnoreFrontmatterWrite(r)||((c=(l=(o=this.deviceRoleManager)==null?void 0:o.isController)==null?void 0:l.call(o))!=null?c:!1)||!this.shouldProcessRealtimeFile(r))return;await this.applyRulesToFile(r,{reason:"metadata-change"}),this.settings.syncFilenameFromTitle&&await this.handleTitleSync(r),r===this.app.workspace.getActiveFile()&&this.updateActiveViewStyle(r)}))})),this.registerEvent(this.app.vault.on("rename",(i,r)=>{!this.settings.enabled||!this.isMarkdownFile(i)||this.shouldIgnoreFrontmatterWrite(i)||this.settings.syncTitleFromFilename&&this.handleFilenameUpdate(i)})),this.registerEvent(this.app.workspace.on("tps-gcm-files-updated",async i=>{if(!(!this.settings.enabled||!Array.isArray(i)||i.length===0)){this.logger.info(`Processing ${i.length} files from GCM bulk edit`,{reason:"gcm-bulk-edit"});for(let r of i){let s=this.app.vault.getAbstractFileByPath(r);!(s instanceof F.TFile)||!this.isMarkdownFile(s)||this.shouldIgnoreFrontmatterWrite(s)||this.shouldProcessRealtimeFile(s)&&await this.applyRulesToFile(s,{reason:"gcm-bulk-edit",force:!1})}this.logger.debug(`Completed GCM bulk edit processing: ${i.length} files`)}})),this.api={applyRulesToAllFiles:i=>this.applyRulesToAllFiles(!i),applyRulesToFile:i=>this.applyRulesToFile(i,{reason:"controller"})}}onunload(){delete this.api,this.metadataManager.dispose(),this.statusBarEl&&(this.statusBarEl.detach(),this.statusBarEl=null),this.runtimeStyleEl&&(this.runtimeStyleEl.remove(),this.runtimeStyleEl=null)}async loadSettings(){this.settings=await this.settingsManager.loadSettings()}async saveSettings(){this.settings=await this.settingsManager.saveSettings(this.settings),this.applyNavigatorSystemIconColorOverride()}createDefaultRule(){return Ee()}createDefaultSortSegment(){return te()}createDefaultSortBucket(){return Te()}createDefaultHideRule(){return{id:`hide-rule-${Date.now()}`,name:"New Hide Rule",enabled:!0,match:"all",conditions:[],mode:"add",tagName:"hide"}}getRuleMatchForActiveFile(e){let n=this.app.workspace.getActiveFile();if(!n||!this.isMarkdownFile(n))return null;let i=this.buildRuleContext(n,void 0);return this.ruleEngine.matchesRule(e,i)}getSmartSortPreviewForActiveFile(){if(!this.settings.smartSort.enabled)return null;let e=this.app.workspace.getActiveFile();if(!e||!this.isMarkdownFile(e))return null;let n=this.buildRuleContext(e,void 0);return this.ruleEngine.composeSortKey(this.settings.smartSort,n)||null}async applyRulesToActiveFile(e){let n=this.app.workspace.getActiveFile();if(!n)return e&&new F.Notice("No active markdown file to update."),!1;if(!this.isMarkdownFile(n))return e&&new F.Notice("Active file is not a markdown note."),!1;if(this.shouldIgnoreFrontmatterWrite(n))return e&&new F.Notice("Active file is excluded from companion frontmatter writes."),!1;let i=await this.applyRulesToFile(n,{reason:"manual-active",force:!0});return e&&new F.Notice(i?"Applied icon/color/sort rules to active file.":"Active file already matches current rule outputs."),i}async applyRulesToAllFiles(e,n="manual-all"){let i=this.app.vault.getMarkdownFiles();if(i.length===0)return e&&new F.Notice("No markdown files found."),0;let r=i.filter(o=>!this.shouldIgnoreFrontmatterWrite(o));if(r.length===0)return e&&new F.Notice("No eligible markdown files found after exclusions."),0;e&&new F.Notice(`Applying rules to ${r.length}/${i.length} markdown files...`);let s=this.ensureStatusBar(),a=await this.vaultWalker.walk(r,async o=>this.applyRulesToFile(o,{reason:n,force:!0}),o=>this.renderProgress(s,o));return s.setText("TPS NN: Idle"),e&&new F.Notice(`Applied rules to ${a.changed} file${a.changed===1?"":"s"}.`),a.changed}async applyRulesToFile(e,n){if(!this.settings.enabled||!this.isMarkdownFile(e)||this.shouldIgnoreFrontmatterWrite(e)||!n.force&&this.metadataManager.shouldIgnoreFileEvent(e.path))return!1;let i=this.settings.frontmatterIconField,r=this.settings.frontmatterColorField;i.toLowerCase()===r.toLowerCase()&&!this.warnedAboutSharedFields&&(this.warnedAboutSharedFields=!0,this.logger.warn("Icon and color fields are identical; icon output will take precedence",{iconField:i,colorField:r}));let s=this.getRuleContextRequirements(),a=await this.buildRuleContextWithBody(e,void 0,s);return this.metadataManager.queueFrontmatterUpdate(e,n.reason,o=>{let l={...a,frontmatter:o,tags:this.collectTagsFromCache(e,o)},c=this.ruleEngine.resolveVisualOutputs(this.settings.rules,l),d=c.icon.matched?c.icon.value:this.settings.clearIconWhenNoMatch?null:void 0,y=c.color.matched?c.color.value:this.settings.clearColorWhenNoMatch?null:void 0,f=this.computeDesiredSortValue(l),R=this.computeHideChanges(l),S=!1;if(i.toLowerCase()===r.toLowerCase()){let v=d!==void 0?d:y;S=this.applyFrontmatterMutation(o,i,v)||S}else S=this.applyFrontmatterMutation(o,i,d)||S,S=this.applyFrontmatterMutation(o,r,y)||S;return f!==void 0&&(S=this.applyFrontmatterMutation(o,this.settings.smartSort.field,f)||S),this.applyTagMutations(o,R)&&(S=!0),S&&this.logger.debug("Applied rules to file",{file:e.path,reason:n.reason,iconRule:c.icon.ruleId,colorRule:c.color.ruleId,sortField:this.settings.smartSort.enabled?this.settings.smartSort.field:"",hideAdded:R.add,hideRemoved:R.remove}),S})}computeDesiredSortValue(e){if(!this.settings.smartSort.enabled)return;let n=this.ruleEngine.composeSortKey(this.settings.smartSort,e);return n||(this.settings.smartSort.clearWhenNoMatch?null:void 0)}applyFrontmatterMutation(e,n,i){var o;if(i===void 0)return!1;if(this.isProtectedFrontmatterKey(n))return this.logger.warn("Skipping mutation on protected calendar identity key",{key:n}),!1;if(i!==null&&!this.metadataManager.validateFrontmatterValue(n,i))return this.logger.warn("Skipping frontmatter mutation due to validation failure",{key:n,value:i}),!1;let r=n.toLowerCase(),s=n;for(let l of Object.keys(e))if(l.toLowerCase()===r){s=l;break}return i===null?Object.prototype.hasOwnProperty.call(e,s)?(delete e[s],!0):!1:String((o=e[s])!=null?o:"")===i?!1:(e[s]=i,!0)}collectTagsFromCache(e,n){var s,a;let i=new Set,r=(a=(s=this.app.metadataCache.getFileCache(e))==null?void 0:s.tags)!=null?a:[];for(let o of r){let l=this.normalizeTag(o.tag);l&&i.add(l)}if(n){let o=this.getFrontmatterValue(n,"tags");if(Array.isArray(o))for(let l of o){let c=this.normalizeTag(l);c&&i.add(c)}else if(typeof o=="string")for(let l of o.split(/[\s,]+/)){let c=this.normalizeTag(l);c&&i.add(c)}}return Array.from(i)}normalizeTag(e){return String(e!=null?e:"").trim().replace(/^#+/,"").toLowerCase()}toFrontmatterRecord(e){return!e||typeof e!="object"||Array.isArray(e)?null:e}getFrontmatterValue(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n];let i=n.toLowerCase();for(let[r,s]of Object.entries(e))if(r.toLowerCase()===i)return s}buildRuleContext(e,n,i=!0){let r=this.app.metadataCache.getFileCache(e),s=n!=null?n:this.toFrontmatterRecord(r==null?void 0:r.frontmatter),a;if(i){a=[];let o=this.app.metadataCache.resolvedLinks;if(o)for(let[l,c]of Object.entries(o))Object.prototype.hasOwnProperty.call(c,e.path)&&a.push(l)}return{file:{path:e.path,name:e.name,basename:e.basename,extension:e.extension},frontmatter:s,tags:this.collectTagsFromCache(e,s),backlinks:a}}async buildRuleContextWithBody(e,n,i){var o,l;let r=(o=i==null?void 0:i.includeBody)!=null?o:!0,s=(l=i==null?void 0:i.includeBacklinks)!=null?l:!0,a=this.buildRuleContext(e,n,s);if(r&&e.extension.toLowerCase()==="md")try{let c=await this.app.vault.cachedRead(e),d=c.match(/^---\n[\s\S]*?\n---\n/);d?a.body=c.slice(d[0].length):a.body=c}catch(c){this.logger.error("Failed to read file body for rule evaluation",c,{file:e.path})}return a}getRuleContextRequirements(){return{includeBody:this.settingsUseConditionSource("body"),includeBacklinks:this.settingsUseConditionSource("backlink")}}settingsUseConditionSource(e){for(let n of this.settings.rules)if(n.enabled&&this.conditionsUseSource(n.conditions,e))return!0;for(let n of this.settings.hideRules)if(n.enabled&&this.conditionsUseSource(n.conditions,e))return!0;if(this.settings.smartSort.enabled){for(let n of this.settings.smartSort.buckets)if(n.enabled){if(this.conditionsUseSource(n.conditions,e))return!0;if(Array.isArray(n.conditionGroups)){for(let i of n.conditionGroups)if(this.conditionsUseSource(i.conditions,e))return!0}if(n.sortCriteria.some(i=>i.source===e))return!0}}return!1}conditionsUseSource(e,n){return!Array.isArray(e)||e.length===0?!1:e.some(i=>i.source===n)}isMarkdownFile(e){return e instanceof F.TFile&&e.extension==="md"}hasDirectResolvedLink(e,n){let i=this.app.metadataCache.resolvedLinks;if(!i)return!1;let r=i[e];return!r||typeof r!="object"?!1:Object.prototype.hasOwnProperty.call(r,n)}shouldProcessRealtimeFile(e){let n=this.app.workspace.getActiveFile();return!n||!this.isMarkdownFile(n)?!1:e.path===n.path?!0:this.hasDirectResolvedLink(n.path,e.path)||this.hasDirectResolvedLink(e.path,n.path)}ensureStatusBar(){return this.statusBarEl||(this.statusBarEl=this.addStatusBarItem()),this.statusBarEl}renderProgress(e,n){e.setText(`TPS NN: ${n.processed}/${n.total} (${n.changed} changed)`)}log(e,n){this.logger.debug(e,n)}shouldIgnoreFrontmatterWrite(e){if(!(e instanceof F.TFile))return!1;if(Date.now()-e.stat.ctime<2e3)return!0;let i=this.getFrontmatterWriteExclusionPatterns();if(!i.length)return!1;let r=this.normalizeComparablePath(e.path),s=String(e.basename||"").trim().toLowerCase();for(let a of i)if(this.matchesFrontmatterWriteExclusionPattern(r,s,a))return this.logger.debug("Skipping companion frontmatter write due to exclusion",{file:e.path,pattern:a}),!0;return!1}getFrontmatterWriteExclusionPatterns(){let e=String(this.settings.frontmatterWriteExclusions||"");return e.trim()?e.split(/\r?\n|,/).map(n=>n.trim()).filter(Boolean):[]}matchesFrontmatterWriteExclusionPattern(e,n,i){let r=String(i||"").trim();if(!r)return!1;let s=r.toLowerCase();if(s.startsWith("re:")){let c=r.slice(3).trim();if(!c)return!1;try{let d=new RegExp(c,"i");return d.test(e)||d.test(n)}catch(d){return!1}}if(s.startsWith("name:")){let c=String(r.slice(5)||"").trim().toLowerCase();return c?this.matchesWildcard(c,n):!1}let a=s.startsWith("path:")?r.slice(5).trim():r,o=/[\/\\]$/.test(a),l=this.normalizeComparablePath(a);return l?l.includes("*")?this.matchesWildcard(l,e)||this.matchesWildcard(l,n):o?e===l||e.startsWith(`${l}/`):e===l||e.startsWith(`${l}/`)?!0:n===l:!1}matchesWildcard(e,n){let i=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`^${i.replace(/\*/g,".*")}$`,"i").test(n)}normalizeComparablePath(e){return!e||typeof e!="string"?"":e.trim().replace(/^\/+/,"").replace(/\/+$/,"").toLowerCase()}applyNavigatorSystemIconColorOverride(){let e=this.normalizeCssColorValue(this.settings.noteCheckboxIconColor);if(!e){this.runtimeStyleEl&&(this.runtimeStyleEl.remove(),this.runtimeStyleEl=null);return}this.runtimeStyleEl||(this.runtimeStyleEl=document.createElement("style"),this.runtimeStyleEl.id=Q.RUNTIME_STYLE_ID,document.head.appendChild(this.runtimeStyleEl)),this.runtimeStyleEl.textContent=`
      body {
        --nn-theme-file-task-icon-color: ${e};
      }
      /* Apply the dynamic color to various icon containers in the inline title area */
      .inline-title-icon,
      .view-header-icon,
      .obsidian-icon-folder-icon {
        color: var(--nn-active-file-color, inherit) !important;
      }
    `}updateActiveViewStyle(e){let n=this.app.workspace.getLeaf(!1);if(!n||!(n.view instanceof F.FileView)||n.view.file!==e)return;let i=this.app.metadataCache.getFileCache(e),r=i==null?void 0:i.frontmatter,s=this.getFrontmatterValue(r||{},"iconColor");s||(s=this.getFrontmatterValue(r||{},this.settings.frontmatterColorField));let a=n.view.containerEl;if(s&&typeof s=="string"){let o=this.normalizeCssColorValue(s);a.style.setProperty("--nn-active-file-color",o)}else a.style.removeProperty("--nn-active-file-color")}normalizeCssColorValue(e){return String(e!=null?e:"").replace(/[;\n\r{}<>]/g,"").trim()}isProtectedFrontmatterKey(e){let n=String(e||"").trim().toLowerCase();return Q.PROTECTED_FRONTMATTER_KEYS.has(n)}computeHideChanges(e){let n=new Set,i=new Set;for(let r of this.settings.hideRules)if(r.enabled&&this.ruleEngine.matchesRule(r,e)){let s=this.normalizeTag(r.tagName);if(!s)continue;r.mode==="add"?(n.add(s),i.delete(s)):(i.add(s),n.delete(s))}return{add:Array.from(n),remove:Array.from(i)}}applyTagMutations(e,n){let i=this.getFrontmatterValue(e,"tags"),r=[];Array.isArray(i)?r=i.map(o=>this.normalizeTag(o)).filter(Boolean):typeof i=="string"&&(r=i.split(/[\s,]+/).map(o=>this.normalizeTag(o)).filter(Boolean));let s=new Set(r),a=!1;for(let o of n.remove)s.delete(o)&&(a=!0);for(let o of n.add)s.has(o)||(s.add(o),a=!0);return a?(e.tags=Array.from(s),!0):!1}isObsidianSyncActive(){var e;try{let n=(e=this.app.internalPlugins)==null?void 0:e.getPluginById("sync");if(!n||!n.enabled)return!1;let i=n.instance;if(!i)return!1;if(typeof i.getStatus=="function"){let r=i.getStatus();return r==="syncing"||r==="scanning"||r==="connecting"}return!1}catch(n){return!1}}async handleFilenameUpdate(e){if(!this.settings.syncTitleFromFilename||this.shouldIgnoreFrontmatterWrite(e))return;let{cleanTitle:n}=this.parseFilenameComponents(e.basename);await this.metadataManager.queueFrontmatterUpdate(e,"filename-sync",i=>String(i.title||"").trim()===n?!1:(i.title=n,!0))}async handleTitleSync(e){var c,d;if(!this.settings.syncFilenameFromTitle||this.shouldIgnoreFrontmatterWrite(e))return;let n=this.app.metadataCache.getFileCache(e);if(!n||!n.frontmatter)return;let i=String(n.frontmatter.title||"").trim();if(!i)return;let{cleanTitle:r,dateSuffix:s}=this.parseFilenameComponents(e.basename);if(i===r)return;let a=i;s&&(a=`${a} ${s}`);let o=((d=(c=this.app.vault.adapter.fs)==null?void 0:c.sanitize)==null?void 0:d.call(c,a))||a.replace(/[\\/:]/g,""),l=`${e.parent.path}/${o}.${e.extension}`;if(l!==e.path){if(await this.app.vault.adapter.exists(l)){this.logger.warn("Skipping title sync rename: Target file already exists",{from:e.path,to:l});return}try{await this.app.fileManager.renameFile(e,l),this.logger.info("Synced filename to match title",{old:e.path,new:l})}catch(p){this.logger.error("Failed to rename file for title sync",p,{from:e.path,to:l})}}}parseFilenameComponents(e){let n=/\s*(\d{4}[-/]\d{2}[-/]\d{2}|\d{8})(?:\s+\d+)?$/,i=e.match(n);if(i){let r=i[1];return{cleanTitle:e.substring(0,i.index).trim(),dateSuffix:r}}return{cleanTitle:e,dateSuffix:null}}};Q.RUNTIME_STYLE_ID="tps-nn-companion-runtime-style",Q.PROTECTED_FRONTMATTER_KEYS=new Set(["externaleventid","tpscalendaruid"]);var pe=Q;
